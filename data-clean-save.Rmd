---
title: "data-clean-save"
author: "Eren Kafadar"
date: "2025-11-18"
output: html_document
editor_options: 
  chunk_output_type: console
---
#SETUP
##controls
```{r}
#set command
save_tables <- TRUE
plot <- TRUE
save_figs <- TRUE
vars_find <- FALSE
```
##Define Paths and Load Packages
```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

#define paths
code_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/"
data_path <- "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/OUT/eren/"
data_gaonly_path <- "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/OUT/eren/slip_ga_median_centiles_20251203.csv"
data_liza_mpr_path <- "/mnt/isilon/bgdlab_processing/Liza/SLIP_nnUNet_braincharts/code/gamlss/OUT/slip_mpr_aparc_global_centiles_qnorm_20251209.csv"
data_liza_median_path <- "/mnt/isilon/bgdlab_processing/Liza/SLIP_nnUNet_braincharts/code/gamlss/OUT/slip_median_aparc_global_centiles_qnorm_20251209.csv"
qc_metrics_path <- "/mnt/isilon/bgdlab_processing/releases_clinical/2025_03_release/derivatives/recon-all-clinical/fs7.4.1-clinical-reconall-qc.csv"
vars_save_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/data_processed_csv/"
## output/save paths
csv_save_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/mpr-all/results_csv/"
plot_save_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/mpr-all/plots/"

betas_folder <- paste0(csv_save_path, "full_betas/")
if (!dir.exists(betas_folder)) dir.create(betas_folder)
dkt_folder <- paste0(csv_save_path, "dkt_betas/")
if (!dir.exists(dkt_folder)) dir.create(dkt_folder)

source(paste0(code_path,"slip_data_utils.R"))

#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(tidyr)
library(gamlssTools) #Margaret's package
#For figures/plotting
library(ggplot2)
library(gridExtra)
library(ggseg)
#library(ggpubr)
library(ggcorrplot)
library(cowplot)
library(egg)
library(interactions)
library(growthstandards)
library(gtsummary)
library(svglite)
```
##Load Data
```{r, echo = FALSE}
participants <- read.table(paste0(data_path, "participants.tsv"),
                 sep = "\t",
                 header = TRUE,
                 stringsAsFactors = FALSE,
                 quote = "",
                 comment.char = "")

qc_metrics <- read.csv(qc_metrics_path) %>% filter(euler_mean > -60 &
                                                     qc_general_white_matter > 0.65 &
                                                     qc_general_grey_matter > 0.65 &
                                                     qc_general_csf > 0.65 &
                                                     qc_cerebellum > 0.65 &
                                                     qc_brainstem > 0.65 &
                                                     qc_thalamus > 0.65 &
                                                     qc_putamen_pallidum > 0.65 &
                                                     qc_hippocampus_amygdala > 0.65)

median_cent <- read.csv(paste0(data_path, "slip_median_centiles_20250912.csv"))
median2_cent <- read.csv(paste0(data_path, "slip_median2_centiles_20250912.csv"))
mpr_cent <- read.csv(paste0(data_path, "slip_mpr_centiles_20250912.csv"))
mpr2_cent <- read.csv(paste0(data_path, "slip_mpr2_centiles_20250912.csv"))
medianga_cent <- read.csv(data_gaonly_path)
liza_median_cent <- read.csv(data_liza_median_path)
liza_mpr_cent <- read.csv(data_liza_mpr_path)
```
#QC inter-variable correlations
```{r}
#correlation matrix and visualization
cor_matrix <- cor(qc_metrics[,names(qc_metrics)[!grepl("_id$", names(qc_metrics))]], use = "pairwise.complete.obs")
p_mat <- cor_pmat(qc_metrics[,names(qc_metrics)[!grepl("_id$", names(qc_metrics))]])

ggcorrplot(
  cor_matrix,
  p.mat = p_mat,
  type = "lower",
  insig = "blank",
  lab = TRUE
)
```
#Define IDP variable names
```{r}
if (vars_find == TRUE){
  vol_vars <- c(names(median_cent)[grepl("aparc_GrayVol", names(median_cent))],
                names(median_cent)[grepl("aseg", names(median_cent))])
  vol_vars <- vol_vars[!vol_vars %in% c("aseg_Left_Cerebral_Cortex", "aseg_Left_Cerebral_White_Matter",
                                        "aseg_Right_Cerebral_Cortex", "aseg_Right_Cerebral_White_Matter",
                                        "aseg_CSF" )]
  sa_vars <- c(names(median_cent)[grepl("aparc_SurfArea", names(median_cent))])
  th_vars <- c(names(median_cent)[grepl("aparc_ThickAvg", names(median_cent))])
  global_vars <- c(names(median_cent)[grepl("global", names(median_cent))])
  all_vars <- c(vol_vars, sa_vars, th_vars, global_vars)
  
  if (save_tables == TRUE){
    write.csv(all_vars, paste0(csv_save_path, "all_vars", Sys.Date(), ".csv"))
    write.csv(global_vars, paste0(csv_save_path, "global_vars", Sys.Date(), ".csv"))
    write.csv(vol_vars, paste0(csv_save_path, "vol_vars", Sys.Date(), ".csv"))
    write.csv(sa_vars, paste0(csv_save_path, "sa_vars", Sys.Date(), ".csv"))
    write.csv(th_vars, paste0(csv_save_path, "th_vars", Sys.Date(), ".csv"))
  }
}
```
#DATA PREP
##QC metrics prep
```{r}
##group by session-id and take median of euler_mean
qc_metrics <- qc_metrics %>%
  group_by(session_id) %>%
  summarise(median_euler_mean = median(euler_mean),
            .groups = "drop") %>%
  left_join(qc_metrics, by = "session_id") %>%
  rename(participant_id = subject_id)
```
##Participant DF prep
Check if any participant has separate values recorded for these variables of interest across session entries
sub-HM2BYW325 has NA and 36 recorded for GA in two separate sessions, otherwise no other examples in SLIP 25-03
```{r}
 participants %>%
     group_by(participant_id) %>%
     summarise(n_var = n_distinct(birth_length_cm)) %>%
     filter(n_var > 1)
 participants %>%
     group_by(participant_id) %>%
     summarise(n_var = n_distinct(birth_weight_kg)) %>%
     filter(n_var > 1)
  participants %>%
     group_by(participant_id) %>%
     summarise(n_var = n_distinct(gestational_age)) %>%
     filter(n_var > 1)
#
```
###Replace missing bw/ga values for participants across sessions -- if more than one value recorded, then take the mean
```{r}
participants <- participants %>%
    group_by(participant_id) %>%
    mutate(
      gestational_age = if (all(is.na(gestational_age))) NA_real_
      else mean(gestational_age, na.rm = TRUE)
    ) %>%
    ungroup()

participants <- participants %>%
    group_by(participant_id) %>%
    mutate(
      birth_weight_kg = if (all(is.na(birth_weight_kg))) NA_real_
      else mean(birth_weight_kg, na.rm = TRUE)
    ) %>%
    ungroup()

participants <- participants %>%
    group_by(participant_id) %>%
    mutate(
      birth_length_cm = if (all(is.na(birth_length_cm))) NA_real_
      else mean(birth_length_cm, na.rm = TRUE)
    ) %>%
    ungroup()
```
##run data cleanup
```{r}
liza_median <- slip_centdf_clean(liza_median_cent, participants, qc_metrics, type = "median")
liza_median_distinct <- liza_median$distinct
liza_median_all <- liza_median$all
rm(liza_median)
liza_mpr <- slip_centdf_clean(liza_mpr_cent, participants, qc_metrics, type = "mpr")
liza_mpr_distinct <- liza_mpr$distinct
liza_mpr_all <- liza_mpr$all
rm(liza_mpr)

median <- slip_centdf_clean(median_cent, participants, qc_metrics, type = "median")
median_distinct <- median$distinct
median_all <- median$all
rm(median)
mpr <- slip_centdf_clean(mpr_cent, participants, qc_metrics, type = "mpr")
mpr_distinct <- mpr$distinct
mpr_all <- mpr$all
rm(mpr)

median2 <- slip_centdf_clean(median2_cent, participants, qc_metrics, type = "median")
median2_distinct <- median2$distinct
median2_all <- median2$all
rm(median2)
mpr2 <- slip_centdf_clean(mpr2_cent, participants, qc_metrics, type = "mpr2")
mpr2_distinct <- mpr2$distinct
mpr2_all <- mpr2$all
rm(mpr2)

medianga_cent$gestational_age <- NULL
medianga <- slip_centdf_clean(medianga_cent, participants, qc_metrics, type = "median")
medianga_distinct <- medianga$distinct
medianga_all <- medianga$all
rm(medianga)
```
#GA and BW quality control
```{r}
##set bw > 1000kg to NA
bw_absurd <- sum(median_distinct$birth_weight_kg  > 1000, na.rm = TRUE)
print(paste0("Number of data point set to NA for recorded BW > 1000kg: ", bw_absurd))
median_distinct$birth_weight_kg[median_distinct$birth_weight_kg>1000] <- NA
##remove >4SDs
bw_mean <- mean(median_distinct$birth_weight_kg, na.rm = TRUE)
bw_sd <- sd(median_distinct$birth_weight_kg, na.rm = TRUE)

#apply QC function
liza_median_distinct <- slip_bwga_qc(cent_df = liza_median_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
liza_median_all <- slip_bwga_qc(cent_df = liza_median_all, bw_mean = bw_mean, bw_sd = bw_sd, bw_sd_limit = 4)
liza_mpr_distinct <- slip_bwga_qc(cent_df = liza_mpr_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
liza_mpr_all <- slip_bwga_qc(cent_df = liza_mpr_all, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)

#apply QC function
median_distinct <- slip_bwga_qc(cent_df = median_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
median_all <- slip_bwga_qc(cent_df = median_all, bw_mean = bw_mean, bw_sd = bw_sd, bw_sd_limit = 4)
mpr_distinct <- slip_bwga_qc(cent_df = mpr_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
mpr_all <- slip_bwga_qc(cent_df = mpr_all, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)

#apply QC function
median2_distinct <- slip_bwga_qc(cent_df = median2_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
median2_all <- slip_bwga_qc(cent_df = median2_all, bw_mean = bw_mean, bw_sd = bw_sd, bw_sd_limit = 4)
mpr2_distinct <- slip_bwga_qc(cent_df = mpr2_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
mpr2_all <- slip_bwga_qc(cent_df = mpr2_all, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)

#apply QC function
medianga_distinct <- slip_bwga_qc(cent_df = medianga_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
medianga_all <- slip_bwga_qc(cent_df = medianga_all, bw_mean = bw_mean, bw_sd = bw_sd, bw_sd_limit = 4)
```
##numbers after exclusions
```{r}
#Liza Samples
##median
sum(!is.na(liza_median_distinct$birth_weight_kg))
sum(!is.na(liza_median_distinct$gestational_age))
##mpr
sum(!is.na(liza_mpr_distinct$birth_weight_kg))
sum(!is.na(liza_mpr_distinct$gestational_age))
```

#SAVE Data Frames
```{r}
if (save_tables == TRUE){
#one row per participant
median_filename <- paste0(vars_save_path, "median_distinct_clean_", Sys.Date(), ".csv")
write.csv(median_distinct, median_filename)

medianga_filename <- paste0(vars_save_path, "median_ga_distinct_clean_", Sys.Date(), ".csv")
write.csv(medianga_distinct, medianga_filename)

median2_filename <- paste0(vars_save_path, "median2_distinct_clean_", Sys.Date(), ".csv")
write.csv(median2_distinct, median2_filename)
mpr_filename <- paste0(vars_save_path, "mpr_distinct_clean_", Sys.Date(), ".csv")
write.csv(mpr_distinct, mpr_filename)
mpr2_filename <- paste0(vars_save_path, "mpr2_distinct_clean_", Sys.Date(), ".csv")
write.csv(mpr2_distinct, mpr2_filename)
liza_median_distinct_filename <- paste0(vars_save_path, "liza_median_distinct_clean_", Sys.Date(), ".csv")
write.csv(liza_median_distinct, liza_median_distinct_filename)
liza_mpr_distinct_filename <- paste0(vars_save_path, "liza_mpr_distinct_clean_", Sys.Date(), ".csv")
write.csv(liza_mpr_distinct, liza_mpr_distinct_filename)

#all data, including repeated measures
median_all_filename <- paste0(vars_save_path, "median_all_clean_", Sys.Date(), ".csv")
write.csv(median_all, median_all_filename)
medianga_all_filename <- paste0(vars_save_path, "median_ga_all_clean_", Sys.Date(), ".csv")
write.csv(medianga_all, medianga_all_filename)
median2_all_filename <- paste0(vars_save_path, "median2_all_clean_", Sys.Date(), ".csv")
write.csv(median2_all, median2_all_filename)

mpr_all_filename <- paste0(vars_save_path, "mpr_all_clean_", Sys.Date(), ".csv")
write.csv(mpr_all, mpr_all_filename)
mpr2_all_filename <- paste0(vars_save_path, "mpr2_all_clean_", Sys.Date(), ".csv")
write.csv(mpr2_all, mpr2_all_filename)

liza_median_all_clean_filename <- paste0(vars_save_path, "liza_median_all_clean_", Sys.Date(), ".csv")
write.csv(liza_median_all, liza_median_all_clean_filename)
liza_mpr_all_clean_filename <- paste0(vars_save_path, "liza_mpr_all_clean_", Sys.Date(), ".csv")
write.csv(liza_mpr_all, liza_mpr_all_clean_filename)

}
```

