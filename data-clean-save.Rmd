---
title: "data-clean-save"
author: "Eren Kafadar"
date: "2025-11-18"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  output_folder : "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/"
  centiles_path: "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/centile_csv/slip_median_centiles.csv"
  participants_path: "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/raw_csv/participants_allvars_useable.csv"
  slip_release_folder: "/mnt/isilon/bgdlab_processing/releases_clinical/2025_11_release/"
  type: "median"  
---

# Define params if they do not exist
```{r}
if (!exists("params")) {
  params <- list(
  output_folder = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/",
  centiles_path = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/centile_csv/slip_median_centiles.csv",
  participants_path = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/raw_csv/participants_allvars_useable.csv",
  slip_release_folder = "/mnt/isilon/bgdlab_processing/releases_clinical/2025_11_release/",
  type = "median"
  )
}
``` 

# Controls
```{r setup, echo = TRUE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
#set command
save_tables <- TRUE
plot <- TRUE
save_figs <- TRUE

set.seed(42)

output_folder <- params$output_folder
centiles_path <- params$centiles_path
participants_path <- params$participants_path
slip_release_folder <- params$slip_release_folder
type <- params$type
```

# Load packages
```{r}
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(tidyr)
library(glue)
#For figures/plotting
library(ggplot2)
library(gridExtra)
library(ggseg)
#library(ggpubr)
library(ggcorrplot)
library(cowplot)
library(egg)
library(interactions)
library(growthstandards)
library(gtsummary)
library(svglite)
```

# Define Paths
```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

#define paths
code_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/"
qc_metrics_path <- glue("{slip_release_folder}derivatives/recon-all-clinical/fs7.4.1-clinical-reconall-qc.csv")
vars_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/vars/"

## output/save paths
if (!dir.exists(output_folder)) dir.create(output_folder)
csv_save_path <- glue("{output_folder}data_clean/")
if (!dir.exists(csv_save_path)) dir.create(csv_save_path)
plot_save_path <- paste0(output_folder, "plots/data-cleanup-plots/")
if (!dir.exists(plot_save_path)) dir.create(plot_save_path)

#load custom data transform and bw/ga qc functions
source(paste0(code_path,"slip_data_utils.R"))
```

# Load Data
```{r, echo = FALSE}
participants <- read.csv(participants_path)
qc_metrics <- read.csv(qc_metrics_path) %>% filter(euler_mean > -60 &
                                                     qc_general_white_matter > 0.65 &
                                                     qc_general_grey_matter > 0.65 &
                                                     qc_general_csf > 0.65 &
                                                     qc_cerebellum > 0.65 &
                                                     qc_brainstem > 0.65 &
                                                     qc_thalamus > 0.65 &
                                                     qc_putamen_pallidum > 0.65 &
                                                     qc_hippocampus_amygdala > 0.65)

centiles <- read.csv(centiles_path) %>% select(-X)
```

#Load Phenotype Var Names
```{r}
full_vars <- read.csv(paste0(vars_path,"all_vars.csv")) %>% pull(x)
global_vars <- read.csv(paste0(vars_path,"global_vars.csv")) %>% pull(x)
vol_vars <- read.csv(paste0(vars_path,"vol_vars.csv")) %>% pull(x)
sa_vars <- read.csv(paste0(vars_path,"sa_vars.csv")) %>% pull(x)
th_vars <- read.csv(paste0(vars_path,"th_vars.csv")) %>% pull(x)
```
# QC inter-variable correlations
```{r}
#correlation matrix and visualization
cor_matrix <- cor(qc_metrics[,names(qc_metrics)[!grepl("_id$", names(qc_metrics))]], use = "pairwise.complete.obs")
p_mat <- cor_pmat(qc_metrics[,names(qc_metrics)[!grepl("_id$", names(qc_metrics))]])

ggcorrplot(
  cor_matrix,
  p.mat = p_mat,
  type = "lower",
  insig = "blank",
  lab = TRUE
)
```

# DATA PREP

## QC metrics prep
```{r}
##group by session-id and take median of euler_mean
qc_metrics <- qc_metrics %>%
  group_by(session_id) %>%
  summarise(median_euler_mean = median(euler_mean),
            .groups = "drop") %>%
  left_join(qc_metrics, by = "session_id") %>%
  rename(participant_id = subject_id)
```

## Participant DF prep
Check if any participant has separate values recorded for these variables of interest across session entries
sub-HM2BYW325 has NA and 36 recorded for GA in two separate sessions, otherwise no other examples in SLIP 25-03
```{r}
 participants %>%
     group_by(participant_id) %>%
     summarise(n_var = n_distinct(birth_length_cm)) %>%
     filter(n_var > 1)
 participants %>%
     group_by(participant_id) %>%
     summarise(n_var = n_distinct(birth_weight_kg)) %>%
     filter(n_var > 1)
  participants %>%
     group_by(participant_id) %>%
     summarise(n_var = n_distinct(gestational_age)) %>%
     filter(n_var > 1)
#
```

### Replace missing bw/ga values for participants across sessions -- if more than one value recorded, then take the mean
```{r}
participants <- participants %>%
    group_by(participant_id) %>%
    mutate(
      gestational_age = if (all(is.na(gestational_age))) NA_real_
      else mean(gestational_age, na.rm = TRUE)
    ) %>%
    ungroup()

participants <- participants %>%
    group_by(participant_id) %>%
    mutate(
      birth_weight_kg = if (all(is.na(birth_weight_kg))) NA_real_
      else mean(birth_weight_kg, na.rm = TRUE)
    ) %>%
    ungroup()

participants <- participants %>%
    group_by(participant_id) %>%
    mutate(
      birth_length_cm = if (all(is.na(birth_length_cm))) NA_real_
      else mean(birth_length_cm, na.rm = TRUE)
    ) %>%
    ungroup()
```

## check for extra variables in the centiles df
```{r}
vars_to_select <- c(full_vars, "participant_id", "session_id", "site", "sex", "age_days", "avg_grade", "dx")
vars_extra <- names(centiles)[!(names(centiles) %in% vars_to_select)]
print(glue("Additional variables in the centiles csv provided: {vars_extra}"))
```

## run data cleanup
```{r}
print(glue("ALL Centiles DF dimensions before 'cleanup' script: {c(dim(centiles))}"))

centiles <- centiles %>% select(any_of(vars_to_select))
clean_centiles <- slip_centdf_clean(centiles, participants, qc_metrics, type = type)
centiles_distinct <- clean_centiles$distinct
centiles_all <- clean_centiles$all
print(glue("DISTINCT Centiles DF dimensions after 'cleanup' script: {c(dim(centiles_distinct))}"))
print(glue("ALL Centiles DF dimensions before 'cleanup' script: {c(dim(centiles_all))}"))

rm(centiles)
```

# BW/GA QC

##BW/GA numbers before exclusions
```{r}
print("BEFORE EXCLUSIONS")
print(glue("Within DISTINCT participants; participants with BW available {sum(!is.na(centiles_distinct$birth_weight_kg))}"))
print(glue("Within DISTINCT participants; participants with GA available {sum(!is.na(centiles_distinct$gestational_age))}"))
```

## exclusions
```{r}
##set bw > 1000kg to NA
bw_absurd <- sum(centiles_distinct$birth_weight_kg  > 1000, na.rm = TRUE)
print(paste0("WITHIN DISTINCT DF: Number of data points set to NA for recorded BW > 1000kg: ", bw_absurd))
centiles_distinct$birth_weight_kg[centiles_distinct$birth_weight_kg>1000] <- NA
##remove >4SDs
bw_mean <- mean(centiles_distinct$birth_weight_kg, na.rm = TRUE)
bw_sd <- sd(centiles_distinct$birth_weight_kg, na.rm = TRUE)
#apply QC function
centiles_distinct <- slip_bwga_qc(cent_df = centiles_distinct, bw_mean = bw_mean, bw_sd = bw_sd,  bw_sd_limit = 4)
centiles_all <- slip_bwga_qc(cent_df = centiles_all, bw_mean = bw_mean, bw_sd = bw_sd, bw_sd_limit = 4)
```

## BW/GA numbers after exclusions
```{r}
print("AFTER EXCLUSIONS")
print(glue("Within DISTINCT participants; participants with BW available {sum(!is.na(centiles_distinct$birth_weight_kg))}"))
print(glue("Within DISTINCT participants; participants with GA available {sum(!is.na(centiles_distinct$gestational_age))}"))
```

# SAVE Data Frames
```{r}
if (save_tables == TRUE){
#one row per participant
distinct_filename <- paste0(csv_save_path, "centiles_distinct_", Sys.Date(), ".csv")
write.csv(centiles_distinct, distinct_filename)
#all rows, included repeats of participants at different timepoints/ages
all_filename <- paste0(csv_save_path, "centiles_all_", Sys.Date(), ".csv")
write.csv(centiles_all, all_filename)
}
```

