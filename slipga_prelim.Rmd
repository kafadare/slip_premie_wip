---
title: "SLIP GA Prelim"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
#Define Paths and Load Packages
```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

#define paths
code_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/"
data_path <- "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/OUT/eren/"
save_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/results_csv/"

betas_folder <- paste0(save_path, "full_betas/")
if (!dir.exists(paste0(save_path, "full_betas/"))) dir.create(betas_folder)
dkt_folder <- paste0(save_path, "dkt_betas/")
if (!dir.exists(dkt_folder)) dir.create(dkt_folder)

#set command
save_tables <- TRUE
plot <- TRUE
save_figs <- TRUE

source(paste0(code_path,"sliding_window.R"))
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(tidyr)
library(gamlssTools) #Margaret's package
#For figures/plotting
library(ggplot2)
library(gridExtra)
library(ggsegDKT)
library(ggseg)
#library(ggpubr)
library(ggcorrplot)
library(cowplot)
library(egg)
library(interactions)
library(growthstandards)
library(gtsummary)
library(svglite)
```
#Plot specifications
```{r}
limits = c(-0.25, 0.25)
low_color = "#4878CF"
mid_color = "white"
high_color = "#D65F5F"
```

#name mapping and phenotypes for MC
```{r}
#df to map variable names onto names displayed on figures
name_mapping <- data.frame(
  abbreviation = c(
     "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_cdk_total",   
     "totalWM_cb", "totalWM_crb", "totalGM_crb",
     
    "smri_vol_scs_cbwmatterlh", "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_csf",
    "smri_vol_scs_lesionlh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_cbwmatterrh", "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh", "smri_vol_scs_lesionrh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_wmhint",
    "smri_vol_scs_wmhintlh", "smri_vol_scs_wmhintrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat", 
    
    "smri_vol_scs_wholeb", "smri_vol_scs_latventricles",
    "smri_vol_scs_allventricles", "smri_vol_scs_intracranialv", "smri_vol_scs_suprateialv",
    "smri_vol_scs_subcorticalgv",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  ),
  region_name = c(
    "Left-Cerebral_Cortex", "Right-Cerebral-Cortex", "Total-Cerebral-Cortex",
    "Total_Cerebral-WM", "Total_Cerebellum-WM", "Total-Cerebellum-Cortex",
    
    "Left-Cerebral-White-Matter", "Left-Lateral-Ventricle", "Left-Inf-Lat-Vent",
    "Left-Cerebellum-White-Matter", "Left-Cerebellum-Cortex", "Left-Thalamus-Proper",
    "Left-Caudate", "Left-Putamen", "Left-Pallidum",
    "x3rd-ventricle", "x4th-ventricle", "Brain-Stem",
    "Left-Hippocampus", "Left-Amygdala", "Cerebrospinal-Fluid",
    "Left-Lesion", "Left-Accumbens-Area", "Left-VentralDC",
    
   "Right-Cerebral-White-Matter", "Right-Lateral-Ventricle", "Right-Inf-Lat-Vent",
    "Right-Cerebellum-White-Matter", "Right-Cerebellum-Cortex", "Right-Thalamus-Proper",
    "Right-Caudate", "Right-Putamen", "Right-Pallidum",
    "Right-Hippocampus", "Right-Amygdala",
    "Right-Lesion", "Right-Accumbens-Area", "Right-VentralDC",
    
    "WM-Hypointensities","Left-WM-Hypointensities", "Right-WM-Hypointensities",
   
   "CC_Posterior","CC_Mid_Posterior", "CC_Central", "CC_Mid_Anterior",
    "CC_Anterior", 
   
   "WholeBrain", "LatVentricles","AllVentricles", "IntracranialVolume", 
   "SupratentorialVolume", "SubcorticalGrayVolume",
   
     "lh_bankssts", "lh_caudalanteriorcingulate", "lh_caudalmiddlefrontal",
    "lh_cuneus", "lh_entorhinal", "lh_fusiform",
    "lh_inferiorparietal", "lh_inferiortemporal", "lh_isthmuscingulate",
    "lh_lateraloccipital", "lh_lateralorbitofrontal", "lh_lingual",
    "lh_medialorbitofrontal", "lh_middletemporal", "lh_parahippocampal",
    "lh_paracentral", "lh_parsopercularis", "lh_parsorbitalis",
    "lh_parstriangularis", "lh_pericalcarine", "lh_postcentral",
    "lh_posteriorcingulate", "lh_precentral", "lh_precuneus", "lh_rostralanteriorcingulate",
    "lh_rostralmiddlefrontal", "lh_superiorfrontal", "lh_superiorparietal",
    "lh_superiortemporal", "lh_supramarginal", "lh_frontalpole",
    "lh_temporalpole", "lh_transversetemporal", "lh_insula",
   
     "rh_bankssts", "rh_caudalanteriorcingulate", "rh_caudalmiddlefrontal",
    "rh_cuneus", "rh_entorhinal", "rh_fusiform",
    "rh_inferiorparietal", "rh_inferiortemporal", "rh_isthmuscingulate",
    "rh_lateraloccipital", "rh_lateralorbitofrontal", "rh_lingual",
    "rh_medialorbitofrontal", "rh_middletemporal", "rh_parahippocampal",
    "rh_paracentral", "rh_parsopercularis", "rh_parsorbitalis",
    "rh_parstriangularis", "rh_pericalcarine", "rh_postcentral",
    "rh_posteriorcingulate", "rh_precentral", "rh_precuneus", "rh_rostralanteriorcingulate",
    "rh_rostralmiddlefrontal", "rh_superiorfrontal", "rh_superiorparietal",
    "rh_superiortemporal", "rh_supramarginal", "rh_frontalpole",
    "rh_temporalpole", "rh_transversetemporal", "rh_insula"
    )
)

phenotypes_for_MC <- c(
    "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  )

global_phenotypes <- c("smri_vol_cdk_total", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv")

phenotypes_to_fit <- (c(phenotypes_for_MC, global_phenotypes, "smri_vol_scs_wholeb", "smri_vol_scs_wholeb", "totalWM_crb", "totalGM_crb", "smri_vol_scs_csf", "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_scs_cbwmatterlh", "smri_vol_scs_cbwmatterrh"))

#save phenotypes not plotted with ggseg surface plots
plot_data_dkt <- merge(name_mapping, ggseg::dk, by.x = "region_name", by.y = "label")
plot_data_aseg <- merge(name_mapping, ggseg::aseg, by.x = "region_name", by.y = "label")
```
#Read in data files
```{r, echo = FALSE}
participants <- read.table(paste0(data_path, "participants.tsv"),
                 sep = "\t",
                 header = TRUE,
                 stringsAsFactors = FALSE,
                 quote = "",
                 comment.char = "")

median_cent <- read.csv(paste0(data_path, "slip_median_centiles_20250912.csv"))
median2_cent <- read.csv(paste0(data_path, "slip_median2_centiles_20250912.csv"))
mpr_cent <- read.csv(paste0(data_path, "slip_mpr_centiles_20250912.csv"))
mpr2_cent <- read.csv(paste0(data_path, "slip_mpr2_centiles_20250912.csv"))
```
#Add age in years
```{r}
median_cent$age_years <- median_cent$age_days/365
median2_cent$age_years <- median2_cent$age_days/365
mpr_cent$age_years <- mpr_cent$age_days/365
mpr2_cent$age_years <- mpr2_cent$age_days/365
```

#Merge centile tables with participant tables
```{r}
#mpr2
##overall including repeat participant IDs
mpr2_cent <- merge(mpr2_cent, participants %>% select(c("participant_id", 
                                                   "session_id", 
                                                   #"sex", 
                                                   "age_at_scan", 
                                                   "gestational_age",
                                                   "adjusted_age_in_days",
                                                   "birth_weight_kg",
                                                   "birth_length_cm",
                                                   "avg_grade",
                                                   "height_at_enc",
                                                   "weight_at_enc",
                                                   "year_of_scan")), by = c("participant_id", "session_id"), 
                                                                            all.x = TRUE, all.y = FALSE)

#mpr
##overall including repeat participant IDs
mpr_cent <- merge(mpr_cent, participants %>% select(c("participant_id", 
                                                   "session_id", 
                                                   #"sex", 
                                                   "age_at_scan", 
                                                   "gestational_age",
                                                   "adjusted_age_in_days",
                                                   "birth_weight_kg",
                                                   "birth_length_cm",
                                                   "avg_grade",
                                                   "height_at_enc",
                                                   "weight_at_enc",
                                                   "year_of_scan")), by = c("participant_id", "session_id"), 
                                                                            all.x = TRUE, all.y = FALSE)

#median2
##overall including repeat participant IDs
median2_cent <- merge(median2_cent, participants %>% select(c("participant_id", 
                                                   "session_id", 
                                                   #"sex", 
                                                   "age_at_scan", 
                                                   "gestational_age",
                                                   "adjusted_age_in_days",
                                                   "birth_weight_kg",
                                                   "birth_length_cm",
                                                   "avg_grade",
                                                   "height_at_enc",
                                                   "weight_at_enc",
                                                   "year_of_scan")), by = c("participant_id", "session_id"), 
                                                                            all.x = TRUE, all.y = FALSE)


#median
##overall including repeat participant IDs
median_cent <- merge(median_cent, participants %>% select(c("participant_id", 
                                                   "session_id", 
                                                   #"sex", 
                                                   "age_at_scan", 
                                                   "gestational_age",
                                                   "adjusted_age_in_days",
                                                   "birth_weight_kg",
                                                   "birth_length_cm",
                                                   "avg_grade",
                                                   "height_at_enc",
                                                   "weight_at_enc",
                                                   "year_of_scan")), by = c("participant_id", "session_id"), 
                                                                            all.x = TRUE, all.y = FALSE)
```
#Define IDP variable names
```{r}
vol_vars <- c(names(median_cent)[grepl("aparc_GrayVol", names(median_cent))], names(median_cent)[grepl("aseg", names(median_cent))])
vol_vars <- vol_vars[!vol_vars %in% c("aseg_Left_Cerebral_Cortex", "aseg_Left_Cerebral_White_Matter", "aseg_Right_Cerebral_Cortex", "aseg_Right_Cerebral_White_Matter", "aseg_CSF" )]
sa_vars <- c(names(median_cent)[grepl("aparc_SurfArea", names(median_cent))])
th_vars <- c(names(median_cent)[grepl("aparc_ThickAvg", names(median_cent))])
global_vars <- c(names(median_cent)[grepl("global", names(median_cent))])
all_vars <- c(vol_vars, sa_vars, th_vars, global_vars)
```
#Subset df to distinct participant ids
```{r}
mpr2_cent_distinct <- mpr2_cent %>% distinct(participant_id, .keep_all = TRUE)

mpr_cent_distinct <- mpr_cent %>% distinct(participant_id, .keep_all = TRUE)

median2_cent_distinct <- median2_cent %>% distinct(participant_id, .keep_all = TRUE)

median_cent_distinct <- median_cent %>% distinct(participant_id, .keep_all = TRUE)
```

#GA and BW quality control -- only for mediancent distinct right now
##exclusions
```{r}
##set bw > 1000kg to NA
median_cent_distinct$birth_weight_kg[median_cent_distinct$birth_weight_kg>1000] <- NA
##remove >5SDs
bw_mean <- mean(median_cent_distinct$birth_weight_kg, na.rm = TRUE)
bw_sd <- sd(median_cent_distinct$birth_weight_kg, na.rm = TRUE)
#sum(median_cent_distinct$birth_weight_kg > bw_mean + 4*bw_sd, na.rm = TRUE)
#sum(median_cent_distinct$birth_weight_kg < bw_mean - 4*bw_sd, na.rm = TRUE)
median_cent_distinct$birth_weight_kg[median_cent_distinct$birth_weight_kg > bw_mean + 4*bw_sd] <- NA
median_cent_distinct$birth_weight_kg[median_cent_distinct$birth_weight_kg < bw_mean - 4*bw_sd] <- NA
##set GA < 21 and > 42 to NA
median_cent_distinct$gestational_age[median_cent_distinct$gestational_ag<21] <- NA
median_cent_distinct$gestational_age[median_cent_distinct$gestational_ag>42] <- NA

##exclude age > 21
median_cent_distinct <- median_cent_distinct %>% filter(age_years <= 21)
```
##numbers after exclusions
```{r}
sum(!is.na(median_cent_distinct$birth_weight_kg))
sum(!is.na(median_cent_distinct$gestational_age))
```
#Prepare Df for Analysis (from MedianCent distinct)
##Assign preterm categories
```{r}
#Assign preterm categories
median_cent_distinct$preterm <- as.factor(cut(median_cent_distinct$gestational_age, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE))
table(median_cent_distinct$preterm)
```
##Calculate birth weight percentile
```{r}
median_cent_distinct <- median_cent_distinct %>%
  mutate(gestAge_days = gestational_age*7+3) %>%
  mutate(sex_recode= recode(sex, "M" = "Male", "F" = "Female"))
median_cent_distinct$bweight_percentile <- igb_wtkg2centile(median_cent_distinct$gestAge_days, median_cent_distinct$birth_weight_kg, sex = median_cent_distinct$sex_recode)/100
```
##zscore centiles (new df)
```{r}
#zscore centiles and other variables of interest
df.zscore <- median_cent_distinct %>%
  mutate(across(all_of(c(vol_vars,sa_vars,th_vars,global_vars, "bweight_percentile")), qnorm)) %>%
  mutate(across(all_of(c("gestational_age", "birth_weight_kg", "age_days", "age_years", "adjusted_age_in_days")), scale))
#set sex and preterm as factor
df.zscore$sex <- as.factor(median_cent_distinct$sex)
df.zscore$preterm <- as.factor(median_cent_distinct$preterm)
```

##find Inf cells, make a table of N per phenotype, then convert to NaN
```{r}
inf_nan_table <- as.data.frame(t(sapply(df.zscore[c(all_vars, "bweight_percentile")], function(x){
  c(inf = sum(is.infinite(x)), nan = sum(is.nan(x)))
})))
max(inf_nan_table$inf)
max(inf_nan_table$nan)

inf_nan_table %>% filter(inf > 0)
```
##set Inf cells to NaN
```{r}
df.zscore <- df.zscore %>% 
  mutate(across(all_of(c(all_vars, "bweight_percentile")), ~ replace(., is.infinite(.), NaN)))
```


#Vars of Interest Distribution
##Check numbers of GA and birthweight
number of overall rows, and unique participants
```{r, echo = FALSE}
#participants.tsv
##overall including repeat participant IDs
sum(!is.na(participants$gestational_age))
sum(!is.na(participants$birth_weight_kg))
sum(!is.na(participants$birth_length_cm))
##unique participant IDs
length(unique(participants$participant_id))#11492
dim(participants %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(gestational_age)))
dim(participants %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_weight_kg)))
dim(participants %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_length_cm)))
##within repeated participant IDs
dim(repeat_participants <- participants %>% 
      filter(participant_id %in% participants$participant_id[duplicated(participants$participant_id)]))#3056
sum(!is.na(repeat_participants$gestational_age))
sum(!is.na(repeat_participants$birth_weight_kg))
sum(!is.na(repeat_participants$birth_length_cm))

#mpr2cent
sum(!is.na(mpr2_cent$gestational_age))
sum(!is.na(mpr2_cent$birth_weight_kg))
sum(!is.na(mpr2_cent$birth_length_cm))
##unique participant IDs
length(unique(mpr2_cent$participant_id))
dim(mpr2_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(gestational_age)))
dim(mpr2_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_weight_kg)))
dim(mpr2_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_length_cm)))
##within repeated participant IDs
dim(repeat_mpr2_cent <- mpr2_cent %>% 
      filter(participant_id %in% mpr2_cent$participant_id[duplicated(mpr2_cent$participant_id)]))#88
sum(!is.na(repeat_mpr2_cent$gestational_age))
sum(!is.na(repeat_mpr2_cent$birth_weight_kg))
sum(!is.na(repeat_mpr2_cent$birth_length_cm))

#mprcent
sum(!is.na(mpr_cent$gestational_age))
sum(!is.na(mpr_cent$birth_weight_kg))
sum(!is.na(mpr_cent$birth_length_cm))
##unique participant IDs
length(unique(mpr_cent$participant_id))#
dim(mpr_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(gestational_age)))
dim(mpr_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_weight_kg)))
dim(mpr_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_length_cm)))
##within repeated participant IDs
dim(repeat_mpr_cent <- mpr_cent %>% 
      filter(participant_id %in% mpr_cent$participant_id[duplicated(mpr_cent$participant_id)]))#88
sum(!is.na(repeat_mpr_cent$gestational_age))
sum(!is.na(repeat_mpr_cent$birth_weight_kg))
sum(!is.na(repeat_mpr_cent$birth_length_cm))

#median2cent
sum(!is.na(median2_cent$gestational_age))
sum(!is.na(median2_cent$birth_weight_kg))
sum(!is.na(median2_cent$birth_length_cm))
##unique participant IDs
length(unique(median2_cent$participant_id))#
dim(median2_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(gestational_age)))
dim(median2_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_weight_kg)))
dim(median2_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_length_cm)))
##within repeated participant IDs
dim(repeat_median2_cent <- median2_cent %>% 
      filter(participant_id %in% median2_cent$participant_id[duplicated(median2_cent$participant_id)]))#88
sum(!is.na(repeat_median2_cent$gestational_age))
sum(!is.na(repeat_median2_cent$birth_weight_kg))
sum(!is.na(repeat_median2_cent$birth_length_cm))

#mediancent
sum(!is.na(median_cent$gestational_age))
sum(!is.na(median_cent$birth_weight_kg))
sum(!is.na(median_cent$birth_length_cm))
##unique participant IDs
length(unique(median_cent$participant_id))#
dim(median_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(gestational_age)))
dim(median_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_weight_kg)))
dim(median_cent %>% distinct(participant_id, .keep_all = TRUE) %>% filter(!is.na(birth_length_cm)))
##within repeated participant IDs
dim(repeat_median_cent <- median_cent %>% 
      filter(participant_id %in% median_cent$participant_id[duplicated(median_cent$participant_id)]))#88
sum(!is.na(repeat_median_cent$gestational_age))
sum(!is.na(repeat_median_cent$birth_weight_kg))
sum(!is.na(repeat_median_cent$birth_length_cm))

```
##Plot GA and Age - QC numbers
- for median centiles (the largest dataset)
- later repeat any significant results in other datasets
```{r}
#birth weight
range(median_cent$birth_weight_kg, na.rm = TRUE)
##plot dist in all
ggplot(median_cent, aes(x = birth_weight_kg)) +
  geom_histogram() +
  labs(x = "Birth Weight (kg)", title = paste0("N = ",dim(median_cent %>% filter(!is.na(birth_weight_kg)))[1])) +
  theme_minimal()
##plot dist keeping one row per participant ID
ggplot(median_cent_distinct, aes(x = birth_weight_kg)) +
  geom_histogram() +
  labs(x = "Birth Weight (kg), Repeat Removed", title = paste0("N = ",dim(median_cent_distinct %>% filter(!is.na(birth_weight_kg)))[1])) +
  theme_minimal()
##plot dist for repeated participant IDs
ggplot(repeat_median_cent, aes(x = birth_weight_kg)) +
  geom_histogram() +
  labs(x = "Birth Weight (kg), Repeats", title = paste0("N = ",dim(repeat_median_cent %>% filter(!is.na(birth_weight_kg)))[1])) +
  theme_minimal()

#Gestational Age
range(median_cent$gestational_age, na.rm = TRUE)
##plot dist in all
ggplot(median_cent, aes(x = gestational_age)) +
  geom_histogram() +
  labs(x = "Gestational Age (weeks)", title = paste0("N = ",dim(median_cent %>% filter(!is.na(gestational_age)))[1])) +
  theme_minimal()
##plot dist keeping one row per participant ID
ggplot(median_cent_distinct, aes(x = gestational_age)) +
  geom_histogram() +
  labs(x = "Gestational Age (weeks), Repeat Removed", title = paste0("N = ",dim(median_cent_distinct %>% filter(!is.na(gestational_age)))[1])) +
  theme_minimal()
##plot dist for repeated participant IDs
ggplot(repeat_median_cent, aes(x = gestational_age)) +
  geom_histogram() +
  labs(x = "Gestational Age (weeks), Repeats", title = paste0("N = ",dim(repeat_median_cent %>% filter(!is.na(gestational_age)))[1])) +theme_minimal()

#Gestational Age x Age
range(median_cent$age_at_scan)
median_cent$age_in_years <- median_cent$age_at_scan/365
ggplot(median_cent, aes(x = age_in_years, y = gestational_age)) +
  geom_bin2d(bins = 100) +
  scale_fill_viridis_c(option = "viridis") +
  labs(x = "Age at Scan (years)", y = "Gestational Age (weeks)", title = "Median Scans") +
  theme_minimal()
```
##Numbers for median cent distinct
```{r}
sum(!is.na(median_cent_distinct$birth_weight_kg))
##plot dist keeping one row per participant ID
ggplot(median_cent_distinct, aes(x = birth_weight_kg)) +
  geom_histogram() +
  labs(x = "Birth Weight (kg), Repeat Removed", title = paste0("N = ",dim(median_cent_distinct %>% filter(!is.na(birth_weight_kg)))[1])) +
  theme_minimal()
sum(!is.na(median_cent_distinct$gestational_age))
##plot dist keeping one row per participant ID
ggplot(median_cent_distinct, aes(x = gestational_age)) +
  geom_histogram() +
  labs(x = "Gestational Age (weeks), Repeat Removed", title = paste0("N = ",dim(median_cent_distinct %>% filter(!is.na(gestational_age)))[1])) +
  theme_minimal()
```
#Ages of repeat measurements
```{r}
length(unique(repeat_median_cent$participant_id))
repeat_median_cent$age_years <- repeat_median_cent$age_days/365
ggplot(repeat_median_cent, aes(x = age_years, y = global_MeanThickness, group = participant_id, color = participant_id)) + 
  geom_point() +
  geom_line() +
  theme_minimal() +
  theme(legend.position = "none")

length(unique(repeat_median2_cent$participant_id))
repeat_median2_cent$age_years <- repeat_median2_cent$age_days/365
ggplot(repeat_median2_cent %>% filter(!is.na(gestational_age)), aes(x = age_years, y = global_MeanThickness, group = participant_id, color = gestational_age)) + 
  geom_point() +
  geom_line() +
  theme_minimal()
```
#Analyses with global phenotypes
###Global eTIV
####GA
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = global_eTIV)) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_eTIV))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = as.factor(gestational_age), y = global_eTIV)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = preterm, y = global_eTIV)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

##linear reg nonstandard
lm_eTIV_ga <- lm(global_eTIV ~ gestational_age, data = median_cent_distinct)
summary(lm_eTIV_ga)
##linear reg
lm_eTIV_ga <- lm(global_eTIV ~ ga, data = df.zscore)
summary(lm_eTIV_ga)
##linear reg with ga*age interaction
lm_eTIV_ga.age <- lm(global_eTIV ~ ga*age, data = df.zscore)
summary(lm_eTIV_ga.age)
##linear reg with ga*age interaction, quadratic age term
lm_eTIV_ga.agesq <- lm(global_eTIV ~ ga * poly(age, 2, raw = TRUE), data = df.zscore)
summary(lm_eTIV_ga.agesq)
##linear reg with ga*sex interaction
lm_eTIV_ga.sex <- lm(global_eTIV ~ ga*sex, data = df.zscore)
summary(lm_eTIV_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_eTIV))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()
##plot with lm line by sex
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_eTIV), color = sex)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  scale_color_manual(values = c("Female" = "pink", "Male" = "cyan")) +
  theme_minimal()

#Sub-groups

ga_mean <- attr(df.zscore$ga, "scaled:center")
ga_std <- attr(df.zscore$ga, "scaled:scale")
##linear reg with everyone <40 weeks
lm_eTIV_ga <- lm(global_eTIV ~ ga, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_eTIV_ga)
##linear reg with ga*age interaction
lm_eTIV_ga.age <- lm(global_eTIV ~ ga*age, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_eTIV_ga.age)
##linear reg with ga*sex interaction
lm_eTIV_ga.sex <- lm(global_eTIV ~ ga*sex, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_eTIV_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age) & gestational_age <40), aes(x = gestational_age, y = global_eTIV)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "pink") +
  theme_minimal()

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_eTIV_ga <- lm(global_eTIV ~ ga, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_eTIV_ga)
##linear reg with ga*age interaction
lm_eTIV_ga.age <- lm(global_eTIV ~ ga*age, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_eTIV_ga.age)
##linear reg with ga*sex interaction
lm_eTIV_ga.sex <- lm(global_eTIV ~ ga*sex, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_eTIV_ga.sex)

##linear reg with everyone >37 weeks (WHO preterm definition)
lm_eTIV_ga <- lm(global_eTIV ~ ga, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_eTIV_ga)
##linear reg with ga*age interaction
lm_eTIV_ga.age <- lm(global_eTIV ~ ga*age, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_eTIV_ga.age)
##linear reg with ga*sex interaction
lm_eTIV_ga.sex <- lm(global_eTIV ~ ga*sex, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_eTIV_ga.sex)
```
####BW
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_eTIV))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(global_eTIV), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

##linear reg nonstandard
lm_eTIV_bw <- lm(global_eTIV ~ birth_weight_kg, data = median_cent_distinct)
summary(lm_eTIV_bw)
##linear reg
lm_eTIV_bw <- lm(global_eTIV ~ bw, data = df.zscore)
summary(lm_eTIV_bw)
##linear reg with bw*age interaction
lm_eTIV_bw.age <- lm(global_eTIV ~ bw*age, data = df.zscore)
summary(lm_eTIV_bw.age)
interact_plot(lm_eTIV_bw.age, pred = bw, modx = age_years, modx.values = quantile(df.zscore$age_years, probs = seq(0, 1, 0.1), na.rm = FALSE), linearity.check = TRUE, plot.points = TRUE)

##linear reg with bw*sex interaction
lm_eTIV_bw.sex <- lm(global_eTIV ~ bw*sex, data = df.zscore)
summary(lm_eTIV_bw.sex)
##linear reg with bw*preterm interaction
lm_eTIV_bw.preterm <- lm(global_eTIV ~ bw*preterm, data = df.zscore)
summary(lm_eTIV_bw.preterm)
##linear reg with bw*ga interaction
lm_eTIV_bw.ga <- lm(global_eTIV ~ bw*ga, data = df.zscore)
summary(lm_eTIV_bw.ga)
##linear reg with bw+weight+height as covars (need to adjust height/weight by age)

##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_eTIV))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()
##plot with lm line by sex
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_eTIV), color = sex)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  scale_color_manual(values = c("Female" = "pink", "Male" = "cyan")) +
  theme_minimal()
```
###Global eTIV sliding window with GA
```{r}
eTIV_ga_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_eTIV", 
                             pred_var = "gestational_age", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

# plot beta vs midpoint age, color by significance
ggplot(eTIV_ga_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(eTIV_ga_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()
```
###Global eTIV sliding window with BW
```{r}
eTIV_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_eTIV", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 4, 
                             overlap = 1)

eTIV_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_eTIV", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 4, 
                             overlap = 1,
                             dist_plot = TRUE)

eTIV_bw_sw_mpr2 <- sliding_window(mpr2_cent_distinct, 
                             phenotype = "global_eTIV", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 4, 
                             overlap = 1)

eTIV_bw_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_eTIV", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 4, 
                             overlap = 1,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(eTIV_bw_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(eTIV_bw_sw_mpr2 %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(eTIV_bw_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(eTIV_bw_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()
```
###Global CortexVol
####GA
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = global_CortexVol)) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_CortexVol))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = as.factor(gestational_age), y = global_CortexVol)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = preterm, y = global_CortexVol)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

##linear reg nonstandard
lm_ctx_ga <- lm(global_CortexVol ~ gestational_age, data = median_cent_distinct)
summary(lm_MeanThickness_ga)
##linear reg
lm_ctx_ga <- lm(global_CortexVol ~ ga, data = df.zscore)
summary(lm_ctx_ga)
##linear reg with ga*age interaction
lm_ctx_ga.age <- lm(global_CortexVol ~ ga*age, data = df.zscore)
summary(lm_ctx_ga.age)
##linear reg with ga*sex interaction
lm_ctx_ga.sex <- lm(global_CortexVol ~ ga*sex, data = df.zscore)
summary(lm_ctx_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_CortexVol))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()
##plot with lm line by sex
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_CortexVol), color = sex)) +geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  scale_color_manual(values = c("Female" = "pink", "Male" = "cyan")) +
  theme_minimal()

#Sub-groups
ga_mean <- attr(df.zscore$ga, "scaled:center")
ga_std <- attr(df.zscore$ga, "scaled:scale")
##linear reg with everyone <40 weeks
lm_ctx_ga <- lm(global_CortexVol ~ ga, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_ctx_ga)
##linear reg with ga*age interaction
lm_ctx_ga.age <- lm(global_CortexVol ~ ga*age, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_ctx_ga.age)
##linear reg with ga*sex interaction
lm_ctx_ga.sex <- lm(global_CortexVol ~ ga*sex, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_ctx_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age) & gestational_age <40), aes(x = gestational_age, y = global_CortexVol)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_ctx_ga <- lm(global_CortexVol ~ ga, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_ctx_ga)
##linear reg with ga*age interaction
lm_ctx_ga.age <- lm(global_CortexVol ~ ga*age, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_ctx_ga.age)
##linear reg with ga*sex interaction
lm_ctx_ga.sex <- lm(global_CortexVol ~ ga*sex, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_ctx_ga.sex)

##linear reg with everyone >37 weeks (WHO preterm definition)
lm_ctx_ga <- lm(global_CortexVol ~ ga, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_ctx_ga)
##linear reg with ga*age interaction
lm_ctx_ga.age <- lm(global_CortexVol ~ ga*age, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_ctx_ga.age)
##linear reg with ga*sex interaction
lm_ctx_ga.sex <- lm(global_CortexVol ~ ga*sex, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_ctx_ga.sex)
```
####BW
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_CortexVol))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(global_CortexVol), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

##linear reg nonstandard
lm_ctx_bw <- lm(global_CortexVol ~ birth_weight_kg, data = median_cent_distinct)
summary(lm_ctx_bw)
##linear reg
lm_ctx_bw <- lm(global_CortexVol ~ bw, data = df.zscore)
summary(lm_ctx_bw)
##linear reg with bw*age interaction
lm_ctx_bw.age <- lm(global_CortexVol ~ bw*age, data = df.zscore)
summary(lm_ctx_bw.age)
##linear reg with bw*sex interaction
lm_ctx_bw.sex <- lm(global_CortexVol ~ bw*sex, data = df.zscore)
summary(lm_ctx_bw.sex)
##linear reg with bw*preterm interaction
lm_ctx_bw.preterm <- lm(global_CortexVol ~ bw*preterm, data = df.zscore)
summary(lm_ctx_bw.preterm)
##linear reg with bw*ga interaction
lm_ctx_bw.ga <- lm(global_CortexVol ~ bw*ga, data = df.zscore)
summary(lm_ctx_bw.ga)

##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_CortexVol))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()
```
###Global CortexVol sliding window with GA
```{r}
CortexVol_ga_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_CortexVol", 
                             pred_var = "gestational_age", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

# plot beta vs midpoint age, color by significance
ggplot(CortexVol_ga_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(CortexVol_ga_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()
```
###Global CortexVol sliding window with BW
```{r}
CortexVol_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_CortexVol", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

CortexVol_bw_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_CortexVol", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(CortexVol_bw_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(CortexVol_bw_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(CortexVol_bw_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

# plot beta vs midpoint age, color by significance
ggplot(CortexVol_bw_bysex_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta, color = group)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(x = "Age (years)", y = "BW Beta (slope)", color = "sex") +
  theme_minimal()
```
###Global Cerebral WM
####GA
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = global_CerebralWhiteMatterVol)) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_CerebralWhiteMatterVol))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = as.factor(gestational_age), y = global_CerebralWhiteMatterVol)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = preterm, y = global_CerebralWhiteMatterVol)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

##linear reg nonstandard
lm_cbwm_ga <- lm(global_CerebralWhiteMatterVol ~ gestational_age, data = median_cent_distinct)
summary(lm_cbwm_ga)
##linear reg
lm_cbwm_ga <- lm(global_CerebralWM ~ ga, data = df.zscore)
summary(lm_cbwm_ga)
##linear reg with ga*age interaction
lm_cbwm_ga.age <- lm(global_CerebralWM ~ ga*age, data = df.zscore)
summary(lm_cbwm_ga.age)
##linear reg with ga*sex interaction
lm_cbwm_ga.sex <- lm(global_CerebralWM ~ ga*sex, data = df.zscore)
summary(lm_cbwm_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_CerebralWhiteMatterVol))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

#Sub-groups
ga_mean <- attr(df.zscore$ga, "scaled:center")
ga_std <- attr(df.zscore$ga, "scaled:scale")
##linear reg with everyone <40 weeks
lm_cbwm_ga <- lm(global_CerebralWM ~ ga, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_cbwm_ga)
##linear reg with ga*age interaction
lm_cbwm_ga.age <- lm(global_CerebralWM ~ ga*age, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_cbwm_ga.age)
##linear reg with ga*sex interaction
lm_cbwm_ga.sex <- lm(global_CerebralWM ~ ga*sex, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_cbwm_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age) & gestational_age <40), aes(x = gestational_age, y = global_CerebralWhiteMatterVol)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_cbwm_ga <- lm(global_CerebralWM ~ ga, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_cbwm_ga)
##linear reg with ga*age interaction
lm_cbwm_ga.age <- lm(global_CerebralWM ~ ga*age, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_cbwm_ga.age)
##linear reg with ga*sex interaction
lm_cbwm_ga.sex <- lm(global_CerebralWM ~ ga*sex, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_cbwm_ga.sex)

##linear reg with everyone >37 weeks (WHO preterm definition)
lm_cbwm_ga <- lm(global_CerebralWM ~ ga, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_cbwm_ga)
##linear reg with ga*age interaction
lm_cbwm_ga.age <- lm(global_CerebralWM ~ ga*age, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_cbwm_ga.age)
##linear reg with ga*sex interaction
lm_cbwm_ga.sex <- lm(global_CerebralWM ~ ga*sex, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_cbwm_ga.sex)
```
####BW
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_CerebralWhiteMatterVol))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(global_CerebralWhiteMatterVol), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

##linear reg nonstandard
lm_cbwm_bw <- lm(global_CerebralWhiteMatterVol ~ birth_weight_kg, data = median_cent_distinct)
summary(lm_cbwm_bw)
##linear reg
lm_cbwm_bw <- lm(global_CerebralWM ~ bw, data = df.zscore)
summary(lm_cbwm_bw)
##linear reg with bw*age interaction
lm_cbwm_bw.age <- lm(global_CerebralWM ~ bw*age, data = df.zscore)
summary(lm_cbwm_bw.age)
##linear reg with bw*sex interaction
lm_cbwm_bw.sex <- lm(global_CerebralWM ~ bw*sex, data = df.zscore)
summary(lm_cbwm_bw.sex)
##linear reg with bw*preterm interaction
lm_cbwm_bw.preterm <- lm(global_CerebralWM ~ bw*preterm, data = df.zscore)
summary(lm_cbwm_bw.preterm)
##linear reg with bw*ga interaction
lm_cbwm_bw.ga <- lm(global_CerebralWM ~ bw*ga, data = df.zscore)
summary(lm_cbwm_bw.ga)

##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_CerebralWhiteMatterVol))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()
```

###Global CerebralWhiteMatterVol sliding window with GA
```{r}
CerebralWhiteMatterVol_ga_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_CerebralWhiteMatterVol", 
                             pred_var = "gestational_age", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

# plot beta vs midpoint age, color by significance
ggplot(CerebralWhiteMatterVol_ga_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(CerebralWhiteMatterVol_ga_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()
```
###Global CerebralWhiteMatterVol sliding window with BW
```{r}
CerebralWhiteMatterVol_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_CerebralWhiteMatterVol", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

CerebralWhiteMatterVol_bw_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_CerebralWhiteMatterVol", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(CerebralWhiteMatterVol_bw_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(CerebralWhiteMatterVol_bw_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(CerebralWhiteMatterVol_bw_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

# plot beta vs midpoint age, color by significance
ggplot(CerebralWhiteMatterVol_bw_bysex_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta, color = group)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(x = "Age (years)", y = "BW Beta (slope)", color = "sex") +
  theme_minimal()
```
###Global Surface Area
####GA
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = global_SurfaceArea)) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_SurfaceArea))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = as.factor(gestational_age), y = global_SurfaceArea)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = preterm, y = global_SurfaceArea)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

##linear reg nonstandard
lm_sa_ga <- lm(global_SurfaceArea ~ gestational_age, data = median_cent_distinct)
summary(lm_sa_ga)
##linear reg
lm_sa_ga <- lm(global_SA ~ ga, data = df.zscore)
summary(lm_sa_ga)
##linear reg with ga*age interaction
lm_sa_ga.age <- lm(global_SA ~ ga*age, data = df.zscore)
summary(lm_sa_ga.age)
##linear reg with ga*sex interaction
lm_sa_ga.sex <- lm(global_SA ~ ga*sex, data = df.zscore)
summary(lm_sa_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_SurfaceArea))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

#Sub-groups
ga_mean <- attr(df.zscore$ga, "scaled:center")
ga_std <- attr(df.zscore$ga, "scaled:scale")
##linear reg with everyone <40 weeks
lm_sa_ga <- lm(global_SA ~ ga, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_sa_ga)
##linear reg with ga*age interaction
lm_sa_ga.age <- lm(global_SA ~ ga*age, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_sa_ga.age)
##linear reg with ga*sex interaction
lm_sa_ga.sex <- lm(global_SA ~ ga*sex, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_sa_ga.sex)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age) & gestational_age <40), aes(x = gestational_age, y = global_SurfaceArea)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_sa_ga <- lm(global_SA ~ ga, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_sa_ga)
##linear reg with ga*age interaction
lm_sa_ga.age <- lm(global_SA ~ ga*age, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_sa_ga.age)
##linear reg with ga*sex interaction
lm_sa_ga.sex <- lm(global_SA ~ ga*sex, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_sa_ga.sex)

##linear reg with everyone >37 weeks (WHO preterm definition)
lm_sa_ga <- lm(global_SA ~ ga, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_sa_ga)
```
####BW
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_SurfaceArea))) +
  geom_point() +
  theme_minimal()

##linear reg nonstandard
lm_sa_bw <- lm(global_SurfaceArea ~ birth_weight_kg, data = median_cent_distinct)
summary(lm_sa_bw)
##linear reg
lm_sa_bw <- lm(global_SA ~ bw, data = df.zscore)
summary(lm_sa_bw)
##linear reg with bw*age interaction
lm_sa_bw.age <- lm(global_SA ~ bw*age, data = df.zscore)
summary(lm_sa_bw.age)
##linear reg with bw*sex interaction
lm_sa_bw.sex <- lm(global_SA ~ bw*sex, data = df.zscore)
summary(lm_sa_bw.sex)
##linear reg with bw*preterm interaction
lm_sa_bw.preterm <- lm(global_SA ~ bw*preterm, data = df.zscore)
summary(lm_sa_bw.preterm)
##linear reg with bw*ga interaction
lm_sa_bw.ga <- lm(global_SA ~ bw*ga, data = df.zscore)
summary(lm_sa_bw.ga)

##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_SurfaceArea))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(global_SurfaceArea), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()
```

###Global SurfaceArea sliding window with GA
```{r}
SurfaceArea_ga_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_SurfaceArea", 
                             pred_var = "gestational_age", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

# plot beta vs midpoint age, color by significance
ggplot(SurfaceArea_ga_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(SurfaceArea_ga_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()
```
###Global SurfaceArea sliding window with BW
```{r}
SurfaceArea_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_SurfaceArea", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

SurfaceArea_bw_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_SurfaceArea", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(SurfaceArea_bw_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(SurfaceArea_bw_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(SurfaceArea_bw_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

# plot beta vs midpoint age, color by significance
ggplot(SurfaceArea_bw_bysex_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta, color = group)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(x = "Age (years)", y = "BW Beta (slope)", color = "sex") +
  theme_minimal()
```
###Global Mean Thickness
####GA
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = global_MeanThickness)) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_MeanThickness))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = as.factor(gestational_age), y = global_MeanThickness)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = preterm, y = global_MeanThickness)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

##linear reg nonstandard
lm_meanthick_ga <- lm(global_MeanThickness ~ gestational_age, data = median_cent_distinct)
summary(lm_meanthick_ga)
##linear reg
lm_meanthick_ga <- lm(global_meanthick ~ ga, data = df.zscore)
summary(lm_meanthick_ga)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(global_MeanThickness))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

#Sub-groups
ga_mean <- attr(df.zscore$ga, "scaled:center")
ga_std <- attr(df.zscore$ga, "scaled:scale")
##linear reg with everyone <40 weeks
lm_meanthick_ga <- lm(global_meanthick ~ ga, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_meanthick_ga)

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_meanthick_ga <- lm(global_meanthick ~ ga, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_meanthick_ga)

##linear reg with everyone >37 weeks (WHO preterm definition)
lm_meanthick_ga <- lm(global_meanthick ~ ga, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_meanthick_ga)

##linear reg with age at scan < 5 years
age_mean <- attr(df.zscore$age_years, "scaled:center")
age_std <- attr(df.zscore$age_years, "scaled:scale")
lm_meanthick_ga <- lm(global_meanthick ~ ga, data = df.zscore %>% filter(age_years < (5-age_mean)/age_std))
summary(lm_meanthick_ga)

##linear reg with age at scan > 10 years
age_mean <- attr(df.zscore$age_years, "scaled:center")
age_std <- attr(df.zscore$age_years, "scaled:scale")
lm_meanthick_ga <- lm(global_meanthick ~ ga, data = df.zscore %>% filter(age_years > (10-age_mean)/age_std))
summary(lm_meanthick_ga)
```
####BW
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_MeanThickness))) +
  geom_point() +
  theme_minimal()

##linear reg nonstandard
lm_meanthick_bw <- lm(global_MeanThickness ~ birth_weight_kg, data = median_cent_distinct)
summary(lm_meanthick_bw)
##linear reg
lm_meanthick_bw <- lm(global_meanthick ~ bw, data = df.zscore)
summary(lm_meanthick_bw)
##linear reg with bw*preterm interaction
lm_meanthick_bw.preterm <- lm(global_meanthick ~ bw*preterm, data = df.zscore)
summary(lm_meanthick_bw.preterm)
##linear reg with bw*ga interaction
lm_meanthick_bw.ga <- lm(global_meanthick ~ bw*ga, data = df.zscore)
summary(lm_meanthick_bw.ga)

##linear reg with bw-percentile, calculated using the intergrowth package
median_cent_distinct <- median_cent_distinct %>%
  mutate(gestAge_days = gestational_age*7+3) %>%
  mutate(sex_recode= recode(sex, "M" = "Male", "F" = "Female"))
median_cent_distinct$bweight_percentile <- igb_wtkg2centile(median_cent_distinct$gestAge_days, median_cent_distinct$birth_weight_kg, sex = median_cent_distinct$sex_recode)/100
df.zscore$bwp <- qnorm(median_cent_distinct$bweight_percentile)
##linear reg nonstandard
lm_meanthick_bwp <- lm(global_MeanThickness ~ bweight_percentile, data = median_cent_distinct)
summary(lm_meanthick_bwp)
##linear reg
lm_meanthick_bwp <- lm(global_meanthick ~ bwp, data = df.zscore)
summary(lm_meanthick_bwp)

##linear reg with everyone <40 weeks
lm_meanthick_bw <- lm(global_meanthick ~ bw, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_meanthick_bw)

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_meanthick_bw <- lm(global_meanthick ~ bw, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_meanthick_bw)

##linear reg with everyone <32 weeks (very preterm definition)
lm_meanthick_bw <- lm(global_meanthick ~ bw, data = df.zscore %>% filter(ga < (32-ga_mean)/ga_std))
summary(lm_meanthick_bw)
lm_meanthick_bwp <- lm(global_meanthick ~ bwp, data = df.zscore %>% filter(ga < (32-ga_mean)/ga_std))
summary(lm_meanthick_bwp)

##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(global_MeanThickness))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(global_MeanThickness), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(bweight_percentile) & !is.na(preterm)), aes(x = qnorm(bweight_percentile), y = qnorm(global_MeanThickness), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()
```
###Global MeanThickness sliding window with GA
```{r}
MeanThickness_ga_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_MeanThickness", 
                             pred_var = "gestational_age", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

# plot beta vs midpoint age, color by significance
ggplot(MeanThickness_ga_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(MeanThickness_ga_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()
```
###Global MeanThickness sliding window with BW
```{r}
MeanThickness_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_MeanThickness", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

MeanThickness_bw_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_MeanThickness", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(MeanThickness_bw_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(MeanThickness_bw_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(MeanThickness_bw_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

# plot beta vs midpoint age, color by significance
ggplot(MeanThickness_bw_bysex_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta, color = group)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(x = "Age (years)", y = "BW Beta (slope)", color = "sex") +
  theme_minimal()
```
###Global MeanThickness sliding window with BWp
```{r}
MeanThickness_bwp_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_MeanThickness", 
                             pred_var = "bweight_percentile", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

MeanThickness_bwp_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "global_MeanThickness", 
                             pred_var = "bweight_percentile", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(MeanThickness_bwp_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(MeanThickness_bwp_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(MeanThickness_bwp_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

# plot beta vs midpoint age, color by significance
ggplot(MeanThickness_bwp_bysex_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta, color = group)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(x = "Age (years)", y = "BW Beta (slope)", color = "sex") +
  theme_minimal()
```
###Global Ventricle Volume
####GA
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = ss_ventricles)) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(ss_ventricles))) +
  geom_point() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = as.factor(gestational_age), y = ss_ventricles)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = preterm, y = ss_ventricles)) +
  geom_point() +
  geom_boxplot() +
  theme_minimal()

##linear reg nonstandard
lm_vent_ga <- lm(ss_ventricles ~ gestational_age, data = median_cent_distinct)
summary(lm_vent_ga)
##linear reg
lm_vent_ga <- lm(global_vent ~ ga, data = df.zscore)
summary(lm_vent_ga)
##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(gestational_age)), aes(x = gestational_age, y = qnorm(ss_ventricles))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

#Sub-groups
ga_mean <- attr(df.zscore$ga, "scaled:center")
ga_std <- attr(df.zscore$ga, "scaled:scale")
##linear reg with everyone <40 weeks
lm_vent_ga <- lm(global_vent ~ ga, data = df.zscore %>% filter(ga < (40-ga_mean)/ga_std))
summary(lm_vent_ga)

##linear reg with everyone <37 weeks (WHO preterm definition)
lm_vent_ga <- lm(global_vent ~ ga, data = df.zscore %>% filter(ga < (37-ga_mean)/ga_std))
summary(lm_vent_ga)


##linear reg with everyone >37 weeks (WHO preterm definition)
lm_vent_ga <- lm(global_vent ~ ga, data = df.zscore %>% filter(ga > (37-ga_mean)/ga_std))
summary(lm_vent_ga)
```
####BW
```{r}
##plots
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(ss_ventricles))) +
  geom_point() +
  theme_minimal()

##linear reg nonstandard
lm_vent_bw <- lm(ss_ventricles ~ birth_weight_kg, data = median_cent_distinct)
summary(lm_vent_bw)
##linear reg
lm_vent_bw <- lm(global_vent ~ bw, data = df.zscore)
summary(lm_vent_bw)
##linear reg with bw*preterm interaction
lm_vent_bw.preterm <- lm(global_vent ~ bw*preterm, data = df.zscore)
summary(lm_vent_bw.preterm)
##linear reg with bw*ga interaction
lm_vent_bw.ga <- lm(global_vent ~ bw*ga, data = df.zscore)
summary(lm_vent_bw.ga)
##linear reg with bw-percentile, calculated using the intergrowth package
median_cent_distinct <- median_cent_distinct %>%
  mutate(gestAge_days = gestational_age*7+3) %>%
  mutate(sex_recode= recode(sex, "M" = "Male", "F" = "Female"))
median_cent_distinct$bweight_percentile <- igb_wtkg2centile(median_cent_distinct$gestAge_days, median_cent_distinct$birth_weight_kg, sex = median_cent_distinct$sex_recode)/100
df.zscore$bwp <- qnorm(median_cent_distinct$bweight_percentile)
##linear reg nonstandard
lm_vent_bwp <- lm(ss_ventricles ~ bweight_percentile, data = median_cent_distinct)
summary(lm_vent_bwp)
##linear reg
lm_vent_bwp <- lm(global_vent ~ bwp, data = df.zscore)
summary(lm_vent_bwp)

##plot with lm line
ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = birth_weight_kg, y = qnorm(ss_ventricles))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "green") +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(ss_ventricles), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(birth_weight_kg) & !is.na(preterm)), aes(x = birth_weight_kg, y = qnorm(ss_ventricles), group = gestational_age, color = gestational_age)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(bweight_percentile)), aes(x = qnorm(bweight_percentile), y = qnorm(ss_ventricles))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

ggplot(median_cent_distinct %>% filter(!is.na(bweight_percentile)), aes(x = qnorm(bweight_percentile), y = qnorm(ss_ventricles), group = preterm, color = preterm)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()
```


###Global ss_ventricles sliding window with GA
```{r}
ss_ventricles_ga_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "ss_ventricles", 
                             pred_var = "gestational_age", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

# plot beta vs midpoint age, color by significance
ggplot(ss_ventricles_ga_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(ss_ventricles_ga_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()
```
###Global ss_ventricles sliding window with BW
```{r}
ss_ventricles_bw_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "ss_ventricles", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2)

ss_ventricles_bw_bysex_sw <- sliding_window(median_cent_distinct, 
                             phenotype = "ss_ventricles", 
                             pred_var = "birth_weight_kg", 
                             age_var = "age_years",
                             window_size = 3, 
                             overlap = 2,
                             group = "sex")

# plot beta vs midpoint age, color by significance
ggplot(ss_ventricles_bw_sw %>% filter(N>100), aes(x = mid_age, y = beta, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

ggplot(ss_ventricles_bw_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  labs(x = "Age (years)", y = "GA Beta (slope)") +
  theme_minimal()

#By Sex
ggplot(ss_ventricles_bw_bysex_sw, aes(x = mid_age, y = beta, color = group, linetype = sig, shape = sig)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  scale_linetype_manual(values = c("Significant" = "solid", "Not Significant" = "dashed")) +
  scale_shape_manual(values = c("Significant" = 21, "Not Significant" = 4)) +
  labs(x = "Age (years)", y = "Beta (slope)", color = "sex", linetype = "p < 0.05", shape = "p < 0.05") +
  theme_minimal()

# plot beta vs midpoint age, color by significance
ggplot(ss_ventricles_bw_bysex_sw %>% filter(sig == "Significant"), aes(x = mid_age, y = beta, color = group)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = paste0("N=", N)), vjust = -1, size = 3) +
  scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(x = "Age (years)", y = "BW Beta (slope)", color = "sex") +
  theme_minimal()
```

#Analyses with regional phenotypes
##GA
###Volume
####simple linear regressions
#####compute regressions
```{r}
sum(!is.na(df.zscore$gestational_age))
#Regional -- including cortical and subcortical
ga_volumes <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_volumes$ga_p_adj <- p.adjust(ga_volumes$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_volumes %>% filter(ga_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
cols_edit <- grepl("aseg(?!_CC)", rownames(ga_volumes), perl = TRUE)

ga_volumes$label <- rownames(ga_volumes) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

ga_volumes$label[cols_edit] <- gsub("_", "-", ga_volumes$label[cols_edit])

ga_volumes_sig_MC <- ga_volumes %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_volumes_sig_MC$ga_beta)))
```
#####save betas
```{r}
save_table_full <- ga_volumes
name <- "ga_volume.csv"
#Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
#Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```
#####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_volumes_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_volumes_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
(ga_volumes_noplot <- ga_volumes_sig_MC[!(ga_volumes_sig_MC$label %in% plot_data_dkt$label) & !(ga_volumes_sig_MC$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Median All"))

(ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GA Median All"))
```
#####Scatterplot for top betas
```{r}
top_n = 5
top <- ga_volumes_sig_MC[order(ga_volumes_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga_volumes <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga_volumes[i]) <- pheno
  scatterplots_ga_volumes[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga_volumes[start:end], ncol=nCol))
}
```
####lm with interaction
#####compute regressions
```{r}
#Regional -- including cortical and subcortical
gabyage_volumes <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[4,1], gabyage_p = summary$coefficients[4,4], gabyage_se = summary$coefficients[4,2])
})))

gabyage_volumes$ga_p_adj <- p.adjust(gabyage_volumes$ga_p, method = "BH")
gabyage_volumes$gabyage_p_adj <- p.adjust(gabyage_volumes$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage_volumes %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage_volumes %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage_volumes %>% filter(gabyage_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
cols_edit <- grepl("aseg(?!_CC)", rownames(gabyage_volumes), perl = TRUE)

gabyage_volumes$label <- rownames(gabyage_volumes) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

gabyage_volumes$label[cols_edit] <- gsub("_", "-", gabyage_volumes$label[cols_edit])

gabyage_volumes_sig <- gabyage_volumes %>% filter(gabyage_p < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage_volumes_sig$gabyage_beta)))
```
#####visualize interaction betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(gabyage_volumes_sig, ggseg::dk, by = "label")
plot_data_aseg <- merge(gabyage_volumes_sig, ggseg::aseg, by = "label")

#Regions not matched in atlases
(gabyage_volumes_noplot <- gabyage_volumes_sig[!(gabyage_volumes_sig$label %in% plot_data_dkt$label) & !(gabyage_volumes_sig$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge Interaction Median All , uncorrected"))

(ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GAxAge Interaction Median All, uncorrected"))
```
###Surface Area
####simple linear regressions
#####compute regressions
```{r}
sum(!is.na(df.zscore$gestational_age))
#Regional -- including cortical and subcortical
ga_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_sa$ga_p_adj <- p.adjust(ga_sa$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_sa %>% filter(ga_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
ga_sa$label <- rownames(ga_sa) %>% 
  sub("aparc_SurfArea_", "", .)

ga_sa_sig_MC <- ga_sa %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_sa_sig_MC$ga_beta)))
```
#####save betas
```{r}
save_table_full <- ga_sa
name <- "ga_surfArea.csv"
#Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
#Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```
#####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_sa_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(ga_sa_noplot <- ga_sa_sig_MC[!(ga_sa_sig_MC$label %in% plot_data_dkt$label) & !(ga_sa_sig_MC$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Median All, SA"))
```
#####Scatterplot for top betas
```{r}
top_n = 10
top <- ga_sa_sig_MC[order(ga_sa_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga_sa[i]) <- pheno
  scatterplots_ga_sa[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga_sa[start:end], ncol=nCol))
}
```
####lm with interaction
#####compute regressions
```{r}
#Regional -- including cortical and subcortical
gabyage_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[4,1], gabyage_p = summary$coefficients[4,4], gabyage_se = summary$coefficients[4,2])
})))

gabyage_sa$ga_p_adj <- p.adjust(gabyage_sa$ga_p, method = "BH")
gabyage_sa$gabyage_p_adj <- p.adjust(gabyage_sa$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage_sa %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage_sa %>% filter(gabyage_p_adj < 0.05))[1]))
```
###Thickness
####simple linear regressions
#####compute regressions
```{r}
sum(!is.na(df.zscore$gestational_age))
#Regional -- including cortical and subcortical
ga_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_th$ga_p_adj <- p.adjust(ga_th$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_th %>% filter(ga_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
ga_th$label <- rownames(ga_th) %>% 
  sub("aparc_ThickAvg_", "", .)

ga_th_sig_MC <- ga_th %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_th_sig_MC$ga_beta)))
```
#####save betas
```{r}
save_table_full <- ga_th
name <- "ga_thick.csv"
#Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
#Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```
#####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_th_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(ga_th_noplot <- ga_th_sig_MC[!(ga_th_sig_MC$label %in% plot_data_dkt$label) & !(ga_th_sig_MC$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Median All, Thickness"))
```
#####Scatterplot for top betas
```{r}
top_n = 5
top <- ga_th_sig_MC[order(abs(ga_th_sig_MC$ga_beta), decreasing = TRUE)[1:top_n],]
scatterplots_ga_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_ga_th)[i] <- pheno
  scatterplots_ga_th[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga_th[start:end], ncol=nCol))
}
```
####lm with interaction
#####compute regressions
```{r}
#Regional -- including cortical and subcortical
gabyage_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[4,1], gabyage_p = summary$coefficients[4,4], gabyage_se = summary$coefficients[4,2])
})))

gabyage_th$ga_p_adj <- p.adjust(gabyage_th$ga_p, method = "BH")
gabyage_th$gabyage_p_adj <- p.adjust(gabyage_th$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage_th %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage_th %>% filter(gabyage_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
gabyage_th$label <- rownames(gabyage_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
gabyage_th_sig_MC <- gabyage_th %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage_th_sig_MC$gabyage_beta)))
```
#####visualize interaction betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(gabyage_th_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(gabyage_th_noplot <- gabyage_th_sig_MC[!(gabyage_th_sig_MC$label %in% plot_data_dkt$label) & !(gabyage_th_sig_MC$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge Interaction Median All , corrected"))
```
#####visualize interaction plots
```{r}
vars <- rownames(gabyage_th_sig_MC[order(-(gabyage_th_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
```
####group by age and check ga on thickness effect
#####create dfs grouped by age
```{r}
df.zscore_young <- df.zscore %>% filter(age_years < mean(df.zscore$age_years))
df.zscore_old <- df.zscore %>% filter(age_years > mean(df.zscore$age_years))
```
#####young
######compute regressions
```{r}
sum(!is.na(df.zscore_young$gestational_age))
#Regional -- including cortical and subcortical
ga_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore_young)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_th_young$ga_p_adj <- p.adjust(ga_th_young$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_th_young %>% filter(ga_p_adj < 0.05))[1]))
```
######add label column to match to ggseg
```{r}
ga_th_young$label <- rownames(ga_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

ga_th_young_sig_MC <- ga_th_young %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_th_young_sig_MC$ga_beta)))
```
######visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_th_young_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(ga_th_young_noplot <- ga_th_young_sig_MC[!(ga_th_young_sig_MC$label %in% plot_data_dkt$label) & !(ga_th_young_sig_MC$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Median Young, Thickness"))
```

#####old
######compute regressions
```{r}
sum(!is.na(df.zscore_old$gestational_age))
#Regional -- including cortical and subcortical
ga_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore_old)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_th_old$ga_p_adj <- p.adjust(ga_th_old$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_th_old %>% filter(ga_p_adj < 0.05))[1]))
```
######add label column to match to ggseg
```{r}
ga_th_old$label <- rownames(ga_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

ga_th_old_sig_MC <- ga_th_old %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_th_old_sig_MC$ga_beta)))
```
######visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_th_old_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(ga_th_old_noplot <- ga_th_old_sig_MC[!(ga_th_old_sig_MC$label %in% plot_data_dkt$label) & !(ga_th_old_sig_MC$label %in% plot_data_aseg$label),])

#plots
(ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Median old, Thickness"))
```


##BW
###Volume
####simple linear regressions
#####compute regressions
```{r}
sum(!is.na(df.zscore$birth_weight_kg))
#Regional -- including cortical and subcortical
bw_volumes <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_volumes$bw_p_adj <- p.adjust(bw_volumes$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_volumes %>% filter(bw_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
cols_edit <- grepl("aseg(?!_CC)", rownames(bw_volumes), perl = TRUE)

bw_volumes$label <- rownames(bw_volumes) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bw_volumes$label[cols_edit] <- gsub("_", "-", bw_volumes$label[cols_edit])

bw_volumes_sig_MC <- bw_volumes %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_volumes_sig_MC$bw_beta)))
```
#####save betas
```{r}
save_table_full <- bw_volumes
name <- "bw_volume.csv"
#Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
#Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```
#####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_volumes_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_volumes_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
(bw_volumes_noplot <- bw_volumes_sig_MC[!(bw_volumes_sig_MC$label %in% plot_data_dkt$label) & !(bw_volumes_sig_MC$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bw Median All"))

(bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "bw Median All"))
```
#####Scatterplot for top betas
```{r}
top_n = 5
top <- bw_volumes_sig_MC[order(bw_volumes_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw_volumes <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw_volumes)[i] <- pheno
  scatterplots_bw_volumes[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw_volumes[start:end], ncol=nCol))
}
```
####lm with interaction
#####compute regressions
```{r}
#Regional -- including cortical and subcortical
bwbyage_volumes <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[4,1], bwbyage_p = summary$coefficients[4,4], bwbyage_se = summary$coefficients[4,2])
})))

bwbyage_volumes$bw_p_adj <- p.adjust(bwbyage_volumes$bw_p, method = "BH")
bwbyage_volumes$bwbyage_p_adj <- p.adjust(bwbyage_volumes$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage_volumes %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage_volumes %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage_volumes %>% filter(bwbyage_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
cols_edit <- grepl("aseg(?!_CC)", rownames(bwbyage_volumes), perl = TRUE)

bwbyage_volumes$label <- rownames(bwbyage_volumes) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bwbyage_volumes$label[cols_edit] <- gsub("_", "-", bwbyage_volumes$label[cols_edit])

bwbyage_volumes_sig <- bwbyage_volumes %>% filter(bwbyage_p < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage_volumes_sig$bwbyage_beta)))
```
#####visualize interaction betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwbyage_volumes_sig, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwbyage_volumes_sig, ggseg::aseg, by = "label")

#Regions not matched in atlases
(bwbyage_volumes_noplot <- bwbyage_volumes_sig[!(bwbyage_volumes_sig$label %in% plot_data_dkt$label) & !(bwbyage_volumes_sig$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bwxAge Interaction Median All , uncorrected"))

(bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "bwxAge Interaction Median All, uncorrected"))
```
###Surface Area
####simple linear regressions
#####compute regressions
```{r}
sum(!is.na(df.zscore$birth_weight_kg))
#Regional -- including cortical and subcortical
bw_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_sa$bw_p_adj <- p.adjust(bw_sa$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_sa %>% filter(bw_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
bw_sa$label <- rownames(bw_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bw_sa_sig_MC <- bw_sa %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_sa_sig_MC$bw_beta)))
```
#####save betas
```{r}
save_table_full <- bw_sa
name <- "bw_surfArea.csv"
#Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
#Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```
#####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_sa_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(bw_sa_noplot <- bw_sa_sig_MC[!(bw_sa_sig_MC$label %in% plot_data_dkt$label) & !(bw_sa_sig_MC$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bw Median All, SA"))
```
#####Scatterplot for top betas
```{r}
top_n = 5
top <- bw_sa_sig_MC[order(bw_sa_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw_sa[i]) <- pheno
  scatterplots_bw_sa[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw_sa[start:end], ncol=nCol))
}
```
####lm with interaction
#####compute regressions
```{r}
#Regional -- including cortical and subcortical
bwbyage_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[4,1], bwbyage_p = summary$coefficients[4,4], bwbyage_se = summary$coefficients[4,2])
})))

bwbyage_sa$bw_p_adj <- p.adjust(bwbyage_sa$bw_p, method = "BH")
bwbyage_sa$bwbyage_p_adj <- p.adjust(bwbyage_sa$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage_sa %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage_sa %>% filter(bwbyage_p_adj < 0.05))[1]))
```
###Thickness
####simple linear regressions
#####compute regressions
```{r}
sum(!is.na(df.zscore$birth_weight_kg))
#Regional -- including cortical and subcortical
bw_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_th$bw_p_adj <- p.adjust(bw_th$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_th %>% filter(bw_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
bw_th$label <- rownames(bw_th) %>% 
  sub("aparc_ThickAvg_", "", .)

bw_th_sig_MC <- bw_th %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_th_sig_MC$bw_beta)))
```
#####save betas
```{r}
save_table_full <- bw_th
name <- "bw_thick.csv"
#Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
#Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```
#####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_th_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(bw_th_noplot <- bw_th_sig_MC[!(bw_th_sig_MC$label %in% plot_data_dkt$label) & !(bw_th_sig_MC$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bw Median All, Thickness"))
```
#####Scatterplot for top betas
```{r}
top_n = 5
top <- bw_th_sig_MC[order(abs(bw_th_sig_MC$bw_beta), decreasing = TRUE)[1:top_n],]
scatterplots_bw_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_bw_th)[i] <- pheno
  scatterplots_bw_th[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw_th[start:end], ncol=nCol))
}
```
####lm with interaction
#####compute regressions
```{r}
#Regional -- including cortical and subcortical
bwbyage_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[4,1], bwbyage_p = summary$coefficients[4,4], bwbyage_se = summary$coefficients[4,2])
})))

bwbyage_th$bw_p_adj <- p.adjust(bwbyage_th$bw_p, method = "BH")
bwbyage_th$bwbyage_p_adj <- p.adjust(bwbyage_th$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage_th %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage_th %>% filter(bwbyage_p_adj < 0.05))[1]))
```
#####add label column to match to ggseg
```{r}
bwbyage_th$label <- rownames(bwbyage_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
bwbyage_th_sig_MC <- bwbyage_th %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage_th_sig_MC$bwbyage_beta)))
```
#####visualize interaction betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwbyage_th_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(bwbyage_th_noplot <- bwbyage_th_sig_MC[!(bwbyage_th_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage_th_sig_MC$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bwxAge Interaction Median All , corrected"))
```
#####visualize interaction plots
```{r}
vars <- rownames(bwbyage_th_sig_MC[order(-(bwbyage_th_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ birth_weight_kg*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = birth_weight_kg, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
```
####group by age and check bw on thickness effect
#####create dfs grouped by age
```{r}
df.zscore_young <- df.zscore %>% filter(age_years < mean(df.zscore$age_years))
df.zscore_old <- df.zscore %>% filter(age_years > mean(df.zscore$age_years))
```
#####young
######compute regressions
```{r}
sum(!is.na(df.zscore_young$birth_weight_kg))
#Regional -- including cortical and subcortical
bw_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore_young)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_th_young$bw_p_adj <- p.adjust(bw_th_young$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_th_young %>% filter(bw_p_adj < 0.05))[1]))
```
######add label column to match to ggseg
```{r}
bw_th_young$label <- rownames(bw_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

bw_th_young_sig_MC <- bw_th_young %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_th_young_sig_MC$bw_beta)))
```
######visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_th_young_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(bw_th_young_noplot <- bw_th_young_sig_MC[!(bw_th_young_sig_MC$label %in% plot_data_dkt$label) & !(bw_th_young_sig_MC$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bw Median Young, Thickness"))
```

#####old
######compute regressions
```{r}
sum(!is.na(df.zscore_old$birth_weight_kg))
#Regional -- including cortical and subcortical
bw_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore_old)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_th_old$bw_p_adj <- p.adjust(bw_th_old$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_th_old %>% filter(bw_p_adj < 0.05))[1]))
```
######add label column to match to ggseg
```{r}
bw_th_old$label <- rownames(bw_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

bw_th_old_sig_MC <- bw_th_old %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_th_old_sig_MC$bw_beta)))
```
######visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_th_old_sig_MC, ggseg::dk, by = "label")

#Regions not matched in atlases
(bw_th_old_noplot <- bw_th_old_sig_MC[!(bw_th_old_sig_MC$label %in% plot_data_dkt$label) & !(bw_th_old_sig_MC$label %in% plot_data_aseg$label),])

#plots
(bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "bw Median old, Thickness"))
```
