---
title: "slip_premie_lmsz"
author: "Eren Kafadar"
date: "2025-11-18"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  output_folder: "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/lmsz_median_ThMPR_25.11/"
  centiles_data_path: "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/data_clean/median_Th-MPR_2026-02-04.csv"
  raw_data_path: "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/raw_csv/slip_median.csv"
  models_path: "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/RDS/"
---
# Define params if they do not exist
```{r, echo = FALSE}
if (!exists("params")) {
  params <- list(
  output_folder = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/lmsz_median_ThMPR_25.11/",
  centiles_data_path = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/data_clean/median_Th-MPR_2026-02-04.csv", 
  raw_data_path = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/raw_csv/slip_median.csv",
  models_path = "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/RDS/"
  )
}
print(params)
``` 

# controls
```{r, echo = TRUE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)

set.seed(42)
#set command
save_tables <- TRUE
plot <- TRUE
save_figs <- TRUE
```

# Load Packages
```{r, echo = FALSE}
# Load libraries
require(dplyr)
require(magrittr)
require(readr)
require(stringr)
require(tidyr)
require(gamlssTools) # Margaret's package
require(tibble)
require(glue)
# For figures/plotting
require(ggplot2)
# For figures/plotting
require(gridExtra)
require(ggsegDKT)
require(ggseg)
# require(ggpubr)
require(ggcorrplot)
require(cowplot)
require(egg)
require(interactions)
require(growthstandards)
require(gtsummary)
require(svglite)
```

# Define Paths
```{r, echo = TRUE}
# set folder paths
code_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/"
vars_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/vars/"

# output folder
save_path <- params$output_folder
if (!dir.exists(save_path)) dir.create(save_path)

##  output subfolder paths
csv_save_path <-  paste0(save_path, "results_csv/")
if (!dir.exists(csv_save_path)) dir.create(csv_save_path)
plot_save_path <- paste0(save_path, "plots/")
if (!dir.exists(plot_save_path)) dir.create(plot_save_path)
```

# Load custom functions
```{r, echo = FALSE}
panel_save <- function(plot, filename, extension, folder){
  save_name <- paste0(folder, filename, ".", extension)
  ggsave(save_name, plot = plot, dpi = 300)
}

source(glue("{code_path}R_util_lmsz.R"))
```

# Load Phenotype Variable Names
```{r, echo = FALSE}
full_vars <- read.csv(paste0(vars_path,"all_vars.csv")) %>% pull(x)
global_vars <- read.csv(paste0(vars_path,"global_vars.csv")) %>% pull(x)
vol_vars <- read.csv(paste0(vars_path,"vol_vars.csv")) %>% pull(x)
sa_vars <- read.csv(paste0(vars_path,"sa_vars.csv")) %>% pull(x)
th_vars <- read.csv(paste0(vars_path,"th_vars.csv")) %>% pull(x)

## remove aseg_CC_Central and "aseg_CC_Mid_Posterior" from the features because there is one NaN value in the centiles causing issues. In the future will edit the functions to deal with this and/or figure out why there is this NaN value.
full_vars <- full_vars[!(full_vars %in% c("aseg_CC_Central", "aseg_CC_Mid_Posterior"))]
```

# Load Clean Data
```{r, echo = FALSE}
df <- read.csv(centiles_data_path) %>% select(-"X") #%>%
  #rename_with(~paste0(.x, ".cent"), all_of(full_vars))
```

# Load Raw Data and merge
```{r, echo = FALSE}
df_raw <- read.csv(raw_data_path) %>% select(all_of(c(full_vars, "participant_id", "session_id", "sex", "age_days",
                                                      "site", "avg_grade", "age_at_scan"))) %>%
  #mutate(across(all_of(full_vars), ~c(scale(.)), .names = "{.col}.raw_normalised")) %>%
  rename_with(~paste0(.x, ".raw"), all_of(full_vars))

shared_names <- intersect(names(df_raw), names(df))

df <- merge(df, df_raw, by = shared_names, all.x = FALSE, all.y = FALSE)
```

# Z-score Centiles, remove Inf Cells

## zscore centiles (new df)
```{r, echo = FALSE}
#zscore centiles and other variables of interest
df <- df %>%
  mutate(across(all_of(full_vars), qnorm,
                         .names = "{.col}.zscore"))
#set sex and preterm as factor
df$sex <- as.factor(df$sex)
df$preterm <- as.factor(df$preterm)
zscore_vars_names <- paste0(full_vars, ".zscore")
```

## find Inf cells, make a table of N per phenotype, then convert to NaN
```{r, echo = FALSE}
inf_nan_table <- as.data.frame(t(sapply(df[zscore_vars_names], function(x){
  c(inf = sum(is.infinite(x)), nan = sum(is.nan(x)))
})))
max(inf_nan_table$inf)
max(inf_nan_table$nan)

inf_nan_table %>% filter(inf > 0)
```

## set Inf cells to NaN
```{r, echo = FALSE}
df <- df %>% 
  mutate(across(all_of(zscore_vars_names), ~ replace(., is.infinite(.), NaN)))
```

# LMSz Growth Charts

## Define LMSz models
```{r, echo = TRUE}
# Define LMSz models to process
# Mean (mu) models
m_models = c('~ adjusted_age_days_log + sex + adjusted_age_days_log*sex',
             '~ adjusted_age_days_log + sex',
             '~ adjusted_age_days_log',
             '~ sex',
             '~ 1',
             '~ 0')

# Variance (sigma) models
s_models = c('~ adjusted_age_days_log + sex',
             '~ adjusted_age_days_log',
             '~ sex',
             '~ 0')
```

## Generate LMSz growth charts for VPM and save output
```{r, echo = FALSE}
dir.create(paste0(save_path,"lmsz_models_vpm"), recursive = T)
df_subset <- df %>% filter(preterm == "VPM")

worm_plots_vpm <- list()
# Create tibble to hold best model
models_vpm <- tibble(feature = full_vars,
                 m_model = "",
                 s_model = "",
                 AIC = NA,
                 BIC = 999999999999,
                 age_coef = NA,
                 sex_coef = NA,
                 intercept_coef = NA,
                 interaction_coef = NA,
                 age_sigma_coef = NA,
                 sex_sigma_coef = NA,
                 intercept_sigma_coef = NA,
                 interaction_sigma_coef = NA)

# Build the growth chart model
p <- "zscore" # specify the phenotype
for (pheno in full_vars) {
  # Define phenotype
  print(pheno)
  #pheno_name <- glue("{pheno}Transformed")
  zscore_name <- glue("{pheno}.zscore")
  # Load reference SLIP fit model
  if (grepl("Thick",pheno)) {
      orig_fit <- readRDS(glue("{models_path}mpr-{pheno}Transformed/FIT.EXTRACT.rds"))
  } else {
      orig_fit <- readRDS(glue("{models_path}median-{pheno}Transformed/FIT.EXTRACT.rds"))
  }
  
  # Make subset
  df_tmp <- df_subset %>%
              select(participant_id, adjusted_age_days_log, sex, 
                     adjusted_age_years,
                     !!pheno, !!zscore_name) %>%
              rename(zscore = !!zscore_name) %>%
              na.omit()
  
  # Loop through each mu and sigma model
  mod <- models_vpm$feature == pheno
  for (m in m_models) {
    for (s in s_models) {
      print(m)
      print(s)
      
      # Run preliminary model - all subjects
      growthChartModel <- gamlss(formula = as.formula(glue("zscore {m}")),
                                     sigma.formula = as.formula(glue("zscore {s}")),
                                     family = NO,
                                     data = df_tmp,
                                     control = gamlss.control(n.cyc = 200),  # See (2)
                                     trace = F)
      
      # # Re-weight observations to exclude individuals with large residuals (> 3.5)
      # df_tmp$weight_tmp <- df_tmp$weight
      # df_tmp$weight_tmp[which(abs(resid(growthChartModel_all)) > 3.5)] <- 0
      # 
      # # Run refined model
      # growthChartModel <- gamlss(formula = as.formula(glue("zscore {m}")),
      #                                sigma.formula = as.formula(glue("zscore {s}")),
      #                                family = NO,
      #                                data = df_tmp,
      #                                weights = df_tmp$weight_tmp,
      #                                control = gamlss.control(n.cyc = 500),
      #                                trace = F)
      
      # Check if the model has the lowest BIC and record it
      if (growthChartModel$sbc <= models_vpm$BIC[mod]) {
        fin_model <- growthChartModel
        models_vpm$m_model[mod] <- m
        models_vpm$s_model[mod] <- s
        models_vpm$BIC[mod] <- growthChartModel$sbc
      }
      print("--------------")
    }
  }
  
  # Refine formatting of final models
  models_vpm$m_model[mod] <- format(fin_model$mu.formula)
  models_vpm$s_model[mod] <- format(fin_model$sigma.formula)
  
  # Extract model coefficients - mu
  models_vpm$intercept_coef[mod]   <- fin_model$mu.coefficients["(Intercept)"]
  models_vpm$age_coef[mod]         <- fin_model$mu.coefficients["adjusted_age_days_log"]
  models_vpm$sex_coef[mod]         <- fin_model$mu.coefficients["sexMale"]
  models_vpm$interaction_coef[mod] <- fin_model$mu.coefficients["adjusted_age_days_log:sexMale"]
  # Extract model coefficients - sigma
  models_vpm$intercept_sigma_coef[mod]   <- fin_model$sigma.coefficients["(Intercept)"]
  models_vpm$age_sigma_coef[mod]         <- fin_model$sigma.coefficients["adjusted_age_days_log"]
  models_vpm$sex_sigma_coef[mod]         <- fin_model$sigma.coefficients["sexMale"]
  models_vpm$interaction_sigma_coef[mod] <- fin_model$sigma.coefficients["adjusted_age_days_log:sexMale"]

  # Extract final AIC/BIC
  models_vpm$AIC[mod] <- fin_model$aic
  models_vpm$BIC[mod] <- fin_model$sbc
  
  # Save final model
  saveRDS(fin_model,glue("{save_path}lmsz_models_vpm/lmsz_{pheno}.rds"))

  # Update LMSz quantiles
  df_tmp <- df_tmp %>%
        add_column(!!glue("{pheno}.lmsz") := pred_og_centiles(fin_model,
                                                                          df_tmp)) %>%
        select(-c(pheno, zscore, adjusted_age_years))
  
  # Add LMSz centile to final dataframe
  df_subset <- df_subset %>% left_join(df_tmp, by = join_by(participant_id, sex, adjusted_age_days_log))
  
  # Save worm plot
  worm_plots_vpm[[pheno]] <- wp.taki(fin_model) +
                                  ggtitle("LMSz Worm Plot") +
                                  theme_classic(base_size = 12) +
                                  theme(plot.title = element_text(size = 12),
                                        axis.title = element_text(size = 12))

  
  print("-------------------------")
}
df_vpm <- df_subset
```

### check betas across vars and intercept to see if there are any phenotypes that are wack
```{r, echo = FALSE}
hist(models_vpm$intercept_coef)
hist(models_vpm$intercept_sigma_coef)

hist(models_vpm$age_coef)
hist(models_vpm$age_sigma_coef)

hist(models_vpm$sex_coef)
hist(models_vpm$sex_sigma_coef)
```

### Save Models and Centiles
```{r, echo = FALSE}
write_csv(models_vpm, glue("{csv_save_path}lmsz_models_vpm.csv"))
write_csv(df_vpm, glue("{csv_save_path}lmsz_adjusted_centiles_vpm.csv"))
```

## Generate LMSz growth charts for LPM and save output
```{r, echo = FALSE}
dir.create(paste0(save_path,"lmsz_models_lpm"), recursive = T)
df_subset <- df %>% filter(preterm == "LPM")

worm_plots_lpm <- list()
# Create tibble to hold best model
models_lpm <- tibble(feature = full_vars,
                 m_model = "",
                 s_model = "",
                 AIC = NA,
                 BIC = 999999999999,
                 age_coef = NA,
                 sex_coef = NA,
                 intercept_coef = NA,
                 interaction_coef = NA,
                 age_sigma_coef = NA,
                 sex_sigma_coef = NA,
                 intercept_sigma_coef = NA,
                 interaction_sigma_coef = NA)

# Build the growth chart model
p <- "zscore" # specify the phenotype
for (pheno in full_vars) {
  # Define phenotype
  print(pheno)
  #pheno_name <- glue("{pheno}Transformed")
  zscore_name <- glue("{pheno}.zscore")
  # Load reference SLIP fit model
  if (grepl("Thick",pheno)) {
      orig_fit <- readRDS(glue("{models_path}mpr-{pheno}Transformed/FIT.EXTRACT.rds"))
  } else {
      orig_fit <- readRDS(glue("{models_path}median-{pheno}Transformed/FIT.EXTRACT.rds"))
  }
  
  # Make subset
  df_tmp <- df_subset %>%
              select(participant_id, adjusted_age_days_log, sex, 
                     adjusted_age_years,
                     !!pheno, !!zscore_name) %>%
              rename(zscore = !!zscore_name) %>%
              na.omit()
  
  # Loop through each mu and sigma model
  mod <- models_lpm$feature == pheno
  for (m in m_models) {
    for (s in s_models) {
      print(m)
      print(s)
      
      # Run preliminary model - all subjects
      growthChartModel <- gamlss(formula = as.formula(glue("zscore {m}")),
                                     sigma.formula = as.formula(glue("zscore {s}")),
                                     family = NO,
                                     data = df_tmp,
                                     control = gamlss.control(n.cyc = 200),  # See (2)
                                     trace = F)
      
      # # Re-weight observations to exclude individuals with large residuals (> 3.5)
      # df_tmp$weight_tmp <- df_tmp$weight
      # df_tmp$weight_tmp[which(abs(resid(growthChartModel_all)) > 3.5)] <- 0
      # 
      # # Run refined model
      # growthChartModel <- gamlss(formula = as.formula(glue("zscore {m}")),
      #                                sigma.formula = as.formula(glue("zscore {s}")),
      #                                family = NO,
      #                                data = df_tmp,
      #                                weights = df_tmp$weight_tmp,
      #                                control = gamlss.control(n.cyc = 500),
      #                                trace = F)
      
      # Check if the model has the lowest BIC and record it
      if (growthChartModel$sbc <= models_lpm$BIC[mod]) {
        fin_model <- growthChartModel
        models_lpm$m_model[mod] <- m
        models_lpm$s_model[mod] <- s
        models_lpm$BIC[mod] <- growthChartModel$sbc
      }
      print("--------------")
    }
  }
  
  # Refine formatting of final models
  models_lpm$m_model[mod] <- format(fin_model$mu.formula)
  models_lpm$s_model[mod] <- format(fin_model$sigma.formula)
  
  # Extract model coefficients - mu
  models_lpm$intercept_coef[mod]   <- fin_model$mu.coefficients["(Intercept)"]
  models_lpm$age_coef[mod]         <- fin_model$mu.coefficients["adjusted_age_days_log"]
  models_lpm$sex_coef[mod]         <- fin_model$mu.coefficients["sexMale"]
  models_lpm$interaction_coef[mod] <- fin_model$mu.coefficients["adjusted_age_days_log:sexMale"]
  # Extract model coefficients - sigma
  models_lpm$intercept_sigma_coef[mod]   <- fin_model$sigma.coefficients["(Intercept)"]
  models_lpm$age_sigma_coef[mod]         <- fin_model$sigma.coefficients["adjusted_age_days_log"]
  models_lpm$sex_sigma_coef[mod]         <- fin_model$sigma.coefficients["sexMale"]
  models_lpm$interaction_sigma_coef[mod] <- fin_model$sigma.coefficients["adjusted_age_days_log:sexMale"]

  # Extract final AIC/BIC
  models_lpm$AIC[mod] <- fin_model$aic
  models_lpm$BIC[mod] <- fin_model$sbc
  
  # Save final model
  saveRDS(fin_model,glue("{save_path}lmsz_models_lpm/lmsz_{pheno}.rds"))

  # Update LMSz quantiles
  df_tmp <- df_tmp %>%
        add_column(!!glue("{pheno}.lmsz") := pred_og_centiles(fin_model,
                                                                          df_tmp)) %>%
        select(-c(pheno, zscore, adjusted_age_years))
  
  # Add LMSz centile to final dataframe
  df_subset <- df_subset %>% left_join(df_tmp, by = join_by(participant_id, sex, adjusted_age_days_log))
  
  # Save worm plot
  worm_plots_lpm[[pheno]] <- wp.taki(fin_model) +
                                  ggtitle("LMSz Worm Plot") +
                                  theme_classic(base_size = 12) +
                                  theme(plot.title = element_text(size = 12),
                                        axis.title = element_text(size = 12))

  
  print("-------------------------")
}
df_lpm <- df_subset
```
### check betas across vars and intercept to see if there are any phenotypes that are wack
```{r, echo = FALSE}
hist(models_lpm$intercept_coef)
hist(models_lpm$intercept_sigma_coef)

hist(models_lpm$age_coef)
hist(models_lpm$age_sigma_coef)

#hist(models_lpm$sex_coef) #(none)
hist(models_lpm$sex_sigma_coef)
```

### Save Models and Centiles
```{r, echo = FALSE}
write_csv(models_lpm, glue("{csv_save_path}lmsz_models_lpm.csv"))
write_csv(df_lpm, glue("{csv_save_path}lmsz_adjusted_centiles_lpm.csv"))
```

# Backtransform Centiles VPM

## Calculate Centile Fans
```{r, echo = FALSE}
##simulation frames, log days age and sex
#between 280 days (40 weeks gestation) and 21 years
sim_list_slip <- list()
sim_list_slip$Male <- expand.grid(adjusted_age_days_log = seq(log(280),log(365.25*21+280),0.01),
                                  sex = c("Male"))
sim_list_slip$Female <- expand.grid(adjusted_age_days_log = seq(log(280),log(365.25*21+280),0.01),
                                    sex = c("Female"))

#| results: false
for (pheno in full_vars) {
  print(pheno)

  #df_vpm[which(is.na(df_vpm$pheno)),glue("{pheno}.raw_normalised")]
  tmp <-  backtransform_centile_fans(pheno, 
                                     glue("{save_path}lmsz_models_vpm/"), 
                                     sim_list_slip, 
                                     df_vpm)
  if (pheno == full_vars[1]) {
    out_fans_slip2 <- tmp
  } else {
    out_fans_slip2 <- bind_rows(out_fans_slip, tmp)
  }
}
```

## Save centile fans calculated
```{r, echo = FALSE}
write_csv(out_fans_slip, glue("{csv_save_path}lmsz_centfans_vpm_uncorrected.csv"))
```

# Backtransform Centiles LPM

## Calculate Centile Fans
```{r, echo = FALSE}
##simulation frames, log days age and sex
#between 280 days (40 weeks gestation) and 21 years
sim_list_slip <- list()
sim_list_slip$Male <- expand.grid(adjusted_age_days_log = seq(log(280),log(365.25*21+280),0.01),
                                  sex = c("Male"))
sim_list_slip$Female <- expand.grid(adjusted_age_days_log = seq(log(280),log(365.25*21+280),0.01),
                                    sex = c("Female"))

#| results: false
for (pheno in full_vars) {
  print(pheno)

  #df_vpm[which(is.na(df_vpm$pheno)),glue("{pheno}.raw_normalised")]
  tmp <-  backtransform_centile_fans(pheno, 
                                     glue("{save_path}lmsz_models_lpm/"), 
                                     sim_list_slip, 
                                     df_lpm)
  if (pheno == full_vars[1]) {
    out_fans_slip <- tmp
  } else {
    out_fans_slip <- bind_rows(out_fans_slip, tmp)
  }
}
```

### Save centile fans calculated
```{r, echo = FALSE}
write_csv(out_fans_slip, glue("{csv_save_path}lmsz_centfans_lpm_uncorrected.csv"))
```