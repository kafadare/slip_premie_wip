---
title: "SLIP GA Prelim"
output:
  html_document:
    df_print: paged
params:
  output_folder : "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/"
  centiles_path: "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/SLIP_25_11/CSV/centile_csv/slip_median_centiles.csv"
---
# Define params if they do not exist
```{r}
if (!exists("params")) {
  params <- list(
  output_folder = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/",
  centiles_path = "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/data_clean/centiles_distinct_2026-01-27.csv" 
  )
}
``` 

# Controls
```{r setup, echo = TRUE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
# set command
save_tables <- TRUE
plot <- TRUE
save_figs <- TRUE
gamlss_models <- FALSE
global_measure_vol <- "global_eTIV"
global_measure_sa <- "global_SurfaceArea"
global_measure_th <- "global_MeanThickness"
set.seed(42)

output_folder <- params$output_folder
centiles_path <- params$centiles_path
```

# Define Paths
```{r, echo = TRUE}
# set folder paths
code_path <- "/mcd dnt/isilon/bgdlab_processing/Eren/slip_premie_wip/"
vars_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/vars/"

# data paths
qc_metrics_path <- "/mnt/isilon/bgdlab_processing/releases_clinical/2025_03_release/derivatives/recon-all-clinical/fs7.4.1-clinical-reconall-qc.csv"
gamlss_data_path <- "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/RDS/mpr/DATA.rds"

# output folder
output_folder <- params$output_folder
if (!dir.exists(output_folder)) dir.create(output_folder)
##  output subfolder paths
csv_output_folder <-  paste0(output_folder, "results_csv/")
if (!dir.exists(csv_output_folder)) dir.create(csv_output_folder)
plot_output_folder <- paste0(output_folder, "plots/")
if (!dir.exists(plot_output_folder)) dir.create(plot_output_folder)
betas_folder <- paste0(csv_output_folder, "full_betas/")
if (!dir.exists(betas_folder)) dir.create(betas_folder)
dkt_folder <- paste0(csv_output_folder, "dkt_betas/")
if (!dir.exists(dkt_folder)) dir.create(dkt_folder)

```

# Load custom functions
```{r, echo = FALSE}
source(paste0(code_path,"sliding_window.R"))

panel_save <- function(plot, filename, extension, folder){
  save_name <- paste0(folder, filename, ".", extension)
  ggsave(save_name, plot = plot, dpi = 300)
}
```

# Load Packages
```{r, echo = FALSE}
# Load libraries
require(dplyr)
require(glue)
require(magrittr)
require(readr)
require(stringr)
require(tidyr)
require(gamlssTools) # Margaret's package
require(tibble)
# For figures/plotting
require(ggplot2)
require(gridExtra)
require(ggsegDKT)
require(ggseg)
# require(ggpubr)
require(ggcorrplot)
require(cowplot)
require(egg)
require(interactions)
require(growthstandards)
require(gtsummary)
require(svglite)
```

# Plots specifications
```{r, echo = TRUE}
limits = c(-0.3, 0.3)
low_color = "#4878CF"
mid_color = "white"
high_color = "#D65F5F"
```

# Plotting helper vectors, name-mapping
```{r, echo = FALSE}
# df to map variable names onto names displayed on figures
name_mapping <- data.frame(
  abbreviation = c(
     "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_cdk_total",   
     "totalWM_cb", "totalWM_crb", "totalGM_crb",
     
    "smri_vol_scs_cbwmatterlh", "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_csf",
    "smri_vol_scs_lesionlh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_cbwmatterrh", "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh", "smri_vol_scs_lesionrh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_wmhint",
    "smri_vol_scs_wmhintlh", "smri_vol_scs_wmhintrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat", 
    
    "smri_vol_scs_wholeb", "smri_vol_scs_latventricles",
    "smri_vol_scs_allventricles", "smri_vol_scs_intracranialv", "smri_vol_scs_suprateialv",
    "smri_vol_scs_subcorticalgv",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  ),
  region_name = c(
    "Left-Cerebral_Cortex", "Right-Cerebral-Cortex", "Total-Cerebral-Cortex",
    "Total_Cerebral-WM", "Total_Cerebellum-WM", "Total-Cerebellum-Cortex",
    
    "Left-Cerebral-White-Matter", "Left-Lateral-Ventricle", "Left-Inf-Lat-Vent",
    "Left-Cerebellum-White-Matter", "Left-Cerebellum-Cortex", "Left-Thalamus-Proper",
    "Left-Caudate", "Left-Putamen", "Left-Pallidum",
    "x3rd-ventricle", "x4th-ventricle", "Brain-Stem",
    "Left-Hippocampus", "Left-Amygdala", "Cerebrospinal-Fluid",
    "Left-Lesion", "Left-Accumbens-Area", "Left-VentralDC",
    
   "Right-Cerebral-White-Matter", "Right-Lateral-Ventricle", "Right-Inf-Lat-Vent",
    "Right-Cerebellum-White-Matter", "Right-Cerebellum-Cortex", "Right-Thalamus-Proper",
    "Right-Caudate", "Right-Putamen", "Right-Pallidum",
    "Right-Hippocampus", "Right-Amygdala",
    "Right-Lesion", "Right-Accumbens-Area", "Right-VentralDC",
    
    "WM-Hypointensities","Left-WM-Hypointensities", "Right-WM-Hypointensities",
   
   "CC_Posterior","CC_Mid_Posterior", "CC_Central", "CC_Mid_Anterior",
    "CC_Anterior", 
   
   "WholeBrain", "LatVentricles","AllVentricles", "IntracranialVolume", 
   "SupratentorialVolume", "SubcorticalGrayVolume",
   
     "lh_bankssts", "lh_caudalanteriorcingulate", "lh_caudalmiddlefrontal",
    "lh_cuneus", "lh_entorhinal", "lh_fusiform",
    "lh_inferiorparietal", "lh_inferiortemporal", "lh_isthmuscingulate",
    "lh_lateraloccipital", "lh_lateralorbitofrontal", "lh_lingual",
    "lh_medialorbitofrontal", "lh_middletemporal", "lh_parahippocampal",
    "lh_paracentral", "lh_parsopercularis", "lh_parsorbitalis",
    "lh_parstriangularis", "lh_pericalcarine", "lh_postcentral",
    "lh_posteriorcingulate", "lh_precentral", "lh_precuneus", "lh_rostralanteriorcingulate",
    "lh_rostralmiddlefrontal", "lh_superiorfrontal", "lh_superiorparietal",
    "lh_superiortemporal", "lh_supramarginal", "lh_frontalpole",
    "lh_temporalpole", "lh_transversetemporal", "lh_insula",
   
     "rh_bankssts", "rh_caudalanteriorcingulate", "rh_caudalmiddlefrontal",
    "rh_cuneus", "rh_entorhinal", "rh_fusiform",
    "rh_inferiorparietal", "rh_inferiortemporal", "rh_isthmuscingulate",
    "rh_lateraloccipital", "rh_lateralorbitofrontal", "rh_lingual",
    "rh_medialorbitofrontal", "rh_middletemporal", "rh_parahippocampal",
    "rh_paracentral", "rh_parsopercularis", "rh_parsorbitalis",
    "rh_parstriangularis", "rh_pericalcarine", "rh_postcentral",
    "rh_posteriorcingulate", "rh_precentral", "rh_precuneus", "rh_rostralanteriorcingulate",
    "rh_rostralmiddlefrontal", "rh_superiorfrontal", "rh_superiorparietal",
    "rh_superiortemporal", "rh_supramarginal", "rh_frontalpole",
    "rh_temporalpole", "rh_transversetemporal", "rh_insula"
    )
)

phenotypes_for_MC <- c(
    "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  )

global_phenotypes <- c("smri_vol_cdk_total", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv")

phenotypes_to_fit <- (c(phenotypes_for_MC, global_phenotypes, "smri_vol_scs_wholeb", "smri_vol_scs_wholeb", "totalWM_crb", "totalGM_crb", "smri_vol_scs_csf", "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_scs_cbwmatterlh", "smri_vol_scs_cbwmatterrh"))

# save phenotypes not plotted with ggseg surface plots
plot_data_dkt <- merge(name_mapping, ggseg::dk, by.x = "region_name", by.y = "label")
plot_data_aseg <- merge(name_mapping, ggseg::aseg, by.x = "region_name", by.y = "label")
```

# Read in data files
```{r, echo = FALSE, echo = FALSE}
full_vars <- read.csv(paste0(vars_path,"all_vars.csv")) %>% pull(x)
global_vars <- read.csv(paste0(vars_path,"global_vars.csv")) %>% pull(x)
vol_vars <- read.csv(paste0(vars_path,"vol_vars.csv")) %>% pull(x)
sa_vars <- read.csv(paste0(vars_path,"sa_vars.csv")) %>% pull(x)
th_vars <- read.csv(paste0(vars_path,"th_vars.csv")) %>% pull(x)

full_df <- read.csv(centiles_path) %>% select(-("X"))
full_df <-  full_df %>% select(-(grep("_Z", names(full_df))))
if (gamlss_models == TRUE) {
  gamlss_data <- readRDS(gamlss_data_path)
}
```

# Find if any models don't exist, remove from variable list for downstream analysis.
```{r, echo = FALSE}
vars_missing <- full_vars[!(full_vars %in% names(full_df))]
print(paste0("Phenotype Variables Missing in the Data Provided: ", paste(vars_missing, collapse = ", ")))
full_vars <- full_vars[!(full_vars %in% vars_missing)]
global_vars <- global_vars[!(global_vars %in% vars_missing)]
vol_vars <- vol_vars[!(vol_vars %in% vars_missing)]
sa_vars <- sa_vars[!(sa_vars %in% vars_missing)]
th_vars <- th_vars[!(th_vars %in% vars_missing)]
```

# Find any cells with missing data within the centile scores
```{r, echo = FALSE}
missing_data_sessions <- full_df[rowSums(is.na(full_df[, full_vars, drop = FALSE])) > 0, ]$session_id
print(paste0("Number of sessions with any missing centile data: ", dim(missing_data_sessions)[1]))
missing_data_sessions_df <- full_df %>% filter(session_id %in% missing_data_sessions) %>% select(any_of(c("session_id", "participant_id", "age_years", full_vars)))

# remove sessions with any missing data (especially for calculating CMDs)
full_df <- full_df[!(full_df$session_id %in% missing_data_sessions),]
```

# Numbers for gamlss models
```{r, echo = FALSE}
if (exists("gamlss_data")){
  gamlss_data_inc <- gamlss_data %>% filter(INDEX.OB == 1)
  length(unique(gamlss_data_inc$participant_id))
  range(gamlss_data_inc$age_days/365)
}
```

# Deal with QC Variable Naming Difference
```{r, echo = FALSE}
if(!("median_euler_mean" %in% names(full_df)) & "euler_mean" %in% names(full_df)){
    full_df$qc_var <- full_df$euler_mean
}else if("median_euler_mean" %in% names(full_df)){
  full_df$qc_var <- full_df$median_euler_mean
}
```

# Remove Age > 21
```{r, echo = TRUE}
hist(full_df$adjusted_age_years)
sum(!is.na(full_df$birth_weight_kg))
sum(!is.na(full_df$gestational_age))
sum(!is.na(full_df$birth_weight_kg) & !is.na(full_df$gestational_age))

full_df <- full_df %>% filter(adjusted_age_years <= 21)

sum(!is.na(full_df$birth_weight_kg))
sum(!is.na(full_df$gestational_age))
sum(!is.na(full_df$birth_weight_kg) & !is.na(full_df$gestational_age))

IQR(full_df$age_years)
median(full_df$age_years)
```

# CMD

## correlations between CMDs for vol, sa, and th
```{r, echo = FALSE}
vol_vars_cortical <- vol_vars[grep("aparc", vol_vars)]
length_names <- length(c(vol_vars_cortical, sa_vars, th_vars))
# Ensure all names are in the same order
names_base <- names(full_df)[grep("aparc_GrayVol", names(full_df))] %>% sub("aparc_GrayVol_","",.) %>%
  gsub("_Z", "", .)
names.vol <- paste0("aparc_GrayVol_",names_base)
names.sa <- paste0("aparc_SurfArea_",names_base)
names.th <- paste0("aparc_ThickAvg_",names_base)
df_var <- data.frame(matrix(ncol = 4, nrow = dim(full_df)[1]))
colnames(df_var) <- c("vol.variance", "sa.variance", "th.variance", "participant_id")
df_var$participant_id <- full_df$participant_id
# CMD Calculation
## vol
vol.center <- colMeans(full_df %>% select(all_of(names.vol)))
vol.cov_matrix <- cov(full_df %>% select(all_of(names.vol)))
vol.md <- sqrt(mahalanobis(full_df %>% select(all_of(names.vol)), vol.center, vol.cov_matrix))
full_df$vol.cmd <- vol.md
## sa
sa.center <- colMeans(full_df %>% select(all_of(names.sa)), na.rm = TRUE)
sa.cov_matrix <- cov(full_df %>% select(all_of(names.sa)), use = "complete.obs")
sa.md <- sqrt(mahalanobis(full_df %>% select(all_of(names.sa)), sa.center, sa.cov_matrix))
full_df$sa.cmd <- sa.md
## th
th.center <- colMeans(full_df %>% select(all_of(names.th)), na.rm = TRUE)
th.cov_matrix <- cov(full_df %>% select(all_of(names.th)), use = "complete.obs")
th.md <- sqrt(mahalanobis(full_df %>% select(all_of(names.th)), th.center, th.cov_matrix))
full_df$th.cmd <- th.md

# remove outliers as defined by >5 sd from the mean
# full_df <- full_df %>% filter(vol.cmd < mean(full_df$vol.cmd) + 10*sd(full_df$vol.cmd))

# correlations between CMDs across three centiles
cor.test(full_df$vol.cmd, full_df$sa.cmd)
cor.test(full_df$vol.cmd, full_df$th.cmd)
cor.test(full_df$sa.cmd, full_df$th.cmd)

# Plots for CMD correlations
(vol_sa_cmd <- ggplot(data = full_df, mapping = aes(x = vol.cmd, y = sa.cmd)) + 
  geom_point(alpha = 0.3, color = "gray") + 
  geom_smooth(method = "lm", se = FALSE, color = "magenta") +
  theme_minimal() + labs (x = "Volume CMD", y = "Surface Area CMD") +
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 18)))

(vol_th_cmd <- ggplot(data = full_df, mapping = aes(x = vol.cmd, y = th.cmd)) + 
  geom_point(alpha = 0.3, color = "gray") + 
  geom_smooth(method = "lm", se = FALSE, color = "magenta") +
  theme_minimal() + labs (x = "Volume CMD", y = "Cortical Thickness CMD") +
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 18)))


(sa_th_cmd <- ggplot(data = full_df, mapping = aes(x = sa.cmd, y = th.cmd)) + 
  geom_point(alpha = 0.3, color = "gray") + 
  geom_smooth(method = "lm", se = FALSE, color = "magenta") +
  theme_minimal()  + labs (x = "Surface Area CMD", y = "Cortical Thickness CMD")+
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 18)))


if(save_figs == TRUE){
panel_save(vol_sa_cmd, "vol-sa-cmd", "pdf", plot_output_folder)
panel_save(vol_th_cmd, "vol-th-cmd", "pdf", plot_output_folder)
panel_save(sa_th_cmd, "sa-th-cmd", "pdf", plot_output_folder)
}
```

## correlations between CMDs and centile scores
```{r, echo = FALSE}
# volume
cor_matrix <- cor(full_df[,c(vol_vars_cortical, "vol.cmd")], use = "pairwise.complete.obs")
p_mat <- cor_pmat(full_df[,c(vol_vars_cortical, "vol.cmd")])

cor_vol.cmd <- cor_matrix[, "vol.cmd" , drop = FALSE]
p_vol.cmd <- p_mat[, "vol.cmd" , drop = FALSE]

ggcorrplot(
  cor_vol.cmd,
  p.mat = p_vol.cmd,
  type = "lower",
  insig = "blank",
  lab = FALSE
)

# sa
cor_matrix <- cor(full_df[,c(sa_vars, "sa.cmd")], use = "pairwise.complete.obs")
p_mat <- cor_pmat(full_df[,c(sa_vars, "sa.cmd")])

cor_sa.cmd <- cor_matrix[, "sa.cmd" , drop = FALSE]
p_sa.cmd <- p_mat[, "sa.cmd" , drop = FALSE]

ggcorrplot(
  cor_sa.cmd,
  p.mat = p_sa.cmd,
  type = "lower",
  insig = "blank",
  lab = FALSE
)

# th
cor_matrix <- cor(full_df[,c(th_vars, "th.cmd")], use = "pairwise.complete.obs")
p_mat <- cor_pmat(full_df[,c(th_vars, "th.cmd")])

cor_th.cmd <- cor_matrix[, "th.cmd" , drop = FALSE]
p_th.cmd <- p_mat[, "th.cmd" , drop = FALSE]

ggcorrplot(
  cor_th.cmd,
  p.mat = p_th.cmd,
  type = "lower",
  insig = "blank",
  lab = FALSE
)
```

# Prepare Df for Analysis

## zscore centiles (new df)
```{r, echo = FALSE}
# zscore centiles and other variables of interest
df.zscore <- full_df %>%
  mutate(across(all_of(c(full_vars, "bweight_percentile")), qnorm)) %>%
  mutate(across(all_of(c("gestational_age", "birth_weight_kg", "age_days", "age_years", "adjusted_age_in_days", "adjusted_age_years", "qc_var", "vol.cmd", "sa.cmd", "th.cmd")), scale))
# set sex and preterm as factor
df.zscore$sex <- as.factor(full_df$sex)
df.zscore$preterm <- as.factor(full_df$preterm)
```

## find Inf cells, make a table of N per phenotype, then convert to NaN
```{r, echo = FALSE}
inf_nan_table <- as.data.frame(t(sapply(df.zscore[c(full_vars, "bweight_percentile")], function(x){
  c(inf = sum(is.infinite(x)), nan = sum(is.nan(x)))
})))
max(inf_nan_table$inf)
max(inf_nan_table$nan)

inf_nan_table %>% filter(inf > 0)
```

## set Inf cells to NaN
```{r, echo = FALSE}
df.zscore <- df.zscore %>% 
  mutate(across(all_of(c(full_vars, "bweight_percentile")), ~ replace(., is.infinite(.), NaN)))
```

## create dfs grouped by age at scan
```{r, echo = FALSE}
df.zscore_young <- df.zscore %>% filter(age_years < mean(df.zscore$adjusted_age_years))
df.zscore_old <- df.zscore %>% filter(age_years > mean(df.zscore$adjusted_age_years))
```

# CMD Correlations with GA and BW

## Full available set 
```{r, echo = FALSE}
# Exploratory
cor.test(full_df$vol.cmd, full_df$gestational_age)
cor.test(full_df$vol.cmd, full_df$birth_weight_kg)

cor.test(full_df$sa.cmd, full_df$gestational_age)
cor.test(full_df$sa.cmd, full_df$birth_weight_kg)

cor.test(full_df$th.cmd, full_df$gestational_age)
cor.test(full_df$th.cmd, full_df$birth_weight_kg)
cor.test(full_df$th.cmd, full_df$bweight_percentile)

# BW-ThicknessCMD
bw_N <- sum(!is.na(full_df$birth_weight_kg))

cor_thCMD_bw <- cor.test(full_df$th.cmd, full_df$birth_weight_kg)
## plot
thCMD_bw_r <- signif(cor_thCMD_bw$estimate, 3)
thCMD_bw_p <- signif(cor_thCMD_bw$p.value, 3)

(cor_thCMD_bw_plot <- ggplot(full_df, aes(birth_weight_kg, th.cmd)) +
  geom_point(color = "#8C7FAF", alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "#8C7FAF") +
  annotate("label",
           x = 5, y = 13,
           label.size = 0,
           label = paste0("r=",thCMD_bw_r, "; p=", thCMD_bw_p)) +
  labs(
    x = paste0("Birthweight (kg), N = ", bw_N),
    y = "Cortical Thickness CMD"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_blank()
  ))
if(save_figs == TRUE){
panel_save(cor_thCMD_bw_plot, "cor-thcmd-bw", "pdf", plot_output_folder)
}

# BWpercentile-ThicknessCMD
bwp_N <- sum(!is.na(full_df$bweight_percentile))

cor_thCMD_bwp <- cor.test(full_df$th.cmd, full_df$bweight_percentile)
## plot
thCMD_bwp_r <- signif(cor_thCMD_bwp$estimate, 3)
thCMD_bwp_p <- signif(cor_thCMD_bwp$p.value, 3)

(cor_thCMD_bwp_plot <- ggplot(full_df, aes(bweight_percentile, th.cmd)) +
  geom_point(color = "#8C7FAF", alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "#8C7FAF") +
  annotate("label",
           x = 0.8, y = 13,
           label.size = 0,
           label = paste0("r=",thCMD_bwp_r, "; p=", thCMD_bwp_p)) +
  labs(
    x = paste0("Birthweight Percentile, N = ", bwp_N),
    y = "Cortical Thickness CMD"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_blank()
  ))
if(save_figs == TRUE){
panel_save(cor_thCMD_bwp_plot, "cor-thcmd-bwp", "pdf", plot_output_folder)
}

# GA-ThicknessCMD
ga_N <- sum(!is.na(full_df$gestational_age))

cor_thCMD_ga <- cor.test(full_df$th.cmd, full_df$gestational_age)
## plot
thCMD_ga_r <- signif(cor_thCMD_ga$estimate, 3)
thCMD_ga_p <- signif(cor_thCMD_ga$p.value, 3)

(cor_thCMD_ga_plot <- ggplot(full_df, aes(gestational_age, th.cmd)) +
  geom_point(color = "#8C7FAF", alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "#8C7FAF") +
  annotate("label",
           x = 30, y = 13,
           label.size = 0,
           label = paste0("r=",thCMD_ga_r, "; p=", thCMD_ga_p)) +
  labs(
    x = paste0("Gestational Age (weeks), N = ", ga_N),
    y = "Cortical Thickness CMD"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_blank()
  ))
if(save_figs == TRUE){
panel_save(cor_thCMD_ga_plot, "cor-thcmd-ga", "pdf", plot_output_folder)
}
```

## Remove CMDs > 3SD from mean
```{r, include = FALSE}
# remove outliers as defined by >3 sd from the mean
test <- full_df %>% filter(th.cmd < mean(full_df$th.cmd) + 3*sd(full_df$th.cmd))
# Exploratory
cor.test(test$vol.cmd, test$gestational_age)
cor.test(test$vol.cmd, test$birth_weight_kg)

cor.test(test$sa.cmd, test$gestational_age)
cor.test(test$sa.cmd, test$birth_weight_kg)

cor.test(test$th.cmd, test$gestational_age)
cor.test(test$th.cmd, test$birth_weight_kg)
cor.test(test$th.cmd, test$bweight_percentile)

# BW-ThicknessCMD
bw_N <- sum(!is.na(test$birth_weight_kg))

cor_thCMD_bw <- cor.test(test$th.cmd, test$birth_weight_kg)
## plot
thCMD_bw_r <- signif(cor_thCMD_bw$estimate, 3)
thCMD_bw_p <- signif(cor_thCMD_bw$p.value, 3)

(cor_thCMD_bw_plot <- ggplot(test, aes(birth_weight_kg, th.cmd)) +
  geom_point(color = "#8C7FAF", alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "#8C7FAF") +
  annotate("label",
           x = 5, y = 13,
           label.size = 0,
           label = paste0("r=",thCMD_bw_r, "; p=", thCMD_bw_p)) +
  labs(
    x = paste0("Birthweight (kg), N = ", bw_N),
    y = "Cortical Thickness CMD"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_blank()
  ))
if(save_figs == TRUE){
panel_save(cor_thCMD_bw_plot, "cor-thcmd-bw", "pdf", plot_output_folder)
}

# BWpercentile-ThicknessCMD
bwp_N <- sum(!is.na(test$bweight_percentile))

cor_thCMD_bwp <- cor.test(test$th.cmd, test$bweight_percentile)
## plot
thCMD_bwp_r <- signif(cor_thCMD_bwp$estimate, 3)
thCMD_bwp_p <- signif(cor_thCMD_bwp$p.value, 3)

ggplot(test, aes(bweight_percentile, th.cmd)) +
  geom_point(color = "#8C7FAF", alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "#8C7FAF") +
  annotate("label",
           x = 0.8, y = 13,
           label.size = 0,
           label = paste0("r=",thCMD_bwp_r, "; p=", thCMD_bwp_p)) +
  labs(
    x = paste0("Birthweight Percentile, N = ", bwp_N),
    y = "Cortical Thickness CMD"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_blank()
  )
```

# CMD Methods figure
```{r, include = FALSE}
vol_subject_row <- which(df.zscore$vol.cmd == max(df.zscore$vol.cmd))
sa_subject_row <- which(df.zscore$sa.cmd == max(df.zscore$sa.cmd))
th_subject_row <- which(df.zscore$th.cmd == max(df.zscore$th.cmd))
# compute PCA for visualization purposes
make_cmd_fig <- function(df, var_names, title, subject_row_no) {
p <- prcomp(df %>% select(all_of(var_names)))
p_df <- as.data.frame(p$x[, 1:2])
colnames(p_df) <- c("PC1", "PC2")

mu <- colMeans(p_df)
Sigma <- cov(p_df)

# make an ellipse for visualization
ellipse_level <- 0.95
chi_val <- qchisq(ellipse_level, df = 2)   #  chi-square radius

eig <- eigen(Sigma)
axes <- sqrt(eig$values * chi_val)         #  ellipse radii
theta <- seq(0, 2*pi, length.out = 200)

ellipse_mat <- t(eig$vectors %*% diag(axes) %*% rbind(cos(theta), sin(theta)))
ellipse_df <- as.data.frame(sweep(ellipse_mat, 2, mu, "+"))
colnames(ellipse_df) <- c("PC1", "PC2")

# Find subject with defined row (max CMD) and project their centiles onto the PCA space for visualization
subject <- df[subject_row_no, var_names]
sub_p   <- predict(p, subject)[, 1:2]
sub_df  <- data.frame(PC1 = sub_p[1], PC2 = sub_p[2])

# Calculate mahalanobis distance for this subject
MD <- sqrt(mahalanobis(sub_df, center = mu, cov = Sigma))

#  ------------------------------------------------------------
#  Plot
#  ------------------------------------------------------------
(plot <- ggplot() +
  geom_path(data = ellipse_df, aes(PC1, PC2), linewidth = 1, alpha = 0.7) +
  geom_point(data = p_df, aes(PC1, PC2), alpha = 0.05, size = 0.75) +
  geom_point(data = sub_df, aes(PC1, PC2), colour = "#E64B35", size = 3) +
  geom_segment(aes(x = mu[1], y = mu[2],
                   xend = sub_df$PC1, yend = sub_df$PC2),
               colour = "#E64B35", linewidth = 1) +
  #  annotate("text", x = sub_df$PC1, y = sub_df$PC2,
  #           label = paste0("MD = ", round(MD, 2)),
  #           vjust = -1, colour = "#E64B35") +
   annotate("text", x = sub_df$PC1, y = sub_df$PC2,
            label = "d",
            # vjust = -1,
            # hjust = 4, 
            colour = "#E64B35",
            fontface = "bold",
            size = 6
            ) +
  theme_minimal(base_size = 16) +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  labs(
    x = "PC1",
    y = "PC2",
    title = paste0("Schematic: ", title),
    subtitle = ""
  ))
print(plot)
return(plot)
}
# df_noNAs <- df.zscore %>% select(full_vars) %>% na.omit()
## df, var_names, title, subject_row_no
# vol_cmd_plot <- make_cmd_fig(df_noNAs, vol_vars_cortical, "CMD Cortical Volume", vol_subject_row)
(vol_cmd_plot <- make_cmd_fig(full_df, vol_vars_cortical, "CMD Cortical Volume", vol_subject_row))
vol_cmd_plot$layers[[5]]$aes_params$hjust <- 3
vol_cmd_plot$layers[[5]]$aes_params$vjust <- -0.5
(sa_cmd_plot <- make_cmd_fig(full_df, sa_vars, "CMD Cortical Surface Area", sa_subject_row))
sa_cmd_plot$layers[[5]]$aes_params$hjust <- -1.5
sa_cmd_plot$layers[[5]]$aes_params$vjust <- -1
(th_cmd_plot <- make_cmd_fig(full_df, th_vars, "CMD Cortical Thickness", th_subject_row))
th_cmd_plot$layers[[5]]$aes_params$hjust <- -3
th_cmd_plot$layers[[5]]$aes_params$vjust <- 3

if(save_figs == TRUE){
panel_save(vol_cmd_plot, "vol-cmd-pca-plot", "pdf", plot_output_folder)
panel_save(sa_cmd_plot, "sa-cmd-pca-plot", "pdf", plot_output_folder)
panel_save(th_cmd_plot, "th-cmd-pca-plot", "pdf", plot_output_folder)
}
```

# Analyses with global phenotypes

## Define global vars of interest
```{r, echo = TRUE}
global_vars_totest <- c("global_eTIV", "global_SubCortGrayVol","global_CortexVol", "global_CerebralWhiteMatterVol", "global_VentricleChoroidVol","global_SurfaceArea",
                        "global_MeanThickness", "aseg_CSF")
```

## GA
```{r, echo = FALSE}
ga_reg_table_global <- as.data.frame(t(sapply(df.zscore[, which(names(full_df) %in% global_vars_totest)], function(x) {
  lm <- lm(x ~ df.zscore$gestational_age + df.zscore$qc_var)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_global$ga_p_adj <- p.adjust(ga_reg_table_global$ga_p, method = "BH")

ga_reg_table_global %>% filter(ga_p_adj < 0.05)
range(ga_reg_table_global %>% filter(ga_p_adj < 0.05) %>% select(ga_beta))
```

## BW
```{r, echo = FALSE}
bw_reg_table_global <- as.data.frame(t(sapply(df.zscore[, which(names(full_df) %in% global_vars_totest)], function(x) {
  lm <- lm(x ~ df.zscore$birth_weight_kg + df.zscore$qc_var)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_global$bw_p_adj <- p.adjust(bw_reg_table_global$bw_p, method = "BH")

bw_reg_table_global %>% filter(bw_p_adj < 0.05)
range(bw_reg_table_global %>% filter(bw_p_adj < 0.05) %>% select(bw_beta))
```

## Visualize/Figure Panel
```{r, echo = FALSE}
#  Add phenotype column from rownames
ga_reg_table_global$phenotype <- rownames(ga_reg_table_global)
bw_reg_table_global$phenotype <- rownames(bw_reg_table_global)

#  Add model identifiers + rename to common column names
ga_reg_table_global <- ga_reg_table_global %>%
  mutate(model = "Gestational Age",
         beta = ga_beta,
         se   = ga_se,
         p_adj    = ga_p_adj) %>%
    mutate(sig = p_adj < 0.05,
          color = case_when(
            sig & beta > 0 ~ "#c87a7a",   #  muted red
            sig & beta < 0 ~ "#7293b0",   #  muted blue
            TRUE ~ "gray70"))

bw_reg_table_global <- bw_reg_table_global %>%
  mutate(model = "Birthweight",
         beta = bw_beta,
         se   = bw_se,
         p_adj    = bw_p_adj) %>%
    mutate(sig = p_adj < 0.05,
          color = case_when(
            sig & beta > 0 ~ "#c87a7a",   #  muted red
            sig & beta < 0 ~ "#7293b0",   #  muted blue
            TRUE ~ "gray70"))

#  Combine and arrange by specific order of global phenotypes
df <- bind_rows(ga_reg_table_global, bw_reg_table_global) %>%
  mutate(phenotype = factor(phenotype, levels = c("global_eTIV", "global_CortexVol", "global_CerebralWhiteMatterVol",
                                                  "global_SubCortGrayVol", "global_VentricleChoroidVol",
                                                  "global_SurfaceArea", "global_MeanThickness"))) %>% arrange(phenotype)

#  Labeling for phenotypes on plot
phenotype_labs <- c(
 global_eTIV = "Intracranial Volume",
 global_MeanThickness = "Mean Cortical Thickness",
 global_VentricleChoroidVol = "Ventricular Volume",
 global_SurfaceArea = "Total Surface Area",
 global_CortexVol = "Cortical Gray Matter Volume",
 global_CerebralWhiteMatterVol = "Cerebral White Matter Volume",
 global_SubCortGrayVol = "Subcortical Gray Matter Volume"
)

#  Plot
(global_betas_plot <- ggplot(df, aes(x = beta, y = phenotype)) +
    geom_point(aes(shape = model, color = color), size = 3) +
    geom_errorbarh(aes(xmin = beta - se, xmax = beta + se, color = color), height = 0.2) +
    scale_shape_manual(values = c("Gestational Age" = 16, "Birthweight" = 17),
                       name = "") +
    scale_color_identity() +
    scale_x_continuous(limits = c(-0.1, 0.3)) +
    scale_y_discrete(limits = rev, labels = phenotype_labs) +
    geom_vline(xintercept = 0, linetype = "dotted", color = "darkgray") +
    theme_minimal() +
    theme_bw(base_size = 16) +
    theme(
        panel.grid = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.text.y  = element_text(color = "black"),
        axis.line.x  = element_line(color = "black"),
        axis.line.y  = element_blank(),
        legend.justification = c("left", "top")
    ) +
    xlab("Standardized Beta Estimate") +
    ylab(""))

if(save_figs == TRUE){
panel_save(global_betas_plot, "global-betas-gabw", "pdf", plot_output_folder)
}
```

# Analyses with regional phenotypes

## GA

### Volume

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_vol$ga_p_adj <- p.adjust(ga_vol$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_vol %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(ga_vol), perl = TRUE)

ga_vol$label <- rownames(ga_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

ga_vol$label[cols_edit] <- gsub("_", "-", ga_vol$label[cols_edit])

ga_vol_sig_MC <- ga_vol %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_vol_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga_vol
name <- "ga_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(ga_vol_noplot <- ga_vol_sig_MC[!(ga_vol_sig_MC$label %in% plot_data_dkt$label) & !(ga_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Volume"))

(ga_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GA Volume"))

if(save_figs == TRUE){
panel_save(ga_dkt_vol_plot, "ga-dkt-vol", "pdf", plot_output_folder)
panel_save(ga_aseg_vol_plot , "ga-aseg-vol", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(ga_vol_sig_MC)[1] > 0){
top_n = if(dim(ga_vol_sig_MC)[1] > 10) {10} else {dim(ga_vol_sig_MC)[1]}
top <- ga_vol_sig_MC[order(ga_vol_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga_vol <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga_vol[i]) <- pheno
  scatterplots_ga_vol[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga_vol[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[4,1], gabyage_p = summary$coefficients[4,4], gabyage_se = summary$coefficients[4,2])
})))

gabyage_vol$ga_p_adj <- p.adjust(gabyage_vol$ga_p, method = "BH")
gabyage_vol$gabyage_p_adj <- p.adjust(gabyage_vol$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage_vol %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage_vol %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage_vol %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(gabyage_vol), perl = TRUE)

gabyage_vol$label <- rownames(gabyage_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

gabyage_vol$label[cols_edit] <- gsub("_", "-", gabyage_vol$label[cols_edit])

gabyage_vol_sig_MC <- gabyage_vol %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage_vol_sig_MC$gabyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage_vol
name <- "gabyage_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gabyage_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(gabyage_vol_noplot <- gabyage_vol_sig_MC[!(gabyage_vol_sig_MC$label %in% plot_data_dkt$label) & !(gabyage_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge Interaction Volume"))

(gabyage_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GAxAge Interaction Volume"))

if(save_figs == TRUE){
panel_save(gabyage_dkt_vol_plot, "gabyage-dkt-vol", "pdf", plot_output_folder)
panel_save(gabyage_aseg_vol_plot , "gabyage-aseg-vol", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage_vol_sig_MC)[1] > 0){
vars <- rownames(gabyage_vol_sig_MC[order(-(gabyage_vol_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_GrayVol_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Surface Area

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_sa$ga_p_adj <- p.adjust(ga_sa$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_sa %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
ga_sa$label <- rownames(ga_sa) %>% 
  sub("aparc_SurfArea_", "", .)

ga_sa_sig_MC <- ga_sa %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_sa_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga_sa
name <- "ga_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga_sa_noplot <- ga_sa_sig_MC[!(ga_sa_sig_MC$label %in% plot_data_dkt$label) & !(ga_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Surface Area"))

if(save_figs == TRUE){
panel_save(ga_dkt_sa_plot, "ga-dkt-sa", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(ga_sa_sig_MC)[1] > 0){
top_n = if(dim(ga_sa_sig_MC)[1] > 10) {10} else {dim(ga_sa_sig_MC)[1]}
top <- ga_sa_sig_MC[order(ga_sa_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga_sa[i]) <- pheno
  scatterplots_ga_sa[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga_sa[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[4,1], gabyage_p = summary$coefficients[4,4], gabyage_se = summary$coefficients[4,2])
})))

gabyage_sa$ga_p_adj <- p.adjust(gabyage_sa$ga_p, method = "BH")
gabyage_sa$gabyage_p_adj <- p.adjust(gabyage_sa$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage_sa %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage_sa %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
gabyage_sa$label <- rownames(gabyage_sa) %>% 
  sub("aparc_SurfArea_", "", .)

gabyage_sa_sig_MC <- gabyage_sa %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage_sa_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage_sa
name <- "gabyage_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(gabyage_sa_noplot <- gabyage_sa_sig_MC[!(gabyage_sa_sig_MC$label %in% plot_data_dkt$label) & !(gabyage_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge Surface Area"))

if(save_figs == TRUE){
panel_save(gabyage_dkt_sa_plot, "gabyage-dkt-sa", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage_sa_sig_MC)[1] > 0){
vars <- rownames(gabyage_sa_sig_MC[order(-(gabyage_sa_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_SurfArea_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Thickness

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_th$ga_p_adj <- p.adjust(ga_th$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_th %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
ga_th$label <- rownames(ga_th) %>% 
  sub("aparc_ThickAvg_", "", .)

ga_th_sig_MC <- ga_th %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_th_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga_th
name <- "ga_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga_th_noplot <- ga_th_sig_MC[!(ga_th_sig_MC$label %in% plot_data_dkt$label) & !(ga_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Cortical Thickness"))

if(save_figs == TRUE){
panel_save(ga_dkt_th_plot, "ga-dkt-th", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(ga_th_sig_MC)[1] > 0){
top_n = if(dim(ga_th_sig_MC)[1] > 10) {10} else {dim(ga_th_sig_MC)[1]}
top <- ga_th_sig_MC[order(abs(ga_th_sig_MC$ga_beta), decreasing = TRUE)[1:top_n],]
scatterplots_ga_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_ga_th)[i] <- pheno
  scatterplots_ga_th[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga_th[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[4,1], gabyage_p = summary$coefficients[4,4], gabyage_se = summary$coefficients[4,2])
})))

gabyage_th$ga_p_adj <- p.adjust(gabyage_th$ga_p, method = "BH")
gabyage_th$gabyage_p_adj <- p.adjust(gabyage_th$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage_th %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage_th %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
gabyage_th$label <- rownames(gabyage_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
gabyage_th_sig_MC <- gabyage_th %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage_th_sig_MC$gabyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage_th
name <- "gabyage_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(gabyage_th_noplot <- gabyage_th_sig_MC[!(gabyage_th_sig_MC$label %in% plot_data_dkt$label) & !(gabyage_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge Cortical Thickness"))

if(save_figs == TRUE){
panel_save(gabyage_dkt_th_plot, "gabyage-dkt-th", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage_th_sig_MC)[1] > 0){
vars <- rownames(gabyage_th_sig_MC[order(-(gabyage_th_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

####  group by age and check ga on thickness effect

##### young

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_young$gestational_age))
# Regional -- including cortical and subcortical
ga_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore_young)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_th_young$ga_p_adj <- p.adjust(ga_th_young$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_th_young %>% filter(ga_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
ga_th_young$label <- rownames(ga_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

ga_th_young_sig_MC <- ga_th_young %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_th_young_sig_MC$ga_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- ga_th_young
name <- "ga_thick_young.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga_th_young_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga_th_young_noplot <- ga_th_young_sig_MC[!(ga_th_young_sig_MC$label %in% plot_data_dkt$label) & !(ga_th_young_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gayoung_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Young, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(gayoung_dkt_th_plot, "ga-young-dkt-th", "pdf", plot_output_folder)
}
```

##### old

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_old$gestational_age))
# Regional -- including cortical and subcortical
ga_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age, data = df.zscore_old)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_th_old$ga_p_adj <- p.adjust(ga_th_old$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_th_old %>% filter(ga_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
ga_th_old$label <- rownames(ga_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

ga_th_old_sig_MC <- ga_th_old %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga_th_old_sig_MC$ga_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- ga_th_old
name <- "ga_thick_old.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga_th_old_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga_th_old_noplot <- ga_th_old_sig_MC[!(ga_th_old_sig_MC$label %in% plot_data_dkt$label) & !(ga_th_old_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gaold_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA Old, Cortical Thickness"))
if(save_figs == TRUE){
panel_save(gaold_dkt_th_plot, "ga-old-dkt-th", "pdf", plot_output_folder)
}
```

## BW

### Volume

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_vol$bw_p_adj <- p.adjust(bw_vol$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_vol %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(bw_vol), perl = TRUE)

bw_vol$label <- rownames(bw_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bw_vol$label[cols_edit] <- gsub("_", "-", bw_vol$label[cols_edit])

bw_vol_sig_MC <- bw_vol %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_vol_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw_vol
name <- "bw_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(bw_vol_noplot <- bw_vol_sig_MC[!(bw_vol_sig_MC$label %in% plot_data_dkt$label) & !(bw_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW Volume"))

(bw_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "BW Volume"))

if(save_figs == TRUE){
panel_save(bw_dkt_vol_plot, "bw-dkt-vol", "pdf", plot_output_folder)
panel_save(bw_aseg_vol_plot , "bw-aseg-vol", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(bw_vol_sig_MC)[1] > 0){
top_n = if(dim(bw_vol_sig_MC)[1] > 10) {10} else {dim(bw_vol_sig_MC)[1]}
top <- bw_vol_sig_MC[order(bw_vol_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw_vol <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw_vol[i]) <- pheno
  scatterplots_bw_vol[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw_vol[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[4,1], bwbyage_p = summary$coefficients[4,4], bwbyage_se = summary$coefficients[4,2])
})))

bwbyage_vol$bw_p_adj <- p.adjust(bwbyage_vol$bw_p, method = "BH")
bwbyage_vol$bwbyage_p_adj <- p.adjust(bwbyage_vol$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage_vol %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage_vol %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage_vol %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(bwbyage_vol), perl = TRUE)

bwbyage_vol$label <- rownames(bwbyage_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bwbyage_vol$label[cols_edit] <- gsub("_", "-", bwbyage_vol$label[cols_edit])

bwbyage_vol_sig_MC <- bwbyage_vol %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage_vol_sig_MC$bwbyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage_vol
name <- "bwbyage_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwbyage_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(bwbyage_vol_noplot <- bwbyage_vol_sig_MC[!(bwbyage_vol_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge Volume"))

(bwbyage_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "BWxAge Interaction Median Volumes All, uncorrected"))

if(save_figs == TRUE){
panel_save(bwbyage_dkt_vol_plot, "bwbyage-dkt-vol", "pdf", plot_output_folder)
panel_save(bwbyage_aseg_vol_plot , "bwbyage-aseg-vol", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage_vol_sig_MC)[1] > 0){
vars <- rownames(bwbyage_vol_sig_MC[order(-(bwbyage_vol_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_GrayVol_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Surface Area

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_sa$bw_p_adj <- p.adjust(bw_sa$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_sa %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bw_sa$label <- rownames(bw_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bw_sa_sig_MC <- bw_sa %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_sa_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw_sa
name <- "bw_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw_sa_noplot <- bw_sa_sig_MC[!(bw_sa_sig_MC$label %in% plot_data_dkt$label) & !(bw_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW Surface Area"))

if(save_figs == TRUE){
panel_save(bw_dkt_sa_plot, "bw-dkt-sa", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(bw_sa_sig_MC)[1] > 0){
top_n = if(dim(bw_sa_sig_MC)[1] > 10) {10} else {dim(bw_sa_sig_MC)[1]}
top <- bw_sa_sig_MC[order(bw_sa_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw_sa[i]) <- pheno
  scatterplots_bw_sa[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw_sa[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[4,1], bwbyage_p = summary$coefficients[4,4], bwbyage_se = summary$coefficients[4,2])
})))

bwbyage_sa$bw_p_adj <- p.adjust(bwbyage_sa$bw_p, method = "BH")
bwbyage_sa$bwbyage_p_adj <- p.adjust(bwbyage_sa$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage_sa %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage_sa %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bwbyage_sa$label <- rownames(bwbyage_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bwbyage_sa_sig_MC <- bwbyage_sa %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage_sa_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage_sa
name <- "bwbyage_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bwbyage_sa_noplot <- bwbyage_sa_sig_MC[!(bwbyage_sa_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, Surface Area"))

if(save_figs == TRUE){
panel_save(bwbyage_dkt_sa_plot, "bwbyage-dkt-sa", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage_sa_sig_MC)[1] > 0){
vars <- rownames(bwbyage_sa_sig_MC[order(-(bwbyage_sa_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_SurfArea_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Thickness

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_th$bw_p_adj <- p.adjust(bw_th$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_th %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bw_th$label <- rownames(bw_th) %>% 
  sub("aparc_ThickAvg_", "", .)

bw_th_sig_MC <- bw_th %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_th_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw_th
name <- "bw_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw_th_noplot <- bw_th_sig_MC[!(bw_th_sig_MC$label %in% plot_data_dkt$label) & !(bw_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bw_dkt_th_plot, "bw-dkt-th", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(bw_th_sig_MC)[1] > 0){
top_n = if(dim(bw_th_sig_MC)[1] > 10) {10} else {dim(bw_th_sig_MC)[1]}
top <- bw_th_sig_MC[order(abs(bw_th_sig_MC$bw_beta), decreasing = TRUE)[1:top_n],]
scatterplots_bw_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_bw_th)[i] <- pheno
  scatterplots_bw_th[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw_th[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[4,1], bwbyage_p = summary$coefficients[4,4], bwbyage_se = summary$coefficients[4,2])
})))

bwbyage_th$bw_p_adj <- p.adjust(bwbyage_th$bw_p, method = "BH")
bwbyage_th$bwbyage_p_adj <- p.adjust(bwbyage_th$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage_th %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage_th %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bwbyage_th$label <- rownames(bwbyage_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
bwbyage_th_sig_MC <- bwbyage_th %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage_th_sig_MC$bwbyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage_th
name <- "bwbyage_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bwbyage_th_noplot <- bwbyage_th_sig_MC[!(bwbyage_th_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bwbyage_dkt_th_plot, "bwbyage-dkt-th", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage_th_sig_MC)[1] > 0){
vars <- rownames(bwbyage_th_sig_MC[order(-(bwbyage_th_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ birth_weight_kg*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = birth_weight_kg, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

####  group by age and check bw on thickness effect

##### young

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_young$birth_weight_kg))
# Regional -- including cortical and subcortical
bw_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore_young)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_th_young$bw_p_adj <- p.adjust(bw_th_young$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_th_young %>% filter(bw_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
bw_th_young$label <- rownames(bw_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

bw_th_young_sig_MC <- bw_th_young %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_th_young_sig_MC$bw_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- bw_th_young
name <- "bw_thick_young.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw_th_young_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw_th_young_noplot <- bw_th_young_sig_MC[!(bw_th_young_sig_MC$label %in% plot_data_dkt$label) & !(bw_th_young_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwyoung_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW Young, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bwyoung_dkt_th_plot, "bw-young-dkt-th", "pdf", plot_output_folder)
}
```

##### old

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_old$birth_weight_kg))
# Regional -- including cortical and subcortical
bw_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg, data = df.zscore_old)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_th_old$bw_p_adj <- p.adjust(bw_th_old$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_th_old %>% filter(bw_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
bw_th_old$label <- rownames(bw_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

bw_th_old_sig_MC <- bw_th_old %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw_th_old_sig_MC$bw_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- bw_th_old
name <- "bw_thick_old.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw_th_old_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw_th_old_noplot <- bw_th_old_sig_MC[!(bw_th_old_sig_MC$label %in% plot_data_dkt$label) & !(bw_th_old_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwold_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW Old, Cortical Thickness"))
if(save_figs == TRUE){
panel_save(bwold_dkt_th_plot, "bw-old-dkt-th", "pdf", plot_output_folder)
}
```

## GA with QC covariate

### Volume

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga.qc_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ gestational_age + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc_vol$ga_p_adj <- p.adjust(ga.qc_vol$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc_vol %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(ga.qc_vol), perl = TRUE)

ga.qc_vol$label <- rownames(ga.qc_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

ga.qc_vol$label[cols_edit] <- gsub("_", "-", ga.qc_vol$label[cols_edit])

ga.qc_vol_sig_MC <- ga.qc_vol %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc_vol_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc_vol
name <- "ga.qc_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga.qc_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(ga.qc_vol_noplot <- ga.qc_vol_sig_MC[!(ga.qc_vol_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, QC covar, Volume"))

(ga.qc_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GA, QC covar, Volume"))

if(save_figs == TRUE){
panel_save(ga.qc_dkt_vol_plot, "ga-qc-dkt-vol", "pdf", plot_output_folder)
panel_save(ga.qc_aseg_vol_plot , "ga-qc-aseg-vol", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if (dim(ga.qc_vol_sig_MC)[1] > 0){
top_n = if(dim(ga.qc_vol_sig_MC)[1] > 10) {10} else {dim(ga.qc_vol_sig_MC)[1]}
top <- ga.qc_vol_sig_MC[order(ga.qc_vol_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga.qc_vol <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga.qc_vol[i]) <- pheno
  scatterplots_ga.qc_vol[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga.qc_vol[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage.qc_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[5,1], gabyage_p = summary$coefficients[5,4], gabyage.qc_se = summary$coefficients[5,2])
})))

gabyage.qc_vol$ga_p_adj <- p.adjust(gabyage.qc_vol$ga_p, method = "BH")
gabyage.qc_vol$gabyage_p_adj <- p.adjust(gabyage.qc_vol$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage.qc_vol %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage.qc_vol %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage.qc_vol %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(gabyage.qc_vol), perl = TRUE)

gabyage.qc_vol$label <- rownames(gabyage.qc_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

gabyage.qc_vol$label[cols_edit] <- gsub("_", "-", gabyage.qc_vol$label[cols_edit])

gabyage.qc_vol_sig_MC <- gabyage.qc_vol %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage.qc_vol_sig_MC$gabyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage.qc_vol
name <- "gabyage.qc_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage.qc_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gabyage.qc_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(gabyage.qc_vol_noplot <- gabyage.qc_vol_sig_MC[!(gabyage.qc_vol_sig_MC$label %in% plot_data_dkt$label) & !(gabyage.qc_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage.qc_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge, QC covar, Volume"))

(gabyage.qc_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GAxAge, QC Covar, Volume"))

if(save_figs == TRUE){
panel_save(gabyage.qc_dkt_vol_plot, "gabyage-qc-dkt-vol", "pdf", plot_output_folder)
panel_save(gabyage.qc_aseg_vol_plot , "gabyage-qc-aseg-vol", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage.qc_vol_sig_MC)[1] > 0){
vars <- rownames(gabyage.qc_vol_sig_MC[order(-(gabyage.qc_vol_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_GrayVol_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Surface Area

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga.qc_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ gestational_age + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc_sa$ga_p_adj <- p.adjust(ga.qc_sa$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc_sa %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc_sa$label <- rownames(ga.qc_sa) %>% 
  sub("aparc_SurfArea_", "", .)

ga.qc_sa_sig_MC <- ga.qc_sa %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc_sa_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc_sa
name <- "ga.qc_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc_sa_noplot <- ga.qc_sa_sig_MC[!(ga.qc_sa_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, QC covar, Surface Area"))

if(save_figs == TRUE){
panel_save(ga.qc_dkt_sa_plot, "ga-qc-dkt-sa", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(ga.qc_sa_sig_MC)[1] > 0) {
top_n = if(dim(ga.qc_sa_sig_MC)[1] > 10) {10} else {dim(ga.qc_sa_sig_MC)[1]}
top <- ga.qc_sa_sig_MC[order(ga.qc_sa_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga.qc_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga.qc_sa[i]) <- pheno
  scatterplots_ga.qc_sa[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga.qc_sa[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage.qc_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[5,1], gabyage_p = summary$coefficients[5,4], gabyage.qc_se = summary$coefficients[5,2])
})))

gabyage.qc_sa$ga_p_adj <- p.adjust(gabyage.qc_sa$ga_p, method = "BH")
gabyage.qc_sa$gabyage_p_adj <- p.adjust(gabyage.qc_sa$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage.qc_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage.qc_sa %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage.qc_sa %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
gabyage.qc_sa$label <- rownames(gabyage.qc_sa) %>% 
  sub("aparc_SurfArea_", "", .)

gabyage.qc_sa_sig_MC <- gabyage.qc_sa %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage.qc_sa_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage.qc_sa
name <- "gabyage.qc_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage.qc_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(gabyage.qc_sa_noplot <- gabyage.qc_sa_sig_MC[!(gabyage.qc_sa_sig_MC$label %in% plot_data_dkt$label) & !(gabyage.qc_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage.qc_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge, QC covar, Surface Area"))

if(save_figs == TRUE){
panel_save(gabyage.qc_dkt_sa_plot, "gabyage-qc-dkt-sa", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage.qc_sa_sig_MC)[1] > 0){
vars <- rownames(gabyage.qc_sa_sig_MC[order(-(gabyage.qc_sa_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_Graysa_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Thickness

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga.qc_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc_th$ga_p_adj <- p.adjust(ga.qc_th$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc_th %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc_th$label <- rownames(ga.qc_th) %>% 
  sub("aparc_ThickAvg_", "", .)

ga.qc_th_sig_MC <- ga.qc_th %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc_th_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc_th
name <- "ga.qc_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc_th_noplot <- ga.qc_th_sig_MC[!(ga.qc_th_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, QC covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(ga.qc_dkt_th_plot, "ga-qc-dkt-th", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(ga.qc_th_sig_MC)[1] > 0){
top_n = if(dim(ga.qc_th_sig_MC)[1] > 10) {10} else {dim(ga.qc_th_sig_MC)[1]}
top <- ga.qc_th_sig_MC[order(abs(ga.qc_th_sig_MC$ga_beta), decreasing = TRUE)[1:top_n],]
scatterplots_ga.qc_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_ga.qc_th)[i] <- pheno
  scatterplots_ga.qc_th[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga.qc_th[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage.qc_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age*age_years + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[5,1], gabyage_p = summary$coefficients[5,4], gabyage.qc_se = summary$coefficients[5,2])
})))

gabyage.qc_th$ga_p_adj <- p.adjust(gabyage.qc_th$ga_p, method = "BH")
gabyage.qc_th$gabyage_p_adj <- p.adjust(gabyage.qc_th$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage.qc_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage.qc_th %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage.qc_th %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
gabyage.qc_th$label <- rownames(gabyage.qc_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
gabyage.qc_th_sig_MC <- gabyage.qc_th %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage.qc_th_sig_MC$gabyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage.qc_th
name <- "gabyage.qc_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage.qc_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(gabyage.qc_th_noplot <- gabyage.qc_th_sig_MC[!(gabyage.qc_th_sig_MC$label %in% plot_data_dkt$label) & !(gabyage.qc_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage.qc_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge, QC covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(gabyage.qc_dkt_th_plot, "gabyage-qc-dkt-th", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if(dim(gabyage.qc_th_sig_MC)[1] > 0) {
vars <- rownames(gabyage.qc_th_sig_MC[order(-(gabyage.qc_th_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

####  group by age and check ga.qc on thickness effect

##### young

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_young$gestational_age))
# Regional -- including cortical and subcortical
ga.qc_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age + qc_var, data = df.zscore_young)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc_th_young$ga_p_adj <- p.adjust(ga.qc_th_young$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc_th_young %>% filter(ga_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc_th_young$label <- rownames(ga.qc_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

ga.qc_th_young_sig_MC <- ga.qc_th_young %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc_th_young_sig_MC$ga_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc_th_young
name <- "ga.qc_thick_young.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc_th_young_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc_th_young_noplot <- ga.qc_th_young_sig_MC[!(ga.qc_th_young_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc_th_young_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qcyoung_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, Young, QC Covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(ga.qcyoung_dkt_th_plot, "ga-young-qc-dkt-th", "pdf", plot_output_folder)
}
```

##### old

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_old$gestational_age))
# Regional -- including cortical and subcortical
ga.qc_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(x ~ gestational_age + qc_var, data = df.zscore_old)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc_th_old$ga_p_adj <- p.adjust(ga.qc_th_old$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc_th_old %>% filter(ga_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc_th_old$label <- rownames(ga.qc_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

ga.qc_th_old_sig_MC <- ga.qc_th_old %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc_th_old_sig_MC$ga_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc_th_old
name <- "ga.qc_thick_old.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc_th_old_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc_th_old_noplot <- ga.qc_th_old_sig_MC[!(ga.qc_th_old_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc_th_old_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qcold_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, Old, QC Covar, Cortical Thickness"))
if(save_figs == TRUE){
panel_save(ga.qcold_dkt_th_plot, "ga-old-qc-dkt-th", "pdf", plot_output_folder)
}
```


## BW with QC covariate

### Volume

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc_vol$bw_p_adj <- p.adjust(bw.qc_vol$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc_vol %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(bw.qc_vol), perl = TRUE)

bw.qc_vol$label <- rownames(bw.qc_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bw.qc_vol$label[cols_edit] <- gsub("_", "-", bw.qc_vol$label[cols_edit])

bw.qc_vol_sig_MC <- bw.qc_vol %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc_vol_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc_vol
name <- "bw.qc_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw.qc_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(bw.qc_vol_noplot <- bw.qc_vol_sig_MC[!(bw.qc_vol_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, QC Covar, Volume"))

(bw.qc_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GA Median Volume All"))

if(save_figs == TRUE){
panel_save(bw.qc_dkt_vol_plot, "bw-qc-dkt-vol", "pdf", plot_output_folder)
panel_save(bw.qc_aseg_vol_plot , "bw-qc-aseg-vol", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(bw.qc_vol_sig_MC)[1] > 0) {
top_n = if(dim(bw.qc_vol_sig_MC)[1] > 10) {10} else {dim(bw.qc_vol_sig_MC)[1]}
top <- bw.qc_vol_sig_MC[order(bw.qc_vol_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw.qc_vol <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw.qc_vol[i]) <- pheno
  scatterplots_bw.qc_vol[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw.qc_vol[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage.qc_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[5,1], bwbyage_p = summary$coefficients[5,4], bwbyage.qc_se = summary$coefficients[5,2])
})))

bwbyage.qc_vol$bw_p_adj <- p.adjust(bwbyage.qc_vol$bw_p, method = "BH")
bwbyage.qc_vol$bwbyage_p_adj <- p.adjust(bwbyage.qc_vol$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage.qc_vol %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage.qc_vol %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage.qc_vol %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(bwbyage.qc_vol), perl = TRUE)

bwbyage.qc_vol$label <- rownames(bwbyage.qc_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bwbyage.qc_vol$label[cols_edit] <- gsub("_", "-", bwbyage.qc_vol$label[cols_edit])

bwbyage.qc_vol_sig_MC <- bwbyage.qc_vol %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage.qc_vol_sig_MC$bwbyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage.qc_vol
name <- "bwbyage.qc_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage.qc_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwbyage.qc_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(bwbyage.qc_vol_noplot <- bwbyage.qc_vol_sig_MC[!(bwbyage.qc_vol_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage.qc_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage.qc_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, QC covar, Volume"))

(bwbyage.qc_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "BWAxAge, QC Covar, Volume"))

if(save_figs == TRUE){
panel_save(bwbyage.qc_dkt_vol_plot, "ga-qcbyage-dkt-vol", "pdf", plot_output_folder)
panel_save(bwbyage.qc_aseg_vol_plot , "ga-qcbyage-aseg-vol", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage.qc_vol_sig_MC)[1] > 0){
vars <- rownames(bwbyage.qc_vol_sig_MC[order(-(bwbyage.qc_vol_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_GrayVol_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Surface Area

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc_sa$bw_p_adj <- p.adjust(bw.qc_sa$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc_sa %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc_sa$label <- rownames(bw.qc_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bw.qc_sa_sig_MC <- bw.qc_sa %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc_sa_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc_sa
name <- "bw.qc_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc_sa_noplot <- bw.qc_sa_sig_MC[!(bw.qc_sa_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, QC covar, Surface Area"))

if(save_figs == TRUE){
panel_save(bw.qc_dkt_sa_plot, "bw-qc-dkt-sa", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(bw.qc_sa_sig_MC)[1] > 0) {
top_n = if(dim(bw.qc_sa_sig_MC)[1] > 10) {10} else {dim(bw.qc_sa_sig_MC)[1]}
top <- bw.qc_sa_sig_MC[order(bw.qc_sa_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw.qc_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw.qc_sa[i]) <- pheno
  scatterplots_bw.qc_sa[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw.qc_sa[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage.qc_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[5,1], bwbyage_p = summary$coefficients[5,4], bwbyage.qc_se = summary$coefficients[5,2])
})))

bwbyage.qc_sa$bw_p_adj <- p.adjust(bwbyage.qc_sa$bw_p, method = "BH")
bwbyage.qc_sa$bwbyage_p_adj <- p.adjust(bwbyage.qc_sa$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage.qc_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage.qc_sa %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage.qc_sa %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bwbyage.qc_sa$label <- rownames(bwbyage.qc_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bwbyage.qc_sa_sig_MC <- bwbyage.qc_sa %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage.qc_sa_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage.qc_sa
name <- "bwbyage.qc_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage.qc_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bwbyage.qc_sa_noplot <- bwbyage.qc_sa_sig_MC[!(bwbyage.qc_sa_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage.qc_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage.qc_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, QC covar, Surface Area"))

if(save_figs == TRUE){
panel_save(bwbyage.qc_dkt_sa_plot, "bwbyage-qc-dkt-sa", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage.qc_sa_sig_MC)[1] > 0){
vars <- rownames(bwbyage.qc_sa_sig_MC[order(-(bwbyage.qc_sa_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_SurfArea_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Thickness

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc_th$bw_p_adj <- p.adjust(bw.qc_th$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc_th %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc_th$label <- rownames(bw.qc_th) %>% 
  sub("aparc_ThickAvg_", "", .)

bw.qc_th_sig_MC <- bw.qc_th %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc_th_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc_th
name <- "bw.qc_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc_th_noplot <- bw.qc_th_sig_MC[!(bw.qc_th_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, QC covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bw.qc_dkt_th_plot, "bw-qc-dkt-th", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(bw.qc_th_sig_MC)[1] > 0) {
top_n = if(dim(bw.qc_th_sig_MC)[1] > 10) {10} else {dim(bw.qc_th_sig_MC)[1]}
top <- bw.qc_th_sig_MC[order(abs(bw.qc_th_sig_MC$bw_beta), decreasing = TRUE)[1:top_n],]
scatterplots_bw.qc_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_bw.qc_th)[i] <- pheno
  scatterplots_bw.qc_th[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw.qc_th[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage.qc_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg*age_years + qc_var, data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[5,1], bwbyage_p = summary$coefficients[5,4], bwbyage.qc_se = summary$coefficients[5,2])
})))

bwbyage.qc_th$bw_p_adj <- p.adjust(bwbyage.qc_th$bw_p, method = "BH")
bwbyage.qc_th$bwbyage_p_adj <- p.adjust(bwbyage.qc_th$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage.qc_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage.qc_th %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage.qc_th %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bwbyage.qc_th$label <- rownames(bwbyage.qc_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
bwbyage.qc_th_sig_MC <- bwbyage.qc_th %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage.qc_th_sig_MC$bwbyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage.qc_th
name <- "bwbyage.qc_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage.qc_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bwbyage.qc_th_noplot <- bwbyage.qc_th_sig_MC[!(bwbyage.qc_th_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage.qc_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage.qc_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, QC covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bwbyage.qc_dkt_th_plot, "bwbyage-qc-dkt-th", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if(dim(bwbyage.qc_th_sig_MC)[1] > 0) {
vars <- rownames(bwbyage.qc_th_sig_MC[order(-(bwbyage.qc_th_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ birth_weight_kg*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = birth_weight_kg, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

####  group by age and check bw.qc on thickness effect

##### young

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_young$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg + qc_var, data = df.zscore_young)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc_th_young$bw_p_adj <- p.adjust(bw.qc_th_young$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc_th_young %>% filter(bw_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc_th_young$label <- rownames(bw.qc_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

bw.qc_th_young_sig_MC <- bw.qc_th_young %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc_th_young_sig_MC$bw_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc_th_young
name <- "bw.qc_thick_young.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc_th_young_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc_th_young_noplot <- bw.qc_th_young_sig_MC[!(bw.qc_th_young_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc_th_young_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qcyoung_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, Young, QC covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bw.qcyoung_dkt_th_plot, "bw-young-qc-dkt-th", "pdf", plot_output_folder)
}
```

##### old

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_old$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(x ~ birth_weight_kg + qc_var, data = df.zscore_old)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc_th_old$bw_p_adj <- p.adjust(bw.qc_th_old$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc_th_old %>% filter(bw_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc_th_old$label <- rownames(bw.qc_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

bw.qc_th_old_sig_MC <- bw.qc_th_old %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc_th_old_sig_MC$bw_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc_th_old
name <- "bw.qc_thick_old.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc_th_old_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc_th_old_noplot <- bw.qc_th_old_sig_MC[!(bw.qc_th_old_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc_th_old_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qcold_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, Old, QC covar, Cortical Thickness"))
if(save_figs == TRUE){
panel_save(bw.qcold_dkt_th_plot, "bw-old-qc-dkt-th", "pdf", plot_output_folder)
}
```

## GA with qc and a global measure covariate

### Volume

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
print(glue("Global measure for volume is {global_measure_vol}"))
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga.qc.global_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "qc_var", global_measure_vol), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc.global_vol$ga_p_adj <- p.adjust(ga.qc.global_vol$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc.global_vol %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(ga.qc.global_vol), perl = TRUE)

ga.qc.global_vol$label <- rownames(ga.qc.global_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

ga.qc.global_vol$label[cols_edit] <- gsub("_", "-", ga.qc.global_vol$label[cols_edit])

ga.qc.global_vol_sig_MC <- ga.qc.global_vol %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc.global_vol_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc.global_vol
name <- "ga.qc.global_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc.global_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga.qc.global_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(ga.qc.global_vol_noplot <- ga.qc.global_vol_sig_MC[!(ga.qc.global_vol_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc.global_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc.global_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, QC and global covar, Volume"))

(ga.qc.global_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GA, QC and global covar, Volume"))

if(save_figs == TRUE){
panel_save(ga.qc.global_dkt_vol_plot, "ga-qc-global-dkt-vol", "pdf", plot_output_folder)
panel_save(ga.qc.global_aseg_vol_plot , "ga-qc-global-aseg-vol", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(ga.qc.global_vol_sig_MC)[1] > 0){
top_n = if(dim(ga.qc.global_vol_sig_MC)[1] > 10) {10} else {dim(ga.qc.global_vol_sig_MC)[1]}
top <- ga.qc.global_vol_sig_MC[order(ga.qc.global_vol_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga.qc.global_vol <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga.qc.global_vol[i]) <- pheno
  scatterplots_ga.qc.global_vol[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga.qc.global_vol[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage.qc.global_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "age_years", "qc_var", global_measure_vol, "gestational_age:age_years"), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[6,1], gabyage_p = summary$coefficients[6,4], gabyage_se = summary$coefficients[6,2])
})))

gabyage.qc.global_vol$ga_p_adj <- p.adjust(gabyage.qc.global_vol$ga_p, method = "BH")
gabyage.qc.global_vol$gabyage_p_adj <- p.adjust(gabyage.qc.global_vol$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage.qc.global_vol %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage.qc.global_vol %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage.qc.global_vol %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(gabyage.qc.global_vol), perl = TRUE)

gabyage.qc.global_vol$label <- rownames(gabyage.qc.global_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

gabyage.qc.global_vol$label[cols_edit] <- gsub("_", "-", gabyage.qc.global_vol$label[cols_edit])

gabyage.qc.global_vol_sig_MC <- gabyage.qc.global_vol %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage.qc.global_vol_sig_MC$gabyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage.qc.global_vol
name <- "gabyage.qc.global_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage.qc.global_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gabyage.qc.global_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(gabyage.qc.global_vol_noplot <- gabyage.qc.global_vol_sig_MC[!(gabyage.qc.global_vol_sig_MC$label %in% plot_data_dkt$label) & !(gabyage.qc.global_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage.qc.global_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge, QC and global covar, Volume"))

(gabyage.qc.global_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "GAxAge, QC and global covar, Volume"))

if(save_figs == TRUE){
panel_save(gabyage.qc.global_dkt_vol_plot, "gabyage-qc-global-dkt-vol", "pdf", plot_output_folder)
panel_save(gabyage.qc.global_aseg_vol_plot , "gabyage-qc-global-aseg-vol", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage.qc_vol_sig_MC)[1] > 0){
vars <- rownames(gabyage.qc_vol_sig_MC[order(-(gabyage.qc_vol_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_GrayVol_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Surface Area

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
print(glue("Global measure for surface area is {global_measure_sa}"))
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga.qc.global_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "qc_var", global_measure_sa), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc.global_sa$ga_p_adj <- p.adjust(ga.qc.global_sa$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc.global_sa %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc.global_sa$label <- rownames(ga.qc.global_sa) %>% 
  sub("aparc_SurfArea_", "", .)

ga.qc.global_sa_sig_MC <- ga.qc.global_sa %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc.global_sa_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc.global_sa
name <- "ga.qc.global_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc.global_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc.global_sa_noplot <- ga.qc.global_sa_sig_MC[!(ga.qc.global_sa_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc.global_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc.global_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, QC and global covar, Surface Area"))

if(save_figs == TRUE){
panel_save(ga.qc.global_dkt_sa_plot, "ga-qc-global-dkt-sa", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(ga.qc.global_sa_sig_MC)[1] > 0){
top_n = if(dim(ga.qc.global_sa_sig_MC)[1] > 10) {10} else {dim(ga.qc.global_sa_sig_MC)[1]}
top <- ga.qc.global_sa_sig_MC[order(ga.qc.global_sa_sig_MC$ga_beta, decreasing = TRUE)[1:top_n],]
scatterplots_ga.qc.global_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_ga.qc.global_sa[i]) <- pheno
  scatterplots_ga.qc.global_sa[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga.qc.global_sa[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage.qc.global_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "age_years", "qc_var", global_measure_sa, "gestational_age:age_years"), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[6,1], gabyage_p = summary$coefficients[6,4], gabyage_se = summary$coefficients[6,2])
})))

gabyage.qc.global_sa$ga_p_adj <- p.adjust(gabyage.qc.global_sa$ga_p, method = "BH")
gabyage.qc.global_sa$gabyage_p_adj <- p.adjust(gabyage.qc.global_sa$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage.qc.global_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage.qc.global_sa %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage.qc.global_sa %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
gabyage.qc.global_sa$label <- rownames(gabyage.qc.global_sa) %>% 
  sub("aparc_SurfArea_", "", .)

gabyage.qc.global_sa_sig_MC <- gabyage.qc.global_sa %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage.qc.global_sa_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage.qc.global_sa
name <- "gabyage.qc.global_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage.qc.global_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(gabyage.qc_sa_noplot <- gabyage.qc.global_sa_sig_MC[!(gabyage.qc.global_sa_sig_MC$label %in% plot_data_dkt$label) & !(gabyage.qc.global_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage.qc_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge, QC and global covar, Surface Area"))

if(save_figs == TRUE){
panel_save(gabyage.qc_dkt_sa_plot, "gabyage-qc-global-dkt-sa", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(gabyage.qc.global_sa_sig_MC)[1] > 0){
vars <- rownames(gabyage.qc.global_sa_sig_MC[order(-(gabyage.qc.global_sa_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_SurfArea_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Thickness

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
print(glue("Global measure for cortical thickness is {global_measure_th}"))
sum(!is.na(df.zscore$gestational_age))
# Regional -- including cortical and subcortical
ga.qc.global_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "qc_var", global_measure_th), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc.global_th$ga_p_adj <- p.adjust(ga.qc.global_th$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc.global_th %>% filter(ga_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc.global_th$label <- rownames(ga.qc.global_th) %>% 
  sub("aparc_ThickAvg_", "", .)

ga.qc.global_th_sig_MC <- ga.qc.global_th %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc.global_th_sig_MC$ga_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc.global_th
name <- "ga.qc.global_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc.global_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc.global_th_noplot <- ga.qc.global_th_sig_MC[!(ga.qc.global_th_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc.global_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc.global_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, QC and global covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(ga.qc.global_dkt_th_plot, "ga-qc-global-dkt-th", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(ga.qc.global_th_sig_MC)[1] > 0) {
top_n = if(dim(ga.qc.global_th_sig_MC)[1] > 10) {10} else {dim(ga.qc.global_th_sig_MC)[1]}
top <- ga.qc.global_th_sig_MC[order(abs(ga.qc.global_th_sig_MC$ga_beta), decreasing = TRUE)[1:top_n],]
scatterplots_ga.qc.global_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_ga.qc.global_th)[i] <- pheno
  scatterplots_ga.qc.global_th[[i]] <- ggplot(df.zscore, aes(x = gestational_age, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_ga.qc.global_th[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
gabyage.qc.global_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "age_years", "qc_var", global_measure_th, "gestational_age:age_years"), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   gabyage_beta = summary$coefficients[6,1], gabyage_p = summary$coefficients[6,4], gabyage_se = summary$coefficients[6,2])
})))

gabyage.qc.global_th$ga_p_adj <- p.adjust(gabyage.qc.global_th$ga_p, method = "BH")
gabyage.qc.global_th$gabyage_p_adj <- p.adjust(gabyage.qc.global_th$gabyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(gabyage.qc.global_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(gabyage.qc.global_th %>% filter(gabyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(gabyage.qc.global_th %>% filter(gabyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
gabyage.qc.global_th$label <- rownames(gabyage.qc.global_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
gabyage.qc.global_th_sig_MC <- gabyage.qc.global_th %>% filter(gabyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(gabyage.qc.global_th_sig_MC$gabyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- gabyage.qc.global_th
name <- "gabyage.qc.global_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(gabyage.qc.global_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(gabyage.qc.global_th_noplot <- gabyage.qc.global_th_sig_MC[!(gabyage.qc.global_th_sig_MC$label %in% plot_data_dkt$label) & !(gabyage.qc.global_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(gabyage.qc.global_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GAxAge, QC and global covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(gabyage.qc.global_dkt_th_plot, "gabyage-qc-global-dkt-th", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if(dim(gabyage.qc.global_th_sig_MC)[1] > 0) {
vars <- rownames(gabyage.qc.global_th_sig_MC[order(-(gabyage.qc.global_th_sig_MC$gabyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ gestational_age*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = gestational_age, modx = age_years) + ylab(y_label) + ggtitle(paste0("gabyage.qc.global beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

####  group by age and check ga.qc.global on thickness effect

##### young

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_young$gestational_age))
# Regional -- including cortical and subcortical
ga.qc.global_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age", "qc_var", global_measure_th), response = "x"), data = df.zscore_young)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc.global_th_young$ga_p_adj <- p.adjust(ga.qc.global_th_young$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc.global_th_young %>% filter(ga_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc.global_th_young$label <- rownames(ga.qc.global_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

ga.qc.global_th_young_sig_MC <- ga.qc.global_th_young %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc.global_th_young_sig_MC$ga_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc.global_th_young
name <- "ga.qc.global_thick_young.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc.global_th_young_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc.global_th_young_noplot <- ga.qc.global_th_young_sig_MC[!(ga.qc.global_th_young_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc.global_th_young_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc.globalyoung_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, Young, QC and global covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(ga.qc.globalyoung_dkt_th_plot, "ga-qc-meanth-young-dkt-th", "pdf", plot_output_folder)
}
```

##### old

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_old$gestational_age))
# Regional -- including cortical and subcortical
ga.qc.global_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("gestational_age","qc_var", global_measure_th), response = "x"), data = df.zscore_old)
  summary <- summary(lm)
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga.qc.global_th_old$ga_p_adj <- p.adjust(ga.qc.global_th_old$ga_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(ga.qc.global_th_old %>% filter(ga_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
ga.qc.global_th_old$label <- rownames(ga.qc.global_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

ga.qc.global_th_old_sig_MC <- ga.qc.global_th_old %>% filter(ga_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(ga.qc.global_th_old_sig_MC$ga_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- ga.qc.global_th_old
name <- "ga.qc.global_thick_old.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(ga.qc.global_th_old_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(ga.qc.global_th_old_noplot <- ga.qc.global_th_old_sig_MC[!(ga.qc.global_th_old_sig_MC$label %in% plot_data_dkt$label) & !(ga.qc.global_th_old_sig_MC$label %in% plot_data_aseg$label),])

# plots
(ga.qc.globalold_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "GA, Old, QC and global covar, Cortical Thickness"))
if(save_figs == TRUE){
panel_save(ga.qc.globalold_dkt_th_plot, "ga-qc-meanth-old-dkt-th", "pdf", plot_output_folder)
}
```

## BW with qc and a global measure covariate

### Volume

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
print(glue("Global measure for volume is {global_measure_vol}"))
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc.global_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "qc_var", global_measure_vol), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc.global_vol$bw_p_adj <- p.adjust(bw.qc.global_vol$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc.global_vol %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(bw.qc.global_vol), perl = TRUE)

bw.qc.global_vol$label <- rownames(bw.qc.global_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bw.qc.global_vol$label[cols_edit] <- gsub("_", "-", bw.qc.global_vol$label[cols_edit])

bw.qc.global_vol_sig_MC <- bw.qc.global_vol %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc.global_vol_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc.global_vol
name <- "bw.qc.global_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc.global_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw.qc.global_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(bw.qc.global_vol_noplot <- bw.qc.global_vol_sig_MC[!(bw.qc.global_vol_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc.global_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc.global_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, QC and global covar, Volume"))

(bw.qc.global_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "BW, QC and global covar, Volume"))

if(save_figs == TRUE){
panel_save(bw.qc.global_dkt_vol_plot, "bw-qc-global-dkt-vol", "pdf", plot_output_folder)
panel_save(bw.qc.global_aseg_vol_plot , "bw-qc-global-aseg-vol", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(bw.qc.global_vol_sig_MC)[1] > 0){
top_n = if(dim(bw.qc.global_vol_sig_MC)[1] > 10) {10} else {dim(bw.qc.global_vol_sig_MC)[1]}
top <- bw.qc.global_vol_sig_MC[order(bw.qc.global_vol_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw.qc.global_vol <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw.qc.global_vol[i]) <- pheno
  scatterplots_bw.qc.global_vol[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw.qc.global_vol[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage.qc.global_vol <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% vol_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "age_years", "qc_var", global_measure_vol, "birth_weight_kg:age_years"), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[6,1], bwbyage_p = summary$coefficients[6,4], bwbyage_se = summary$coefficients[6,2])
})))

bwbyage.qc.global_vol$bw_p_adj <- p.adjust(bwbyage.qc.global_vol$bw_p, method = "BH")
bwbyage.qc.global_vol$bwbyage_p_adj <- p.adjust(bwbyage.qc.global_vol$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage.qc.global_vol %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage.qc.global_vol %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage.qc.global_vol %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
cols_edit <- grepl("aseg(?!_CC)", rownames(bwbyage.qc.global_vol), perl = TRUE)

bwbyage.qc.global_vol$label <- rownames(bwbyage.qc.global_vol) %>% 
  sub("aparc_GrayVol_", "", .) %>% 
  sub("aseg_", "", .) %>%
  sub("X", "x", .) %>%
  sub("Ventricle", "ventricle", .)

bwbyage.qc.global_vol$label[cols_edit] <- gsub("_", "-", bwbyage.qc.global_vol$label[cols_edit])

bwbyage.qc.global_vol_sig_MC <- bwbyage.qc.global_vol %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage.qc.global_vol_sig_MC$bwbyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage.qc.global_vol
name <- "bwbyage.qc.global_volume.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage.qc.global_vol_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwbyage.qc.global_vol_sig_MC, ggseg::aseg, by = "label")

# Regions not matched in atlases
(bwbyage.qc.global_vol_noplot <- bwbyage.qc.global_vol_sig_MC[!(bwbyage.qc.global_vol_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage.qc.global_vol_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage.qc.global_dkt_vol_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, QC and global covar, Volume"))

(bwbyage.qc.global_aseg_vol_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void() +
  labs(title = "BWxAge, QC and global covar, Volume"))

if(save_figs == TRUE){
panel_save(bwbyage.qc.global_dkt_vol_plot, "bwbyage-qc-global-dkt-vol", "pdf", plot_output_folder)
panel_save(bwbyage.qc.global_aseg_vol_plot , "bwbyage-qc-global-aseg-vol", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage.qc_vol_sig_MC)[1] > 0){
vars <- rownames(bwbyage.qc_vol_sig_MC[order(-(bwbyage.qc_vol_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_GrayVol_", "", vars[i])
  y_label <- sub("aseg_", "", vars[i])
  y_label <- sub("X", "", vars[i])
  lm <- lm(x ~ birth_weight_kg*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = birth_weight_kg, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Surface Area

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
print(glue("Global measure for surface area is {global_measure_sa}"))
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc.global_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "qc_var", global_measure_sa), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc.global_sa$bw_p_adj <- p.adjust(bw.qc.global_sa$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc.global_sa %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc.global_sa$label <- rownames(bw.qc.global_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bw.qc.global_sa_sig_MC <- bw.qc.global_sa %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc.global_sa_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc.global_sa
name <- "bw.qc.global_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc.global_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc.global_sa_noplot <- bw.qc.global_sa_sig_MC[!(bw.qc.global_sa_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc.global_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc.global_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, QC and global covar, Surface Area"))

if(save_figs == TRUE){
panel_save(bw.qc.global_dkt_sa_plot, "bw-qc-global-dkt-sa", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(bw.qc.global_sa_sig_MC)[1] > 0){
top_n = if(dim(bw.qc.global_sa_sig_MC)[1] > 10) {10} else {dim(bw.qc.global_sa_sig_MC)[1]}
top <- bw.qc.global_sa_sig_MC[order(bw.qc.global_sa_sig_MC$bw_beta, decreasing = TRUE)[1:top_n],]
scatterplots_bw.qc.global_sa <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  pheno <- rownames(top)[i]
  title <- top$label[i]
  names(scatterplots_bw.qc.global_sa[i]) <- pheno
  scatterplots_bw.qc.global_sa[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw.qc.global_sa[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage.qc.global_sa <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% sa_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "age_years", "qc_var", global_measure_sa, "birth_weight_kg:age_years"), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[6,1], bwbyage_p = summary$coefficients[6,4], bwbyage_se = summary$coefficients[6,2])
})))

bwbyage.qc.global_sa$bw_p_adj <- p.adjust(bwbyage.qc.global_sa$bw_p, method = "BH")
bwbyage.qc.global_sa$bwbyage_p_adj <- p.adjust(bwbyage.qc.global_sa$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage.qc.global_sa %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage.qc.global_sa %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage.qc.global_sa %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bwbyage.qc.global_sa$label <- rownames(bwbyage.qc.global_sa) %>% 
  sub("aparc_SurfArea_", "", .)

bwbyage.qc.global_sa_sig_MC <- bwbyage.qc.global_sa %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage.qc.global_sa_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage.qc.global_sa
name <- "bwbyage.qc.global_surfArea.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage.qc.global_sa_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bwbyage.qc_sa_noplot <- bwbyage.qc.global_sa_sig_MC[!(bwbyage.qc.global_sa_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage.qc.global_sa_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage.qc_dkt_sa_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, QC and global covar, Surface Area"))

if(save_figs == TRUE){
panel_save(bwbyage.qc_dkt_sa_plot, "bwbyage-qc-global-dkt-sa", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if (dim(bwbyage.qc.global_sa_sig_MC)[1] > 0){
vars <- rownames(bwbyage.qc.global_sa_sig_MC[order(-(bwbyage.qc.global_sa_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_SurfArea_", "", vars[i])
  lm <- lm(x ~ birth_weight_kg*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = birth_weight_kg, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage.qc beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

### Thickness

####  simple linear regressions

##### compute regressions
```{r, echo = FALSE}
print(glue("Global measure for cortical thickness is {global_measure_th}"))
sum(!is.na(df.zscore$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc.global_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "qc_var", global_measure_th), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc.global_th$bw_p_adj <- p.adjust(bw.qc.global_th$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc.global_th %>% filter(bw_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc.global_th$label <- rownames(bw.qc.global_th) %>% 
  sub("aparc_ThickAvg_", "", .)

bw.qc.global_th_sig_MC <- bw.qc.global_th %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc.global_th_sig_MC$bw_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc.global_th
name <- "bw.qc.global_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc.global_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc.global_th_noplot <- bw.qc.global_th_sig_MC[!(bw.qc.global_th_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc.global_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc.global_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, QC and global covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bw.qc.global_dkt_th_plot, "bw-qc-global-dkt-th", "pdf", plot_output_folder)
}
```

##### Scatterplot for top betas
```{r, echo = FALSE}
if(dim(bw.qc.global_th_sig_MC)[1] > 0) {
top_n = if(dim(bw.qc.global_th_sig_MC)[1] > 10) {10} else {dim(bw.qc.global_th_sig_MC)[1]}
top <- bw.qc.global_th_sig_MC[order(abs(bw.qc.global_th_sig_MC$bw_beta), decreasing = TRUE)[1:top_n],]
scatterplots_bw.qc.global_th <- vector(mode = "list", length = top_n)
for(i in 1:top_n){
  print(i)
  pheno <- rownames(top)[i]
  print(pheno)
  title <- top$label[i]
  names(scatterplots_bw.qc.global_th)[i] <- pheno
  scatterplots_bw.qc.global_th[[i]] <- ggplot(df.zscore, aes(x = birth_weight_kg, y = !!sym(pheno))) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_minimal() +
    labs(x = "Gestational Age (z-scored)", y = "Centile (z-scored)", title = title)
}

nCol <- 2
nRow <- 2
breaks <- c(seq(from = 0, to = top_n , by = (nCol*nRow)), top_n) %>% unique(.)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(scatterplots_bw.qc.global_th[start:end], ncol=nCol))
}
}
```

####  lm with age interaction

##### compute regressions
```{r, echo = FALSE}
# Regional -- including cortical and subcortical
bwbyage.qc.global_th <- as.data.frame(t(sapply(df.zscore[, which(names(df.zscore) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "age_years", "qc_var", global_measure_th, "birth_weight_kg:age_years"), response = "x"), data = df.zscore)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
   age_beta = summary$coefficients[3,1], age_p = summary$coefficients[3,4], age_se = summary$coefficients[3,2],
   bwbyage_beta = summary$coefficients[6,1], bwbyage_p = summary$coefficients[6,4], bwbyage_se = summary$coefficients[6,2])
})))

bwbyage.qc.global_th$bw_p_adj <- p.adjust(bwbyage.qc.global_th$bw_p, method = "BH")
bwbyage.qc.global_th$bwbyage_p_adj <- p.adjust(bwbyage.qc.global_th$bwbyage_p, method = "BH")

print(paste0("Age Main significant results (shouldn't be any): ", dim(bwbyage.qc.global_th %>% filter(age_p < 0.05))[1]))
print(paste0("Number of significant IDPs - NO correction: ", dim(bwbyage.qc.global_th %>% filter(bwbyage_p < 0.05))[1]))
print(paste0("Number of significant IDPs - AFTER FDR correction: ", dim(bwbyage.qc.global_th %>% filter(bwbyage_p_adj < 0.05))[1]))
```

##### add label column to match to ggseg
```{r, echo = FALSE}
bwbyage.qc.global_th$label <- rownames(bwbyage.qc.global_th) %>% 
  sub("aparc_ThickAvg_", "", .)
  
bwbyage.qc.global_th_sig_MC <- bwbyage.qc.global_th %>% filter(bwbyage_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bwbyage.qc.global_th_sig_MC$bwbyage_beta)))
```

##### save betas
```{r, echo = FALSE}
save_table_full <- bwbyage.qc.global_th
name <- "bwbyage.qc.global_thick.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

##### visualize interaction betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bwbyage.qc.global_th_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bwbyage.qc.global_th_noplot <- bwbyage.qc.global_th_sig_MC[!(bwbyage.qc.global_th_sig_MC$label %in% plot_data_dkt$label) & !(bwbyage.qc.global_th_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bwbyage.qc.global_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwbyage_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BWxAge, QC and global covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bwbyage.qc.global_dkt_th_plot, "bwbyage-qc-global-dkt-th", "pdf", plot_output_folder)
}
```

##### visualize interaction plots
```{r, echo = FALSE}
if(dim(bwbyage.qc.global_th_sig_MC)[1] > 0) {
vars <- rownames(bwbyage.qc.global_th_sig_MC[order(-(bwbyage.qc.global_th_sig_MC$bwbyage_beta)),])
interaction_plots <-  vector(mode = "list", length = length(vars))
if (length(vars) > 0) {
for (i in 1:length(vars)){
  x <- df.zscore[,grepl(vars[i], names(df.zscore))]
  y_label <- sub("aparc_ThickAvg_", "", vars[i])
  lm <- lm(x ~ birth_weight_kg*age_years, df.zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = birth_weight_kg, modx = age_years) + ylab(y_label) + ggtitle(paste0("bwbyage.qc.global beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}
interaction_plots
}
}
```

####  group by age and check bw.qc.global on thickness effect

##### young

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_young$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc.global_th_young <- as.data.frame(t(sapply(df.zscore_young[, which(names(df.zscore_young) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "qc_var", global_measure_th), response = "x"), data = df.zscore_young)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc.global_th_young$bw_p_adj <- p.adjust(bw.qc.global_th_young$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc.global_th_young %>% filter(bw_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc.global_th_young$label <- rownames(bw.qc.global_th_young) %>% 
  sub("aparc_ThickAvg_", "", .)

bw.qc.global_th_young_sig_MC <- bw.qc.global_th_young %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc.global_th_young_sig_MC$bw_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc.global_th_young
name <- "bw.qc.global_thick_young.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc.global_th_young_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc.global_th_young_noplot <- bw.qc.global_th_young_sig_MC[!(bw.qc.global_th_young_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc.global_th_young_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc.globalyoung_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, Young, QC and global covar, Cortical Thickness"))

if(save_figs == TRUE){
panel_save(bw.qc.globalyoung_dkt_th_plot, "bw-qc-meanth-young-dkt-th", "pdf", plot_output_folder)
}
```

##### old

###### compute regressions
```{r, echo = FALSE}
sum(!is.na(df.zscore_old$birth_weight_kg))
# Regional -- including cortical and subcortical
bw.qc.global_th_old <- as.data.frame(t(sapply(df.zscore_old[, which(names(df.zscore_old) %in% th_vars)], function(x) {
  lm <- lm(reformulate(c("birth_weight_kg", "qc_var", global_measure_th), response = "x"), data = df.zscore_old)
  summary <- summary(lm)
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw.qc.global_th_old$bw_p_adj <- p.adjust(bw.qc.global_th_old$bw_p, method = "BH")
print(paste0("Number of significant IDPs after FDR correction: ", dim(bw.qc.global_th_old %>% filter(bw_p_adj < 0.05))[1]))
```

###### add label column to match to ggseg
```{r, echo = FALSE}
bw.qc.global_th_old$label <- rownames(bw.qc.global_th_old) %>% 
  sub("aparc_ThickAvg_", "", .)

bw.qc.global_th_old_sig_MC <- bw.qc.global_th_old %>% filter(bw_p_adj < 0.05)

print(paste0("Beta range of significant IDPs: ", range(bw.qc.global_th_old_sig_MC$bw_beta)))
```

###### save betas
```{r, echo = FALSE}
save_table_full <- bw.qc.global_th_old
name <- "bw.qc.global_thick_old.csv"
# Save dkt cortical betas for spin test
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, name)
  write.csv(save_table_full, filename_all)
}
# Save full betas
if(save_tables == TRUE){
output_folder <- betas_folder
filename <- paste0(output_folder, name)
write.csv(save_table_full, filename)
}
```

###### visualization of betas on surface maps
```{r, echo = FALSE}
# merge with atlas data
plot_data_dkt <- merge(bw.qc.global_th_old_sig_MC, ggseg::dk, by = "label")

# Regions not matched in atlases
(bw.qc.global_th_old_noplot <- bw.qc.global_th_old_sig_MC[!(bw.qc.global_th_old_sig_MC$label %in% plot_data_dkt$label) & !(bw.qc.global_th_old_sig_MC$label %in% plot_data_aseg$label),])

# plots
(bw.qc.globalold_dkt_th_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = low_color, mid = mid_color, high = high_color, limits = limits) +
  theme_void()+
  labs(title = "BW, Old, QC and global covar, Cortical Thickness"))
if(save_figs == TRUE){
panel_save(bw.qc.globalold_dkt_th_plot, "bw-qc-meanth-old-dkt-th", "pdf", plot_output_folder)
}
```

# Save scale images

## beta scale
```{r, echo = FALSE}
#  Create dummy data just to generate the colorbar
df <- data.frame(x = 1, y = 1, beta = 0)

beta_scale_hor <- ggplot(df, aes(x, y, fill = beta)) +
  geom_tile() +
  scale_fill_gradient2(
    low = low_color,
    mid = mid_color,
    high = high_color,
    midpoint = 0,
    limits = limits,
    guide = guide_colorbar(
      barwidth = 20,   #  length of colorbar
      barheight = 1    #  thickness
    )
  ) +
  theme_void() +  #  remove axes, grid, etc.
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )

beta_scale_vert <- ggplot(df, aes(x, y, fill = beta)) +
  geom_tile() +
  scale_fill_gradient2(
    low = low_color,
    mid = mid_color,
    high = high_color,
    midpoint = 0,
    limits = limits,
    guide = guide_colorbar(
      barwidth = 1,   #  length of colorbar
      barheight = 20    #  thickness
    )
  ) +
  theme_void() +  #  remove axes, grid, etc.
  theme(
    legend.position = "right",
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )
beta_scale_hor
beta_scale_vert
if(save_figs == TRUE){
panel_save(beta_scale_hor, "beta-scale-hor", "pdf", plot_output_folder)
  panel_save(beta_scale_vert, "beta-scale-vert", "pdf", plot_output_folder)
}
```