---
title: "vars-interest-distributions"
author: "Eren Kafadar"
date: "2025-11-18"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Controls
```{r}
#set command
save_tables <- TRUE
plot <- TRUE
save_figs <- TRUE
set.seed(42)
```
#Define Paths
```{r}
#set folder paths
code_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/"
vars_path <-  "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/vars/"
centiles_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/data_clean/"

#raw data paths
data_path <- "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/OUT/eren/"
gamlss_data_path <- "/mnt/isilon/bgdlab_processing/braincharts/SLIP/2025_03/code/gamlss/RDS/mpr/DATA.rds"
#processed data path
distinct_centiles_data_path <- paste0(centiles_path,"centiles_distinct_2026-01-29.csv")
all_centiles_data_path <- paste0(centiles_path,"centiles_all_2026-01-29.csv")
#output folder
save_path <- "/mnt/isilon/bgdlab_processing/Eren/slip_premie_wip/output/median-distinct-allgrades-25.11/"

## output subfolder paths
csv_save_path <-  paste0(save_path, "results_csv/")
plot_save_path <- paste0(save_path, "plots/distribution_plots/")
if (!dir.exists(plot_save_path)) dir.create(plot_save_path)
```
#Load custom functions
```{r}
panel_save <- function(plot, filename, extension, folder){
  save_name <- paste0(folder, filename, ".", extension)
  ggsave(save_name, plot = plot, dpi = 300)
}
```
#Load Packages
```{r, echo = FALSE}
#Load libraries
require(dplyr)
require(magrittr)
require(readr)
require(stringr)
require(tidyr)
require(gamlssTools) #Margaret's package
require(tibble)
#For figures/plotting
require(ggplot2)
require(gridExtra)
require(ggsegDKT)
require(ggseg)
#require(ggpubr)
require(ggcorrplot)
require(cowplot)
require(egg)
require(interactions)
require(growthstandards)
require(gtsummary)
require(svglite)
```
#Plots specifications
```{r}
limits = c(-0.3, 0.3)
low_color = "#4878CF"
mid_color = "white"
high_color = "#D65F5F"
```
#Read in data files
```{r, echo = FALSE}
all_vars <- read.csv(paste0(vars_path,"all_vars.csv")) %>% pull(x)
global_vars <- read.csv(paste0(vars_path,"global_vars.csv")) %>% pull(x)
vol_vars <- read.csv(paste0(vars_path,"vol_vars.csv")) %>% pull(x)
sa_vars <- read.csv(paste0(vars_path,"sa_vars.csv")) %>% pull(x)
th_vars <- read.csv(paste0(vars_path,"th_vars.csv")) %>% pull(x)

cent_distinct <- read.csv(distinct_centiles_data_path) %>% select(-("X"))
cent_all <- read.csv(all_centiles_data_path) %>% select(-("X"))

gamlss_data <- readRDS(gamlss_data_path)
```
#Numbers for gamlss model data file, for sanity check
```{r}
gamlss_data_inc <- gamlss_data %>% filter(INDEX.OB == 1)
length(unique(gamlss_data_inc$participant_id))
range(gamlss_data_inc$age_days/365)
```
#Age Distribution - preliminary, before restricting to < 21
```{r}
hist(cent_distinct$age_years)
range(cent_distinct$age_years)#0.97, 35.8
```
#Age Distribution - Remove Age > 21
```{r}
sum(cent_distinct$adjusted_age_years > 21)
sum(cent_all$adjusted_age_years > 21)
#GA/BW Numbers before removing > 21
sum(!is.na(cent_distinct$birth_weight_kg))
sum(!is.na(cent_distinct$gestational_age))
sum(!is.na(cent_distinct$birth_weight_kg) & !is.na(cent_distinct$gestational_age))

#cent_distinct <- cent_distinct %>% filter(adjusted_age_years <= 21)
#cent_all <- cent_all %>% filter(adjusted_age_years <= 21)

#GA/BW Numbers after removing > 21
sum(!is.na(cent_distinct$birth_weight_kg))
sum(!is.na(cent_distinct$gestational_age))
sum(!is.na(cent_distinct$birth_weight_kg) & !is.na(cent_distinct$gestational_age))

#Age Distribution Stats
range(cent_distinct$adjusted_age_years)
IQR(cent_distinct$adjusted_age_years)
quartiles <- quantile(cent_distinct$adjusted_age_years, probs = c(0.25, 0.75))
quartiles[1]
quartiles[2]  
median(cent_distinct$adjusted_age_years)
```
#Age Distribution - for young/old split
```{r}
cent_distinct_young <- cent_distinct %>% filter(age_years < mean(cent_distinct$adjusted_age_years))
cent_distinct_old <- cent_distinct %>% filter(age_years > mean(cent_distinct$adjusted_age_years))

#Age Distribution Stats Young
range(cent_distinct_young$adjusted_age_years)
IQR(cent_distinct_young$adjusted_age_years)
median(cent_distinct_young$adjusted_age_years)

#Age Distribution Stats Young - with BW
range(cent_distinct_young[which(!is.na(cent_distinct_young$birth_weight_kg)),]$adjusted_age_years)
IQR(cent_distinct_young[which(!is.na(cent_distinct_young$birth_weight_kg)),]$adjusted_age_years)
median(cent_distinct_young[which(!is.na(cent_distinct_young$birth_weight_kg)),]$adjusted_age_years)

#Age Distribution Stats Young - with GA
range(cent_distinct_young[which(!is.na(cent_distinct_young$gestational_age)),]$adjusted_age_years)
IQR(cent_distinct_young[which(!is.na(cent_distinct_young$gestational_age)),]$adjusted_age_years)
median(cent_distinct_young[which(!is.na(cent_distinct_young$gestational_age)),]$adjusted_age_years)

#Age Distribution Stats old
range(cent_distinct_old$adjusted_age_years)
IQR(cent_distinct_old$adjusted_age_years)
median(cent_distinct_old$adjusted_age_years)

#Age Distribution Stats old - with BW
range(cent_distinct_old[which(!is.na(cent_distinct_old$birth_weight_kg)),]$adjusted_age_years)
IQR(cent_distinct_old[which(!is.na(cent_distinct_old$birth_weight_kg)),]$adjusted_age_years)
median(cent_distinct_old[which(!is.na(cent_distinct_old$birth_weight_kg)),]$adjusted_age_years)

#Age Distribution Stats old - with GA
range(cent_distinct_old[which(!is.na(cent_distinct_old$gestational_age)),]$adjusted_age_years)
IQR(cent_distinct_old[which(!is.na(cent_distinct_old$gestational_age)),]$adjusted_age_years)
median(cent_distinct_old[which(!is.na(cent_distinct_old$gestational_age)),]$adjusted_age_years)
```
#Variable: Sex
```{r}
prop.table(table(cent_distinct$sex))
prop.table(table(cent_distinct[which(!is.na(cent_distinct$gestational_age)),]$sex))
prop.table(table(cent_distinct[which(!is.na(cent_distinct$birth_weight_kg)),]$sex))
prop.table(table(cent_distinct[which(!is.na(cent_distinct$birth_weight_kg) & !is.na(cent_distinct$gestational_age)),]$sex))
```
#Variable: Age
```{r}
#Whole sample (one session per participant)
N_all <- sum(!is.na(cent_distinct$adjusted_age_years))
N_ga <- sum(!is.na(cent_distinct$gestational_age))
N_bw <- sum(!is.na(cent_distinct$birth_weight_kg))
N_ga_only <- sum(!is.na(cent_distinct$gestational_age) & is.na(cent_distinct$birth_weight_kg))
N_bw_only <- sum(!is.na(cent_distinct$birth_weight_kg) & is.na(cent_distinct$gestational_age))
N_gabw <- sum(!is.na(cent_distinct$gestational_age) & !is.na(cent_distinct$birth_weight_kg))
N_none <- sum(is.na(cent_distinct$gestational_age) & is.na(cent_distinct$birth_weight_kg))


(age_dist_all_plot <- ggplot(cent_distinct, aes(x = adjusted_age_years)) +
  geom_histogram(binwidth = 0.1, fill = "#B3B3B3", color = "white", linewidth = 0.1) +
  labs(
    x = paste0("Adjusted Age (years),  N = ", N_all),
    y = NULL,
    title = "All Participants for Growth Charts"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5)
  ))


if(save_figs == TRUE){
panel_save(age_dist_all_plot, "age-dist-all", "pdf", plot_save_path)
}

df_age <- cent_distinct %>%
  mutate(
    ga_known  = !is.na(gestational_age),
    bw_known  = !is.na(birth_weight_kg),
    group = case_when(
      ga_known & bw_known ~ "GA & BW Known",
      ga_known & !bw_known ~ "Only GA Known",
      bw_known & !ga_known ~ "Only BW Known",
      TRUE ~ "None"
    )) %>%
  mutate(group = factor(group, levels = c(
    "Only GA Known",
    "Only BW Known",
    "GA & BW Known",
    "None"
  )))

(age_dist_gabw_plot <- ggplot(df_age, aes(x = adjusted_age_years, fill = group)) +
  geom_histogram(binwidth = 0.1, color = "white", linewidth = 0.1) +
  scale_fill_manual(
    values = c(
      "Only GA Known" = "#9EC3D2",
      "Only BW Known" = "#D6B8A8",
      "GA & BW Known" = "#6A5A78",
      "None" = "#E0E0E0"
    ),
    labels = c(
      paste0("Only GA Known, N=", N_ga_only),
      paste0("Only BW Known, N=", N_bw_only),
      paste0("GA & BW Known, N=", N_gabw),
      paste0("Neither Known, N=", N_none)
    ),name = NULL) +
  labs(
    x = paste0("Adjusted Age (years),  N = ", N_all),
    y = NULL
  ) +
  theme_minimal(base_size = 16) +
theme(
  legend.position = "bottom",
  legend.direction = "horizontal",
  legend.box = "horizontal",
  legend.text = element_text(size = 14),
  legend.key.width = unit(1.5, "cm"),
  legend.box.just = "center",
  panel.grid = element_blank()
) +
guides(fill = guide_legend(nrow = 2)))

if(save_figs == TRUE){
panel_save(age_dist_gabw_plot, "age-dist-gabw_all", "pdf", plot_save_path)
}

#GA available
N_age_ga <- sum(!is.na(cent_distinct$gestational_age))

(age_dist_ga_plot <- ggplot(cent_distinct %>% filter(!is.na(gestational_age)), aes(x = adjusted_age_years)) +
  geom_histogram(binwidth = 0.1, fill = "#9EC3D2", color = "white", linewidth = 0.1) +
  labs(
    x = paste0("Adjusted Age (years),  N = ", N_age_ga),
    y = NULL,
    title = "Gestational Age Known"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5)
  ))

if(save_figs == TRUE){
panel_save(age_dist_ga_plot, "age-dist-ga", "pdf", plot_save_path)
}

#BW available
N_age_bw <- sum(!is.na(cent_distinct$birth_weight_kg))

(age_dist_bw_plot <- ggplot(cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = adjusted_age_years)) +
  geom_histogram(binwidth = 0.1, fill = "#D6B8A8", color = "white", linewidth = 0.1) +
  labs(
    x = paste0("Adjusted Age (years),  N = ", N_age_bw),
    y = NULL,
    title = "Birthweight Known"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5)
  ))

if(save_figs == TRUE){
panel_save(age_dist_bw_plot, "age-dist-bw", "pdf", plot_save_path)
}
```
#Variable: Gestational Age
```{r}
table(cent_distinct$preterm)

ga_ptb <- cent_distinct %>%
  filter(!is.na(gestational_age)) %>%
  mutate(group = ifelse(gestational_age < 37, "Preterm", "Term"))

pct_preterm <- round(mean(ga_ptb$group == "Preterm") * 100, 1)

(ga_preterm_dist_plot <- ggplot(ga_ptb, aes(x = gestational_age, fill = group)) +
  geom_histogram(binwidth = 0.5, color = "white") +
  scale_fill_manual(values = c("Preterm" = "#F4A475", "Term" = "#A7D9A0")) +
  labs(
    x = paste0("Gestational Age(weeks),  % Preterm(<37wks) = ", pct_preterm),
    y = NULL
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none"
  ))

if(save_figs == TRUE){
panel_save(ga_preterm_dist_plot, "ga-preterm-dist-plot", "pdf", plot_save_path)
}

cent_distinct <- cent_distinct %>%
  mutate(preterm = factor(preterm, levels = c("VPM", "LPM", "Term")))

(ga_preterm_age_plot <- ggplot(cent_distinct %>% filter(!is.na(preterm)), aes(x = adjusted_age_years, fill = preterm)) +
  geom_histogram(position = "fill", binwidth = 0.25, color = "white") +
  scale_fill_manual(
    values = c(
      "VPM"  = "#E8A0A8",
      "LPM"  = "#A8C4E8",
      "Term" = "#A7D9A0"
    )
  ) +
  labs(
    x = "Adjusted Age (years)",
    y = "Proportion",
    fill = "Preterm Status"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.direction = "horizontal"
  ))

if(save_figs == TRUE){
panel_save(ga_preterm_age_plot, "ga-preterm-byage-plot", "pdf", plot_save_path)
}
```
#Variable: Birthweight
```{r}
cent_distinct$bw_category <- as.factor(cut(cent_distinct$birth_weight_kg, breaks = c(-Inf, 1.5, 2.5, Inf), labels = c("VLBW", "LBW", "Normal BW"), include.lowest = TRUE))

bw_low <- cent_distinct %>%
  filter(!is.na(birth_weight_kg)) %>%
  mutate(group = ifelse(birth_weight_kg < 2.5, "Low BW", "Normal BW"))

pct_lowbw <- round(mean(bw_low$group == "Low BW") * 100, 1)

(bw_low_dist_plot <- ggplot(bw_low, aes(x = birth_weight_kg, fill = group)) +
    geom_histogram(
    binwidth = 0.1,
    boundary = 0,
    color = "white"
  ) +
  scale_fill_manual(values = c("Low BW" = "#C76E6A", "Normal BW" = "#7FAF8A")) +
  labs(
    x = paste0("Birthweight(kg),  % Low(<2.5kg) = ", pct_lowbw),
    y = NULL
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none"
  ))

if(save_figs == TRUE){
panel_save(bw_low_dist_plot, "bw-low-dist-plot", "pdf", plot_save_path)
}

(bw_low_age_plot <- ggplot(cent_distinct %>% filter(!is.na(bw_category)), aes(x = adjusted_age_years, fill = bw_category)) +
  geom_histogram(position = "fill", binwidth = 0.25, color = "white") +
  scale_fill_manual(
    values = c(
      "VLBW"  = "#B9836A",
      "LBW"  = "#6A8F9F",
      "Normal BW" = "#7FAF8A"
    )
  ) +
  labs(
    x = "Adjusted Age (years)",
    y = "Proportion",
    fill = "Birthweight"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.direction = "horizontal"
  ))

if(save_figs == TRUE){
panel_save(bw_low_age_plot, "bw-low-byage-plot", "pdf", plot_save_path)
}

cent_distinct$age_group <- cut(cent_distinct$adjusted_age_years, breaks = 80, include.lowest = TRUE, labels = FALSE)

cent_distinct <- cent_distinct %>%
  group_by(age_group) %>%
  arrange(birth_weight_kg, .by_group = TRUE) %>%
  ungroup()

#for x axis labeling
age_labels <- c(0, 5, 10, 15, 20)
group_width <- (max(cent_distinct$adjusted_age_years) - min(cent_distinct$adjusted_age_years)) / 80
x_breaks <- floor((age_labels - min(cent_distinct$adjusted_age_years)) / group_width) + 1
#fix position of 0
x_breaks[1] <- 1

(bw_cont_age_plot <- ggplot(cent_distinct %>% filter(!is.na(birth_weight_kg)), aes(x = age_group, y = 1, fill = birth_weight_kg)) + geom_bar(stat = "identity", width = 0.8) +
    scale_fill_gradient2(low = "#F2EAD3", mid = "#E6E2C8", high = "#7FAF8A", limits = range(cent_distinct$birth_weight_kg, na.rm = TRUE)) +
  labs(
    x = "Adjusted Age (years)",
    y = NULL,
    fill = "Birthweight"
  ) +
  scale_x_continuous(
      breaks = x_breaks,
      labels = age_labels
    ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.title = element_text(margin = margin(r = 10))
  ) +
  guides(fill = guide_colorbar(
    barwidth = 10,
    barheight = 1,
    title.position = "left",
    title.vjust = 1
  )))

if(save_figs == TRUE){
panel_save(bw_cont_age_plot, "bw-cont-byage-plot", "pdf", plot_save_path)
}
```
#Variable: Birthweight Percentile
```{r}
if(!("age_group" %in% names(cent_distinct))){
cent_distinct$age_group <- cut(cent_distinct$adjusted_age_years, breaks = 80, include.lowest = TRUE, labels = FALSE)
}

cent_distinct <- cent_distinct %>%
  group_by(age_group) %>%
  arrange(bweight_percentile, .by_group = TRUE) %>%
  ungroup()

#for x axis labeling
age_labels <- c(0, 5, 10, 15, 20)
group_width <- (max(cent_distinct$adjusted_age_years) - min(cent_distinct$adjusted_age_years)) / 80
x_breaks <- floor((age_labels - min(cent_distinct$adjusted_age_years)) / group_width) + 1
#fix position of 0
x_breaks[1] <- 1

(bwp_cont_age_plot <- ggplot(cent_distinct %>% filter(!is.na(bweight_percentile)), aes(x = age_group, y = 1, fill = bweight_percentile)) + geom_bar(stat = "identity", width = 0.8) +
    scale_fill_gradient2(low = "#F2EAD3", mid = "#E6E2C8", high = "#7FAF8A", limits = c(0,1)) +
  labs(
    x = "Adjusted Age (years)",
    y = NULL,
    fill = "Birthweight Percentile"
  ) +
  scale_x_continuous(
      breaks = x_breaks,
      labels = age_labels
    ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.title = element_text(margin = margin(r = 10))
  ) +
  guides(fill = guide_colorbar(
    barwidth = 10,
    barheight = 1,
    title.position = "left",
    title.vjust = 1
  )))

if(save_figs == TRUE){
panel_save(bwp_cont_age_plot, "bwp-cont-byage-plot", "pdf", plot_save_path)
}
```
#Ages of repeat measurements -- this data frame is no longer created/read into this script
```{r}
# length(unique(repeat_median_cent$participant_id))
# repeat_median_cent$age_years <- repeat_median_cent$age_days/365
# ggplot(repeat_median_cent, aes(x = age_years, y = global_MeanThickness, group = participant_id, color = participant_id)) + 
#   geom_point() +
#   geom_line() +
#   theme_minimal() +
#   theme(legend.position = "none")
# 
# length(unique(repeat_median2_cent$participant_id))
# repeat_median2_cent$age_years <- repeat_median2_cent$age_days/365
# ggplot(repeat_median2_cent %>% filter(!is.na(gestational_age)), aes(x = age_years, y = global_MeanThickness, group = participant_id, color = gestational_age)) + 
#   geom_point() +
#   geom_line() +
#   theme_minimal()
```
